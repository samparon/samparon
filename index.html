<!--
//====================================================================\\
||                                                                    ||
||   CARDÁPIO SHEETS - V3.6 - 22/07/2025 - 23h25                   ||
||                                                                    ||
||    Desenvolvido com ❤️ por Dante Testa                             ||
||    www.dantetesta.com.br | WhatsApp: (19) 99802-9156              ||
||                                                                    ||
||    [!] AVISO IMPORTANTE                                           ||
||    Este código é propriedade intelectual de Dante Testa.          ||
||    Não utilize de forma pirata. Valorize o trabalho do            ||
||    desenvolvedor adquirindo uma licença legítima.                 ||
||                                                                    ||
||    [$] APOIE O DESENVOLVEDOR                                      ||
||    Ao comprar o original você apoia um profissional que           ||
||    também tem família e luta todo dia para pagar as contas.       ||
||    Não pegue atalhos - um dia a vida manda a conta das            ||
||    pequenas coisas erradas que fazemos.                           ||
||                                                                    ||
||    [$] Se este script te ajudou a ficar rico e quiser me          ||
||    enviar um presente financeiro: PIX dante.testa@gmail.com      ||
||                                                                    ||
||    [*] SUPORTE TÉCNICO [não gratuito]                             ||
||    Disponível via WhatsApp. Entre em contato para consultar       ||
||    valores e planos de suporte personalizados.                    ||
||                                                                    ||
||    "Código é poesia. Respeite o poeta."                           ||
||                                                                    ||
\\====================================================================//
-->
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Metatags para evitar cache -->
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>Cardápio Sheets</title>
    <script src="config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        :root {
            /* ===== CORES PRINCIPAIS - ESTILO iFOOD ===== */
            --cor-primaria: #EA1D2C;           /* Vermelho iFood - mais quente e apetitoso */
            --cor-primaria-escura: #D01625;    /* Vermelho escuro iFood */
            --cor-secundaria: #FF6B35;         /* Laranja vibrante - estimula apetite */
            --cor-secundaria-escura: #E55A2B;  /* Laranja escuro */
            --cor-terciaria: #FFB800;          /* Amarelo dourado - para destaques */
            --cor-terciaria-escura: #E6A600;   /* Amarelo escuro */
            --cor-accent: #4CAF50;             /* Verde sucesso - confirmações */
            --cor-accent-escura: #45A049;      /* Verde escuro */
            --cor-whatsapp: #25D366;           /* Verde WhatsApp */
            --cor-whatsapp-escura: #128C7E;    /* Verde WhatsApp escuro */
            
            /* ===== CORES DE FUNDO - MAIS CLEAN ===== */
            --cor-fundo: #FAFAFA;              /* Fundo mais clean que branco puro */
            --cor-fundo-branco: #FFFFFF;       /* Branco puro para cards */
            --cor-fundo-card: #FFFFFF;         /* Cards em branco puro */
            --cor-fundo-modal: rgba(0, 0, 0, 0.9); /* Fundo modal escuro */
            
            /* ===== CORES DE TEXTO - MELHOR CONTRASTE ===== */
            --cor-texto: #1A1A1A;              /* Texto principal - mais escuro */
            --cor-texto-secundario: #6B7280;   /* Texto secundário */
            --cor-texto-claro: #9CA3AF;        /* Texto claro */
            --cor-texto-branco: #FFFFFF;       /* Texto branco */
            --cor-texto-destaque: #EA1D2C;     /* Texto destaque vermelho */
            
            /* ===== CORES DE BORDA - MAIS SUAVES ===== */
            --cor-borda: #E5E7EB;              /* Borda padrão */
            --cor-borda-clara: #F3F4F6;        /* Borda clara */
            --cor-borda-escura: #D1D5DB;       /* Borda escura */
            --cor-borda-destaque: #EA1D2C;     /* Borda destaque */
            
            /* ===== CORES DE ESTADO - FOOD FRIENDLY ===== */
            --cor-sucesso: #4CAF50;            /* Verde sucesso */
            --cor-sucesso-fundo: #E8F5E9;      /* Fundo verde claro */
            --cor-erro: #F44336;               /* Vermelho erro */
            --cor-erro-fundo: #FFEBEE;         /* Fundo vermelho claro */
            --cor-aviso: #FFB800;              /* Amarelo aviso */
            --cor-aviso-fundo: #FFF8E1;        /* Fundo amarelo claro */
            --cor-info: #2196F3;               /* Azul informação */
            --cor-info-fundo: #E3F2FD;         /* Fundo azul claro */
            
            /* ===== TRANSPARÊNCIAS - MAIS MODERNAS ===== */
            --transparencia-backdrop: rgba(255, 255, 255, 0.95); /* Backdrop blur */
            --transparencia-sombra: rgba(0, 0, 0, 0.08);          /* Sombra padrão mais sutil */
            --transparencia-sombra-forte: rgba(0, 0, 0, 0.12);    /* Sombra forte */
            --transparencia-hover: rgba(234, 29, 44, 0.08);       /* Hover com cor primária */
            --transparencia-whatsapp: rgba(37, 211, 102, 0.3);    /* Sombra WhatsApp */
            --transparencia-whatsapp-escura: rgba(18, 140, 126, 0.4); /* Sombra WhatsApp escura */
            --transparencia-primaria: rgba(234, 29, 44, 0.1);     /* Transparência primária */
            --transparencia-secundaria: rgba(255, 107, 53, 0.1);  /* Transparência secundária */
            
            /* ===== SOMBRAS - ESTILO iFOOD ===== */
            --sombra-card: 0 4px 12px rgba(0, 0, 0, 0.08);        /* Sombra card mais sutil */
            --sombra-card-hover: 0 8px 24px rgba(0, 0, 0, 0.12);  /* Sombra hover */
            --sombra-botao: 0 4px 16px rgba(234, 29, 44, 0.3);    /* Sombra botão colorida */
            --sombra-botao-hover: 0 6px 20px rgba(234, 29, 44, 0.4); /* Sombra botão hover */
            --sombra-modal: 0 20px 60px rgba(0, 0, 0, 0.5);       /* Sombra modal */
            --sombra-toast: 0 10px 25px rgba(0, 0, 0, 0.15);      /* Sombra toast */
            
            /* ===== GRADIENTES MODERNOS - ESTILO iFOOD ===== */
            --gradiente-primario: linear-gradient(135deg, #EA1D2C 0%, #FF6B35 100%);     /* Vermelho para laranja */
            --gradiente-secundario: linear-gradient(135deg, #FF6B35 0%, #FFB800 100%);   /* Laranja para amarelo */
            --gradiente-terciario: linear-gradient(135deg, #FFB800 0%, #FFC107 100%);    /* Amarelo dourado */
            --gradiente-sucesso: linear-gradient(135deg, #4CAF50 0%, #66BB6A 100%);      /* Verde sucesso */
            --gradiente-whatsapp: linear-gradient(135deg, #25D366 0%, #128C7E 100%);     /* WhatsApp */
            --gradiente-card: linear-gradient(135deg, #FFFFFF 0%, #FAFAFA 100%);         /* Card sutil */
            
            /* ===== GRADIENTES HOVER - MAIS INTENSOS ===== */
            --gradiente-primario-hover: linear-gradient(135deg, #D01625 0%, #E55A2B 100%);
            --gradiente-secundario-hover: linear-gradient(135deg, #E55A2B 0%, #E6A600 100%);
            --gradiente-sucesso-hover: linear-gradient(135deg, #45A049 0%, #5CB85C 100%);
        }
        
        body { font-family: 'Inter', sans-serif; }
        
        .category-nav {
            backdrop-filter: blur(10px);
            background: transparent;
        }
        
        .category-item {
            transition: all 0.3s ease;
            white-space: nowrap;
        }
        
        /* Hide scrollbar for category navigation */
        .scrollbar-hide {
            -ms-overflow-style: none;  /* Internet Explorer 10+ */
            scrollbar-width: none;  /* Firefox */
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;  /* Safari and Chrome */
        }
        
        .category-item.active {
            background: var(--cor-primaria);
            color: var(--cor-texto-branco);
        }
        
        .food-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .food-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--sombra-card);
        }
        
        .cart-fab {
            position: fixed;
            bottom: 30px;
            right: 20px;
            z-index: 1000;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 160px;
            height: 64px;
            border-radius: 32px;
            box-shadow: 0 8px 25px var(--transparencia-whatsapp);
            backdrop-filter: blur(10px);
        }
        
        .cart-fab:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 35px var(--transparencia-whatsapp-escura);
        }
        
        .modal-overlay {
            backdrop-filter: blur(5px);
        }
        
        .quantity-btn {
            transition: all 0.2s ease;
        }
        
        .quantity-btn:active {
            transform: scale(0.95);
        }
        
        .modal-footer {
            position: sticky;
            bottom: 0;
            background: var(--cor-fundo-branco);
            border-top: 1px solid var(--cor-borda);
            padding: 16px 20px;
            margin: 0 -24px -24px -24px;
            border-radius: 0 0 16px 16px;
            box-shadow: 0 -4px 6px -1px var(--transparencia-sombra);
            z-index: 10;
        }
        
        .modal-footer-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            align-items: center;
        }
        
        .modal-footer-grid > div:last-child {
            padding-left: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @media (max-width: 640px) {
            #header-slogan {
                font-size: 0.65rem !important;
            }
        }
        
        @media (max-width: 480px) {
            .modal-footer {
                padding: 12px 16px;
                margin: 0 -20px -20px -20px;
            }
            
            .modal-footer-grid {
                gap: 10px;
            }
        }
        
        .slide-up {
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* ===== CUPOM EXPANSÍVEL - TRANSIÇÕES SUAVES ===== */
        .coupon-toggle-btn {
            transition: all 0.3s ease;
            cursor: pointer;
            user-select: none;
        }
        
        .coupon-toggle-btn:hover {
            background-color: var(--cor-fundo-card);
            transform: translateY(-1px);
            box-shadow: var(--sombra-card);
        }
        
        .coupon-toggle-btn:active {
            transform: translateY(0);
        }
        
        .coupon-field-container {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .coupon-arrow {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .bounce {
            animation: bounce 0.6s ease;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }
        
        .shake {
            animation: shake 0.6s ease-in-out;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-8px); }
            20%, 40%, 60%, 80% { transform: translateX(8px); }
        }
        
        .field-error {
            border-color: var(--cor-erro) !important;
            background-color: var(--cor-erro-fundo) !important;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
            border-width: 2px !important;
        }
        
        .error-message {
            color: var(--cor-erro);
            font-size: 0.875rem;
            margin-top: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            animation: slideDown 0.3s ease-out;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes gradientRotate {
            0% {
                background-position: 0% 50%, 0% 0%;
            }
            25% {
                background-position: 0% 50%, 100% 0%;
            }
            50% {
                background-position: 0% 50%, 100% 100%;
            }
            75% {
                background-position: 0% 50%, 0% 100%;
            }
            100% {
                background-position: 0% 50%, 0% 0%;
            }
        }
        
        @keyframes smoothSpin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }
        
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            max-width: 400px;
            width: 90%;
            padding: 16px 20px;
            border-radius: 12px;
            box-shadow: var(--sombra-toast);
            backdrop-filter: blur(10px);
            animation: toastSlideIn 0.4s ease-out;
        }
        
        .toast-error {
            background: var(--gradiente-primario);
            color: var(--cor-texto-branco);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        .toast-success {
            background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria)) !important;
            color: white !important;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2) !important;
        }
        
        /* Lightbox Styles */
        .lightbox {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--cor-fundo-modal);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .lightbox.active {
            opacity: 1;
            visibility: visible;
        }
        
        .lightbox-content {
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }
        
        .lightbox.active .lightbox-content {
            transform: scale(1);
        }
        
        .lightbox-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }
        
        .lightbox-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            color: var(--cor-texto);
            transition: all 0.2s ease;
        }
        
        .lightbox-close:hover {
            background: var(--cor-fundo-branco);
            transform: scale(1.1);
        }
        
        .lightbox-title {
            position: absolute;
            bottom: -40px;
            left: 0;
            right: 0;
            text-align: center;
            color: var(--cor-texto-branco);
            font-size: 16px;
            font-weight: 500;
        }
           
        
        .toast-warning {
            background: var(--gradiente-terciario);
            color: var(--cor-texto-branco);
            border: 1px solid rgba(255,255,255,0.2);
        }
        
        @keyframes toastSlideIn {
            from {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
            to {
                opacity: 1;
                transform: translate(-50%, 0);
            }
        }
        
        .toast-exit {
            animation: toastSlideOut 0.3s ease-in forwards;
        }
        
        @keyframes toastSlideOut {
            to {
                opacity: 0;
                transform: translate(-50%, -20px);
            }
        }
        
        /* Lazy Loading Styles */
        .lazy-image {
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .lazy-image.loaded {
            opacity: 1;
        }
        
        @keyframes shimmer {
            0% {
                background-position: -200% 0;
            }
            100% {
                background-position: 200% 0;
            }
        }
        
        /* Checkout disabled styles */
        .checkout-disabled .add-to-cart-btn,
        .checkout-disabled .quantity-controls,
        .checkout-disabled .cart-fab,
        .checkout-disabled .cart-count,
        .checkout-disabled .add-btn,
        .checkout-disabled .modal-footer,
        .checkout-disabled .quantity-btn {
            display: none !important;
        }
        
        .checkout-disabled .food-card {
            cursor: default;
        }
        
        .checkout-disabled .food-card:hover {
            transform: none;
        }
        
        /* Animação pulse para badge de desconto */
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.9;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }
    </style>
</head>
<body style="background-color: var(--cor-fundo) !important;">
    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-40">
        <div class="max-w-4xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3 cursor-pointer hover:opacity-80 transition-opacity" onclick="window.location.reload()" title="Recarregar página">
                    <img id="header-logo" src="" alt="Logo" class="object-cover rounded-lg" style="display: none; width: 55px; height: 55px;" onerror="this.style.display='none'">
                    <div>
                        <h1 id="header-company-name" class="text-base sm:text-2xl font-bold" style="color: var(--cor-primaria) !important;">Cardápio Digital</h1>
                        <p id="header-slogan" class="text-xs sm:text-base" style="color: var(--cor-texto) !important;" >Slogan da Empresa</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3">
                    <div class="text-right cursor-pointer hover:bg-gray-50 p-2 rounded-lg transition-colors" onclick="openHoursModal()" id="hours-indicator" style="font-size: 0.85rem;">
                        <div class="flex items-center space-x-2">
                            <div id="status-dot" class="w-2 h-2 bg-green-500 rounded-full"></div>
                            <div class="font-medium" style="color: var(--cor-secundaria) !important;" id="status-text">Aberto</div>
                        </div>
                        <div style="color: var(--cor-texto) !important;" id="hours-text">até 23h</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Categories Navigation -->
    <nav class="category-nav fixed top-[89px] left-0 right-0 z-30 bg-white" style="border-bottom: 1px solid var(--cor-borda) !important;">
        <div class="max-w-4xl mx-auto px-4 py-3">
            <div class="flex space-x-2 overflow-x-auto scrollbar-hide" id="category-nav">
                <!-- Categories will be populated dynamically from CSV data -->
            </div>
        </div>
    </nav>

    <!-- Menu Content -->
    <main class="max-w-4xl mx-auto px-4 py-6 pb-4 mt-[80px]">
        <!-- Search -->
        <div class="mb-6">
            <div class="relative">
                <input type="text" id="search" placeholder="Buscar pratos..." 
                       class="w-full pl-4 pr-20 py-3 rounded-lg focus:ring-2 focus:border-transparent" style="border: 1px solid var(--cor-borda) !important; --tw-ring-color: var(--cor-primaria) !important;">
                <div class="absolute right-2 top-2 flex space-x-2">
                    <button id="clear-search" onclick="clearSearch()" class="hidden rounded-full w-8 h-8 flex items-center justify-center transition-colors" style="background-color: var(--cor-fundo-secundario) !important; color: var(--cor-texto-secundario) !important;" title="Limpar busca" onmouseover="this.style.backgroundColor='var(--cor-borda)'" onmouseout="this.style.backgroundColor='var(--cor-fundo-secundario)'">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                        </svg>
                    </button>
                    <button id="search-btn" onclick="performSearch()" class="rounded-full w-8 h-8 flex items-center justify-center transition-colors" style="background-color: var(--cor-primaria) !important; color: white !important;" title="Pesquisar" onmouseover="this.style.backgroundColor='var(--cor-primaria-hover)'" onmouseout="this.style.backgroundColor='var(--cor-primaria)'">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Menu Sections -->
        <div id="menu-content">
            <!-- Sections will be populated here -->
        </div>
    </main>

    <!-- Google Review CTA -->
    <section id="google-reviews-section" class="py-12 mt-0" style="background: var(--cor-fundo) !important; display: none;">
        <div class="max-w-4xl mx-auto px-4 text-center">
            <div class="bg-white rounded-2xl p-8 shadow-xl">
                <div class="text-6xl mb-4">⭐</div>
                <h3 class="text-2xl font-bold mb-3" style="color: var(--cor-texto) !important;">Gostou da experiência?</h3>
                <p class="mb-6" style="color: var(--cor-texto-secundario) !important;">Sua avaliação nos ajuda a melhorar e alcançar mais pessoas!</p>
                <a id="google-reviews-link" href="" target="_blank" 
                   class="inline-flex items-center space-x-2 px-8 py-4 rounded-full font-bold text-lg transition-all transform hover:scale-105 shadow-lg" style="background-color: var(--cor-terciaria) !important; color: white !important;" onmouseover="this.style.backgroundColor='var(--cor-terciaria-hover)'" onmouseout="this.style.backgroundColor='var(--cor-terciaria)'">
                    <span>⭐</span>
                    <span>Avaliar no Google</span>
                </a>
               
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="py-8" style="background-color: var(--cor-fundo) !important; border-top: 5px solid transparent !important; background-image: linear-gradient(var(--cor-fundo), var(--cor-fundo)), linear-gradient(45deg, var(--cor-primaria), var(--cor-secundaria), var(--cor-terciaria), var(--cor-secundaria), var(--cor-primaria)) !important; background-origin: border-box !important; background-clip: padding-box, border-box !important; background-size: 100% 100%, 400% 400% !important; animation: gradientRotate 24s ease-in-out infinite !important; box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.08) !important; position: relative; overflow: hidden;">
        <div class="max-w-4xl mx-auto px-4">
            <!-- Main Info -->
            <div class="text-center mb-6">
                <div class="mb-3">
                    <h3 id="footer-company-name" class="text-2xl font-bold" style="color: var(--cor-texto) !important; font-weight: 700; text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);">🍽️ Cardápio Digital</h3>
                </div>
                <p id="footer-address" class="mb-4 text-sm" style="color: var(--cor-texto-secundario) !important; font-weight: 500; opacity: 0.9;">Rua das Flores, 123 • Centro - Campinas/SP</p>
                
                <!-- Contact & Hours in compact format -->
                <div class="flex flex-wrap justify-center items-center gap-6 text-sm mb-6" style="color: var(--cor-texto-secundario) !important;">
                    <a id="footer-phone" href="" class="flex items-center space-x-2 transition-all duration-300" style="display: none; color: var(--cor-primaria) !important; text-decoration: none; font-weight: 500;" onmouseover="this.style.color='var(--cor-secundaria)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.color='var(--cor-primaria)'; this.style.transform='translateY(0)'">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" style="color: var(--cor-primaria) !important; transition: all 0.3s ease;">
                            <path d="M6.62,10.79C8.06,13.62 10.38,15.94 13.21,17.38L15.41,15.18C15.69,14.9 16.08,14.82 16.43,14.93C17.55,15.3 18.75,15.5 20,15.5A1,1 0 0,1 21,16.5V20A1,1 0 0,1 20,21A17,17 0 0,1 3,4A1,1 0 0,1 4,3H7.5A1,1 0 0,1 8.5,4C8.5,5.25 8.7,6.45 9.07,7.57C9.18,7.92 9.1,8.31 8.82,8.59L6.62,10.79Z"/>
                        </svg>
                        <span style="color: var(--cor-primaria) !important; transition: color 0.3s ease;"></span>
                    </a>

                    <div id="footer-email" class="cursor-pointer transition-all duration-300" style="display: none; color: var(--cor-primaria) !important;" onclick="window.location.href='mailto:' + this.dataset.email" title="Enviar email" onmouseover="this.style.color='var(--cor-secundaria)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.color='var(--cor-primaria)'; this.style.transform='translateY(0)'">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" style="color: var(--cor-primaria) !important; transition: all 0.3s ease;">
                            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                        </svg>
                    </div>
                    
                    <div id="footer-qrcode" class="cursor-pointer transition-all duration-300" style="color: var(--cor-primaria) !important;" onclick="openQRCodeModal()" title="Ver QR Code do cardápio" onmouseover="this.style.color='var(--cor-secundaria)'; this.style.transform='translateY(-2px)'" onmouseout="this.style.color='var(--cor-primaria)'; this.style.transform='translateY(0)'">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16" style="color: var(--cor-primaria) !important; transition: all 0.3s ease;">
                            <path d="M2 2h2v2H2z"/>
                            <path d="M6 0v6H0V0zM5 1H1v4h4zM4 12H2v2h2z"/>
                            <path d="M6 10v6H0v-6zm-5 1v4h4v-4zm11-9h2v2h-2z"/>
                            <path d="M10 0v6h6V0zm5 1v4h-4V1zM8 1V0h1v2H8v2H7V1zm0 5V4h1v2zM6 8V7h1V6h1v2h1V7h5v1h-4v1H7V8zm0 0v1H2V8H1v1H0V7h3v1zm10 1h-1V7h1zm-1 0h-1v2h2v-1h-1zm-4 0h2v1h-1v1h-1zm2 3v-1h-1v1h-1v1H9v1h3v-2zm0 0h3v1h-2v1h-1zm-4-1v1h1v-2H7v1z"/>
                            <path d="M7 12h1v3h4v1H7zm9 2v2h-3v-1h2v-1z"/>
                        </svg>
                    </div>
                    <div class="flex items-center space-x-2 cursor-pointer transition-all duration-300" onclick="openHoursModal()" title="Ver horários de funcionamento" onmouseover="this.style.transform='translateY(-2px)'; this.querySelector('span').style.color='var(--cor-primaria)'" onmouseout="this.style.transform='translateY(0)'; this.querySelector('span').style.color='var(--cor-primaria)'">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" style="color: var(--cor-primaria) !important; transition: all 0.3s ease;">
                            <path d="M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2M16.2,16.2L11,13V7H12.5V12.2L17,14.9L16.2,16.2Z"/>
                        </svg>
                        <span class="font-medium" style="color: var(--cor-primaria) !important; font-weight: 500; transition: color 0.3s ease; font-size: 0.9em;">Ver Horários</span>
                    </div>
                </div>
                
                <!-- Social Icons -->
                <div class="flex justify-center space-x-3">
                    <a id="footer-instagram" href="" target="_blank" style="display: none; background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria)); color: white; padding: 0.75rem; border-radius: 50%; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);" onmouseover="this.style.background='linear-gradient(135deg, var(--cor-secundaria), var(--cor-terciaria))'; this.style.transform='translateY(-3px) scale(1.05)'; this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.2)'" onmouseout="this.style.background='linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))'; this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.15)'">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" style="color: white;">
                            <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.40s-.644-1.44-1.439-1.44z"/>
                        </svg>
                    </a>
                    <a id="footer-facebook" href="" target="_blank" style="display: none; background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria)); color: white; padding: 0.75rem; border-radius: 50%; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);" onmouseover="this.style.background='linear-gradient(135deg, var(--cor-secundaria), var(--cor-terciaria))'; this.style.transform='translateY(-3px) scale(1.05)'; this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.2)'" onmouseout="this.style.background='linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))'; this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.15)'">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" style="color: white;">
                            <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
                        </svg>
                    </a>
                    <a id="footer-whatsapp" href="" target="_blank" style="display: none; background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria)); color: white; padding: 0.75rem; border-radius: 50%; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);" onmouseover="this.style.background='linear-gradient(135deg, var(--cor-secundaria), var(--cor-terciaria))'; this.style.transform='translateY(-3px) scale(1.05)'; this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.2)'" onmouseout="this.style.background='linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))'; this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.15)'">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" style="color: white;">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.890-5.335 11.893-11.893A11.821 11.821 0 0020.893 3.488"/>
                        </svg>
                    </a>
                    <a id="footer-email-link" href="" style="display: none; background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria)); color: white; padding: 0.75rem; border-radius: 50%; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);" onmouseover="this.style.background='linear-gradient(135deg, var(--cor-secundaria), var(--cor-terciaria))'; this.style.transform='translateY(-3px) scale(1.05)'; this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.2)'" onmouseout="this.style.background='linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))'; this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 4px 12px rgba(0, 0, 0, 0.15)'">
                        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24" style="color: white;">
                            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z"/>
                        </svg>
                    </a>
                    

                </div>
            </div>
            
            <!-- Developer Credits -->
            <div class="border-t pt-6 text-center" style="border-color: rgba(200, 200, 200, 0.3) !important; margin-top: 2rem; padding-top: 1.5rem;">
                <p class="text-xs" style="color: var(--cor-texto-secundario) !important; font-weight: 300; opacity: 0.7; font-size: 0.75rem;">
                    Desenvolvido com <span style="color: #e74c3c; font-size: 0.8rem;">♥</span> por <a href="https://www.dantetesta.com.br" target="_blank" class="transition-all duration-300" style="color: var(--cor-primaria) !important; text-decoration: none; font-weight: 400; position: relative; font-size: 0.75rem;" onmouseover="this.style.color='var(--cor-secundaria)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.color='var(--cor-primaria)'; this.style.transform='translateY(0)'">Dante Testa</a> <span style="color: var(--cor-texto-secundario); opacity: 0.5; font-size: 0.7rem;">👨‍💻</span>
                </p>
            </div>
        </div>
    </footer>

    <!-- Share FAB -->
    <button id="share-fab" class="fixed bottom-8 left-4 text-white p-3 rounded-full shadow-lg z-50 transition-all duration-300" style="background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria)) !important; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2) !important;" onclick="shareGeneral()" title="Compartilhar cardápio" onmouseover="this.style.background='linear-gradient(135deg, var(--cor-secundaria), var(--cor-primaria))'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 25px rgba(0, 0, 0, 0.3)'; this.querySelector('svg').style.animation='smoothSpin 0.6s ease-in'" onmouseout="this.style.background='linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(0, 0, 0, 0.2)'; this.querySelector('svg').style.animation='none'">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="transition: all 0.3s ease;">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
        </svg>
    </button>

    <!-- Cart FAB -->
    <button id="cart-fab" class="cart-fab text-white shadow-lg hidden" style="background-color: var(--cor-whatsapp) !important;" onclick="openCart()" onmouseover="this.style.backgroundColor='var(--cor-whatsapp-hover)'" onmouseout="this.style.backgroundColor='var(--cor-whatsapp)'">
        <div class="flex items-center space-x-4 px-5">
            <div class="relative">
                <svg class="w-9 h-9 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="margin-top: 6px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m1.6 8L6 5H3m4 8a2 2 0 100 4 2 2 0 000-4zm10 0a2 2 0 100 4 2 2 0 000-4z"/>
                </svg>
                <div id="cart-count" class="absolute -top-2 -right-2 bg-white rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold border-2" style="color: green !important; border-color: green !important;">0</div>
            </div>
            <div class="text-left">
                <div class="text-xs opacity-90 font-medium">Ver carrinho</div>
                <div class="font-bold text-base" id="cart-total">R$ 0,00</div>
            </div>
        </div>
    </button>

    <!-- Product Modal -->
    <div id="product-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden z-50" onclick="closeModal(event)">
        <div class="flex items-start justify-center min-h-screen p-4 pt-8">
            <div class="relative bg-white rounded-2xl w-full max-w-md slide-up max-h-[85vh] overflow-visible" onclick="event.stopPropagation()">
                <!-- Close Button positioned at modal edge -->
                <button onclick="closeModal()" class="absolute -top-3 -right-3 bg-white shadow-lg rounded-full p-2 text-gray-700 hover:text-gray-900 hover:bg-gray-50 transition-all duration-200 z-20 w-10 h-10 flex items-center justify-center font-bold text-xl">
                    ✕
                </button>
                <div class="overflow-y-auto overflow-x-hidden max-h-[85vh] rounded-2xl">
                     <div id="modal-content">
                         <!-- Modal content will be populated here -->
                     </div>
                 </div>
             </div>
         </div>
     </div>

    <!-- Cart Modal -->
    <div id="cart-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden z-50" onclick="closeCart(event)">
        <div class="flex items-start justify-center min-h-screen p-4 pt-8">
            <div class="bg-white rounded-2xl w-full max-w-md slide-up" onclick="event.stopPropagation()">
                <div class="p-4">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold">Seu Carrinho</h3>
                        <button onclick="closeCart()" class="text-gray-400 hover:text-gray-600">✕</button>
                    </div>
                    <div id="cart-items" class="space-y-4 mb-6 max-h-60 overflow-y-auto" style="overflow-x: visible;">
                        <!-- Cart items will be populated here -->
                    </div>
                    <div class="border-t pt-4">
                        <div class="flex justify-between items-center mb-3">
                            <span class="text-lg font-bold">Total:</span>
                            <span class="text-xl font-bold" style="color: var(--cor-primaria) !important;" id="cart-modal-total">R$ 0,00</span>
                        </div>
                        <button onclick="proceedToCheckout()" class="w-full text-white py-3 rounded-lg font-medium transition-colors" style="background-color: var(--cor-primaria) !important;" onmouseover="this.style.backgroundColor='var(--cor-primaria-hover)'" onmouseout="this.style.backgroundColor='var(--cor-primaria)'">
                            Finalizar Pedido →
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Lightbox Modal -->
    <div id="image-lightbox" class="fixed inset-0 bg-black bg-opacity-90 hidden z-50" onclick="closeLightbox(event)">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="relative max-w-4xl max-h-[90vh] w-full">
                <button onclick="closeLightbox()" class="absolute -top-12 right-0 text-white text-2xl font-bold z-10 transition-colors" onmouseover="this.style.color='var(--cor-texto-secundario)'" onmouseout="this.style.color='white'">
                    ✕
                </button>
                <img id="lightbox-image" src="" alt="" class="w-full h-full object-contain rounded-lg">
                <div id="lightbox-title" class="absolute bottom-0 left-0 right-0 text-white p-4 rounded-b-lg" style="background-color: rgba(0,0,0,0.7) !important;">
                    <!-- Title will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Notes Modal -->
    <div id="edit-notes-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden z-50" onclick="closeEditNotes(event)">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-2xl w-full max-w-md slide-up" onclick="event.stopPropagation()">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold">Editar Observações</h3>
                        <button onclick="closeEditNotes()" class="text-gray-400 hover:text-gray-600">✕</button>
                    </div>
                    
                    <div id="edit-item-info" class="mb-4 p-3 rounded-lg" style="background-color: var(--cor-fundo-secundario) !important;">
                        <!-- Item info will be populated here -->
                    </div>
                    
                    <div class="mb-6">
                        <label class="block text-sm font-medium mb-2" style="color: var(--cor-texto) !important;">Observações</label>
                        <textarea id="edit-item-notes" class="w-full px-3 py-2 rounded-lg focus:ring-2 focus:border-transparent" style="border: 1px solid var(--cor-borda) !important; --tw-ring-color: var(--cor-secundaria) !important;" rows="3" placeholder="Digite suas observações para este item..."></textarea>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="closeEditNotes()" class="flex-1 py-3 rounded-lg font-medium transition-colors" style="background-color: var(--cor-fundo-secundario) !important; color: var(--cor-texto) !important;" onmouseover="this.style.backgroundColor='var(--cor-borda)'" onmouseout="this.style.backgroundColor='var(--cor-fundo-secundario)'">
                            Cancelar
                        </button>
                        <button onclick="saveItemNotes()" class="flex-1 text-white py-3 rounded-lg font-medium transition-colors" style="background-color: var(--cor-secundaria) !important;" onmouseover="this.style.backgroundColor='var(--cor-secundaria-hover)'" onmouseout="this.style.backgroundColor='var(--cor-secundaria)'">
                            Salvar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkout-modal" class="fixed inset-0 bg-black bg-opacity-50 modal-overlay hidden z-50" onclick="closeCheckout(event)">
        <div class="flex items-start justify-center min-h-screen p-4 pt-8">
            <div class="rounded-2xl w-full max-w-lg slide-up max-h-[85vh] overflow-y-auto" style="background-color: var(--cor-fundo) !important;" onclick="event.stopPropagation()">
                


                <!-- Step 2: Delivery Type -->
                <div id="checkout-step-2" class="checkout-step p-6 hidden">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold" style="background-color: var(--cor-primaria) !important; color: white !important;">1</div>
                            <h3 class="text-xl font-bold">Tipo de Recebimento</h3>
                        </div>
                        <button onclick="closeCheckout()" style="color: var(--cor-texto-secundario) !important;" onmouseover="this.style.color='var(--cor-texto)'" onmouseout="this.style.color='var(--cor-texto-secundario)'">✕</button>
                    </div>
                    
                    <div id="delivery-options" class="space-y-3 mb-6">
                        <label class="flex items-center p-4 rounded-lg cursor-pointer" style="border: 1px solid var(--cor-borda) !important; background-color: white !important;" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor='white'">
                            <input type="radio" name="delivery-type" value="local" class="mr-3" onchange="handleDeliveryTypeChange()">
                            <div>
                                <div class="font-medium">🍽️ Consumir no Local</div>
                                <div class="text-sm" style="color: var(--cor-texto) !important;">Comer no restaurante</div>
                            </div>
                        </label>
                        
                        <label class="flex items-center p-4 rounded-lg cursor-pointer" style="border: 1px solid var(--cor-borda) !important; background-color: white !important;" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor='white'">
                            <input type="radio" name="delivery-type" value="pickup" class="mr-3" onchange="handleDeliveryTypeChange()">
                            <div>
                                <div class="font-medium">🥡 Retirar no Balcão</div>
                                <div class="text-sm" style="color: var(--cor-texto) !important;">Buscar no restaurante</div>
                            </div>
                        </label>
                        
                        <label class="flex items-center p-4 rounded-lg cursor-pointer" style="border: 1px solid var(--cor-borda) !important; background-color: white !important;" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor='white'">
                            <input type="radio" name="delivery-type" value="delivery" class="mr-3" onchange="handleDeliveryTypeChange()">
                            <div>
                                <div class="font-medium">🛵 Delivery</div>
                                <div class="text-sm" style="color: var(--cor-texto) !important;">Entrega em casa</div>
                            </div>
                        </label>
                        
                        <label class="flex items-center p-4 rounded-lg cursor-pointer" style="border: 1px solid var(--cor-borda) !important; background-color: white !important;" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor='white'">
                            <input type="radio" name="delivery-type" value="default" class="mr-3" onchange="handleDeliveryTypeChange()">
                            <div>
                                <div class="font-medium">📋 Padrão</div>
                                <div class="text-sm" style="color: var(--cor-texto) !important;">Sem especificação</div>
                            </div>
                        </label>
                    </div>
                    
                    <!-- Dynamic fields based on delivery type -->
                    <div id="delivery-fields" class="mb-6">
                        <!-- Fields will be populated based on selection -->
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="backToCart()" class="flex-1 py-3 rounded-lg font-medium transition-colors" style="background-color: var(--cor-fundo-secundario) !important; color: var(--cor-texto) !important;" onmouseover="this.style.backgroundColor='var(--cor-borda)'" onmouseout="this.style.backgroundColor='var(--cor-fundo-secundario)'">
                            ← Voltar
                        </button>
                        <button onclick="nextStep(3)" id="step2-continue" class="flex-1 py-3 rounded-lg font-medium transition-colors" style="background-color: var(--cor-primaria) !important; color: white !important;" onmouseover="this.style.backgroundColor='var(--cor-primaria-hover)'" onmouseout="this.style.backgroundColor='var(--cor-primaria)'">
                            Continuar →
                        </button>
                    </div>
                </div>

                <!-- Step 3: Customer Info -->
                <div id="checkout-step-3" class="checkout-step p-6 hidden">
                    <div class="flex items-center justify-between mb-6">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center text-sm font-bold" style="background-color: var(--cor-primaria) !important; color: white !important;">2</div>
                            <h3 class="text-xl font-bold">Finalizar Pedido</h3>
                        </div>
                        <button onclick="closeCheckout()" style="color: var(--cor-texto-secundario) !important;" onmouseover="this.style.color='var(--cor-texto)'" onmouseout="this.style.color='var(--cor-texto-secundario)'">✕</button>
                    </div>
                    
                    <!-- RESUMO DO PEDIDO - VERSÃO COMPACTA -->
                    <div class="bg-white border border-gray-200 rounded-lg shadow-sm p-4 mb-4">
                        
                        <!-- Título -->
                        <div class="flex items-center space-x-2 mb-3">
                            <svg class="w-5 h-5 text-gray-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"></path>
                            </svg>
                            <h3 class="text-sm font-semibold text-gray-800">Resumo do Pedido</h3>
                        </div>
                        
                        <!-- BREAKDOWN DETALHADO -->
                        <div class="space-y-2 mb-3">
                            
                            <!-- Subtotal Produtos -->
                            <div class="flex justify-between items-center">
                                <span class="text-sm text-gray-600">Subtotal</span>
                                <span id="order-subtotal" class="text-sm font-medium text-gray-800">R$ 0,00</span>
                            </div>
                            
                            <!-- Frete (quando aplicável) -->
                            <div id="delivery-row" class="flex justify-between items-center hidden">
                                <span class="text-sm text-gray-600">Frete</span>
                                <span id="order-delivery-fee" class="text-sm font-medium text-gray-800">R$ 0,00</span>
                            </div>
                            
                            <!-- Desconto (quando aplicável) -->
                            <div id="discount-row" class="flex justify-between items-center hidden">
                                <span class="text-green-600 flex items-center space-x-1">
                                    <span class="text-xs">💸</span>
                                    <span id="discount-label" class="text-xs sm:text-sm">Desconto</span>
                                </span>
                                <span id="order-discount" class="text-xs sm:text-sm font-medium text-green-600">-R$ 0,00</span>
                            </div>
                            
                        </div>
                        
                        <!-- LINHA SEPARADORA -->
                        <div class="border-t border-gray-200 pt-3 mb-3">
                            <div class="flex justify-between items-center">
                                <span class="text-base font-semibold text-gray-800">Total</span>
                                <span id="checkout-order-total" class="text-xl font-bold" style="color: var(--cor-primaria) !important;">R$ 0,00</span>
                            </div>
                        </div>
                        
                        <!-- CAMPO DE CUPOM EXPANSÍVEL -->
                        <div class="border-t border-gray-200 pt-3">
                            
                            <!-- Botão para expandir cupom -->
                            <div id="coupon-toggle-btn" class="cursor-pointer transition-all duration-200" onclick="toggleCouponField()">
                                <div class="flex items-center justify-center space-x-2 py-2 px-3 rounded-lg border border-dashed transition-all duration-200" style="border-color: var(--cor-primaria) !important; background-color: rgba(var(--cor-primaria-rgb), 0.05) !important;" onmouseover="this.style.backgroundColor='rgba(var(--cor-primaria-rgb), 0.1)'; this.style.transform='translateY(-1px)'" onmouseout="this.style.backgroundColor='rgba(var(--cor-primaria-rgb), 0.05)'; this.style.transform='translateY(0)'">
                                    <span class="text-xs font-medium" style="color: var(--cor-primaria) !important;">🎟️ Tenho um cupom de desconto</span>
                                    <svg id="coupon-arrow" class="w-3 h-3 transition-transform duration-200" style="color: var(--cor-primaria) !important;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                                    </svg>
                                </div>
                            </div>
                            
                            <!-- Campo expansível (inicialmente oculto) -->
                            <div id="coupon-field-container" class="overflow-hidden transition-all duration-300" style="max-height: 0; opacity: 0;">
                                <div class="pt-3">
                                    
                                    <div class="flex space-x-2">
                                        <!-- Input com botão de limpar inline -->
                                        <div class="flex-1 relative">
                                            <input 
                                                type="text" 
                                                id="coupon-code" 
                                                class="w-full px-2 sm:px-3 py-2 pr-8 text-xs sm:text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent uppercase" 
                                                placeholder="Código do cupom"
                                                style="text-transform: uppercase;"
                                                oninput="this.value = this.value.toUpperCase(); toggleClearButton()"
                                                onkeypress="if(event.key==='Enter') applyCouponFromButton()">
                                            <!-- Botão de limpar dentro do input -->
                                            <button 
                                                id="clear-coupon-btn"
                                                onclick="clearCouponInput()" 
                                                class="absolute right-2 top-1/2 transform -translate-y-1/2 w-5 h-5 rounded-full flex items-center justify-center text-gray-400 hover:text-gray-600 hover:bg-gray-100 transition-colors hidden"
                                                title="Limpar código"
                                                type="button">
                                                <span class="text-xs font-bold">×</span>
                                            </button>
                                        </div>
                                        <button 
                                            onclick="applyCouponFromButton()" 
                                            class="px-3 sm:px-4 py-2 text-xs sm:text-sm text-white rounded-lg transition-colors whitespace-nowrap"
                                            style="background-color: var(--cor-primaria) !important;"
                                            onmouseover="this.style.backgroundColor='var(--cor-primaria-hover)'"
                                            onmouseout="this.style.backgroundColor='var(--cor-primaria)'">
                                            Aplicar
                                        </button>
                                    </div>
                                    
                                    <!-- Feedback do Cupom -->
                                    <div id="coupon-feedback" class="mt-2 text-xs hidden"></div>
                                </div>
                            </div>
                            
                        </div>
                        
                    </div>
                    
                    <div class="space-y-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: var(--cor-texto) !important;">Nome *</label>
                            <input type="text" id="customer-name" class="w-full px-3 py-2 rounded-lg" style="border: 1px solid var(--cor-borda) !important; --tw-ring-color: var(--cor-primaria) !important;" placeholder="Seu nome completo" oninput="clearFieldError('customer-name')" onfocus="this.style.borderColor='var(--cor-primaria)'; this.style.outline='2px solid var(--cor-primaria)'; this.style.outlineOffset='2px'" onblur="this.style.borderColor='var(--cor-borda)'; this.style.outline='none'">
                        </div>
                        
                        <div id="whatsapp-field" class="hidden">
                            <label class="block text-sm font-medium mb-2" style="color: var(--cor-texto) !important;">WhatsApp *</label>
                            <div class="flex space-x-2">
                                <select id="country-code" class="px-3 py-2 rounded-lg" style="border: 1px solid var(--cor-borda) !important; --tw-ring-color: var(--cor-primaria) !important; min-width: 120px;" onfocus="this.style.borderColor='var(--cor-primaria)'; this.style.outline='2px solid var(--cor-primaria)'; this.style.outlineOffset='2px'" onblur="this.style.borderColor='var(--cor-borda)'; this.style.outline='none'" onchange="updatePhonePlaceholder()">
                                    <option value="55" data-flag="🇧🇷" data-format="(99) 9 9999-9999">🇧🇷 +55</option>
                                    <option value="351" data-flag="🇵🇹" data-format="999 999 999">🇵🇹 +351</option>
                                    <option value="244" data-flag="🇦🇴" data-format="999 999 999">🇦🇴 +244</option>
                                    <option value="258" data-flag="🇲🇿" data-format="99 999 9999">🇲🇿 +258</option>
                                    <option value="238" data-flag="🇨🇻" data-format="999 99 99">🇨🇻 +238</option>
                                    <option value="245" data-flag="🇬🇼" data-format="999 9999">🇬🇼 +245</option>
                                    <option value="239" data-flag="🇸🇹" data-format="99 99999">🇸🇹 +239</option>
                                    <option value="670" data-flag="🇹🇱" data-format="999 9999">🇹🇱 +670</option>
                                    <option value="853" data-flag="🇲🇴" data-format="9999 9999">🇲🇴 +853</option>
                                    <option value="1" data-flag="🇺🇸" data-format="(999) 999-9999">🇺🇸 +1</option>
                                    <option value="54" data-flag="🇦🇷" data-format="9 9999-9999">🇦🇷 +54</option>
                                    <option value="56" data-flag="🇨🇱" data-format="9 9999 9999">🇨🇱 +56</option>
                                    <option value="57" data-flag="🇨🇴" data-format="999 999 9999">🇨🇴 +57</option>
                                    <option value="51" data-flag="🇵🇪" data-format="999 999 999">🇵🇪 +51</option>
                                    <option value="598" data-flag="🇺🇾" data-format="9999 9999">🇺🇾 +598</option>
                                    <option value="595" data-flag="🇵🇾" data-format="999 999999">🇵🇾 +595</option>
                                    <option value="591" data-flag="🇧🇴" data-format="9999 9999">🇧🇴 +591</option>
                                    <option value="593" data-flag="🇪🇨" data-format="99 999 9999">🇪🇨 +593</option>
                                    <option value="58" data-flag="🇻🇪" data-format="999-999-9999">🇻🇪 +58</option>
                                    <option value="592" data-flag="🇬🇾" data-format="999 9999">🇬🇾 +592</option>
                                    <option value="597" data-flag="🇸🇷" data-format="999-9999">🇸🇷 +597</option>
                                    <option value="594" data-flag="🇬🇫" data-format="999 99 99 99">🇬🇫 +594</option>
                                    <option value="34" data-flag="🇪🇸" data-format="999 99 99 99">🇪🇸 +34</option>
                                    <option value="33" data-flag="🇫🇷" data-format="99 99 99 99 99">🇫🇷 +33</option>
                                    <option value="39" data-flag="🇮🇹" data-format="999 999 9999">🇮🇹 +39</option>
                                    <option value="49" data-flag="🇩🇪" data-format="999 99999999">🇩🇪 +49</option>
                                    <option value="44" data-flag="🇬🇧" data-format="9999 999999">🇬🇧 +44</option>
                                </select>
                                <input type="tel" id="customer-whatsapp" class="flex-1 px-3 py-2 rounded-lg" style="border: 1px solid var(--cor-borda) !important; --tw-ring-color: var(--cor-primaria) !important;" placeholder="(11) 9 9999-9999" oninput="formatWhatsAppWithCountry(this); clearFieldError('customer-whatsapp')" onfocus="this.style.borderColor='var(--cor-primaria)'; this.style.outline='2px solid var(--cor-primaria)'; this.style.outlineOffset='2px'" onblur="this.style.borderColor='var(--cor-borda)'; this.style.outline='none'" inputmode="numeric">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: var(--cor-texto) !important;">Forma de Pagamento *</label>
                            <select id="payment-method" class="w-full px-3 py-2 rounded-lg" style="border: 1px solid var(--cor-borda) !important; --tw-ring-color: var(--cor-primaria) !important;" onchange="clearFieldError('payment-method'); handlePaymentMethodChange()" onfocus="this.style.borderColor='var(--cor-primaria)'; this.style.outline='2px solid var(--cor-primaria)'; this.style.outlineOffset='2px'" onblur="this.style.borderColor='var(--cor-borda)'; this.style.outline='none'">
                                <option value="">Selecione...</option>
                                <!-- Options will be populated dynamically by setupPaymentMethods() from spreadsheet -->
                            </select>
                        </div>
                        
                        <div id="money-change" class="hidden">
                            <label class="block text-sm font-medium mb-1" style="color: var(--cor-texto) !important;">Valor para Troco *</label>
                            <p class="text-xs mb-2" style="color: var(--cor-texto-secundario) !important;">Informe um valor maior que o total do pedido</p>
                            <input type="tel" id="change-amount" class="w-full px-3 py-2 rounded-lg" style="border: 1px solid var(--cor-borda) !important; --tw-ring-color: var(--cor-primaria) !important;" placeholder="R$ 50,00" inputmode="numeric" onfocus="this.style.borderColor='var(--cor-primaria)'; this.style.outline='2px solid var(--cor-primaria)'; this.style.outlineOffset='2px'" onblur="this.style.borderColor='var(--cor-borda)'; this.style.outline='none'">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2" style="color: var(--cor-texto) !important;">Observações</label>
                            <textarea id="order-notes" class="w-full px-3 py-2 rounded-lg" style="border: 1px solid var(--cor-borda) !important; --tw-ring-color: var(--cor-primaria) !important;" rows="3" placeholder="Alguma observação especial?" onfocus="this.style.borderColor='var(--cor-primaria)'; this.style.outline='2px solid var(--cor-primaria)'; this.style.outlineOffset='2px'" onblur="this.style.borderColor='var(--cor-borda)'; this.style.outline='none'"></textarea>
                        </div>
                    </div>
                    
                    <div class="flex space-x-3">
                        <button onclick="prevStep(2)" class="w-2/5 py-3 rounded-lg font-medium transition-colors" style="background-color: var(--cor-fundo-secundario) !important; color: var(--cor-texto) !important;" onmouseover="this.style.backgroundColor='var(--cor-borda)'" onmouseout="this.style.backgroundColor='var(--cor-fundo-secundario)'">
                            ← Voltar
                        </button>
                        <button onclick="finalizeOrder()" class="w-3/5 py-3 rounded-lg font-medium transition-colors flex items-center justify-center space-x-2" style="background-color: var(--cor-whatsapp) !important; color: white !important;" onmouseover="this.style.backgroundColor='var(--cor-whatsapp-hover)'" onmouseout="this.style.backgroundColor='var(--cor-whatsapp)'">
                            <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.890-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                            </svg>
                            <span>Enviar Pedido</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Hours Modal -->
    <div id="hours-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="rounded-lg max-w-md w-full max-h-[90vh] overflow-y-auto" style="background-color: var(--cor-fundo) !important;">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold" style="color: var(--cor-texto) !important;">Horários de Funcionamento</h2>
                        <button onclick="closeHoursModal()" style="color: var(--cor-texto) !important;" onmouseover="this.style.color='var(--cor-texto)'" onmouseout="this.style.color='var(--cor-texto-secundario)'">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div id="hours-content" class="space-y-2">
                        <!-- Hours content will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal QR Code -->
    <div id="qrcode-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="rounded-lg max-w-md w-full max-h-[90vh] overflow-y-auto" style="background-color: var(--cor-fundo) !important;">
                <div class="p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold" style="color: var(--cor-texto) !important;">🔗 QR Code do Cardápio</h2>
                        <button onclick="closeQRCodeModal()" style="color: var(--cor-texto) !important;" onmouseover="this.style.color='var(--cor-texto)'" onmouseout="this.style.color='var(--cor-texto-secundario)'">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>
                    
                    <div class="text-center space-y-4">
                        <!-- QR Code Container -->
                        <div id="qrcode-container" class="flex justify-center p-4 rounded-lg" style="background-color: var(--cor-fundo-secundario); border: 2px solid var(--cor-primaria-clara);">
                            <div id="qrcode-display" class="bg-white p-4 rounded-lg shadow-lg">
                                <!-- QR Code será gerado aqui -->
                            </div>
                        </div>
                        
                        <!-- URL Display -->
                        <div class="p-3 rounded-lg" style="background-color: var(--cor-fundo-secundario); border: 1px solid var(--cor-primaria-clara);">
                            <p class="text-sm font-medium mb-2" style="color: var(--cor-texto) !important;">📱 Link do Cardápio:</p>
                            <div class="flex items-center space-x-2">
                                <input id="qrcode-url" type="text" readonly class="flex-1 p-2 text-sm rounded border" style="background-color: var(--cor-fundo); color: var(--cor-texto); border-color: var(--cor-primaria-clara);" />
                                <button onclick="copyQRCodeURL(event)" class="px-3 py-2 text-sm font-medium rounded transition-all duration-300" style="background: linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria)); color: white;" onmouseover="this.style.background='linear-gradient(135deg, var(--cor-secundaria), var(--cor-terciaria))'" onmouseout="this.style.background='linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))'">
                                    📋 Copiar
                                </button>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-col space-y-3">
                            <button id="download-qr-button" onclick="downloadQRCode(event)" disabled class="w-full py-3 px-4 font-medium rounded-lg transition-all duration-300" style="background: linear-gradient(135deg, #ccc, #999); color: #666; cursor: not-allowed;">
                                ⏳ Aguarde o QR Code...
                            </button>
                        </div>
                        
                        <!-- Info -->
                        <div class="text-xs text-center" style="color: var(--cor-texto-secundario); opacity: 0.8;">
                            <p>📱 Escaneie com a câmera do celular</p>
                            <p>🔗 Ou compartilhe o link diretamente</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables for menu data
        let menuData = {};
        let categoriesData = [];
        let hoursData = [];
        let configData = {};
        let neighborhoodsData = []; // Dados dos bairros para taxa de delivery
        let currentDeliveryFee = null; // Taxa de delivery atual
        let isDataLoaded = false;
        
        // Sistema de Cupons - Variáveis Globais
        let couponsData = []; // Dados dos cupons carregados da planilha
        let appliedCoupon = null; // Cupom atualmente aplicado
        let couponDiscount = 0; // Valor do desconto aplicado
        let couponTimeout = null; // Timeout para aplicação automática

        // CSV URLs - agora importadas do config.js
        // As URLs das planilhas estão definidas no arquivo config.js

        // Global configuration object
        let appConfig = {
            identidade_visual: {},
            cores: {},
            contato: {},
            horario: {},
            redes_sociais: {},
            seo: {},
            checkout: {},
            envio: {}
        };

        // Function to parse CSV data with proper handling of quoted fields
        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            if (lines.length === 0) return [];
            
            // Parse CSV line considering quoted fields
            function parseCSVLine(line) {
                const result = [];
                let current = '';
                let inQuotes = false;
                
                for (let i = 0; i < line.length; i++) {
                    const char = line[i];
                    
                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        result.push(current.trim());
                        current = '';
                    } else {
                        current += char;
                    }
                }
                
                result.push(current.trim());
                return result;
            }
            
            const headers = parseCSVLine(lines[0]).map(header => header.replace(/"/g, '').trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue; // Skip empty lines
                
                const values = parseCSVLine(lines[i]);
                const row = {};
                
                headers.forEach((header, index) => {
                    let value = values[index] || '';
                    // Remove surrounding quotes if present
                    if (value.startsWith('"') && value.endsWith('"')) {
                        value = value.slice(1, -1);
                    }
                    row[header] = value.trim();
                });
                
                data.push(row);
            }
            
            return data;
        }

        // Function to load CSV data
        async function loadCSVData(url) {
            try {
                console.log('Loading CSV from:', url);
                
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Accept': 'text/csv,text/plain,*/*'
                    }
                });
                
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                }
                
                const csvText = await response.text();
                console.log('CSV text length:', csvText.length);
                console.log('First 200 chars:', csvText.substring(0, 200));
                
                if (csvText.length === 0) {
                    throw new Error('Empty response received');
                }
                
                const parsedData = parseCSV(csvText);
                console.log('Parsed data length:', parsedData.length);
                
                return parsedData;
            } catch (error) {
                console.error('Error loading CSV data from', url, ':', error);
                
                // For hours data, provide fallback
                if (url === HOURS_CSV_URL) {
                    console.log('Providing fallback hours data');
                    return [
                        {
                            'Dia da Semana': 'segunda-feira',
                            'Período 1': '8:00 - 12:00',
                            'Período 2': '13:00 - 16:00',
                            'Período 3': '18:00 - 23:00'
                        },
                        {
                            'Dia da Semana': 'terça-feira',
                            'Período 1': '8:00 - 12:00',
                            'Período 2': '13:00 - 16:00',
                            'Período 3': '18:00 - 23:00'
                        },
                        {
                            'Dia da Semana': 'quarta-feira',
                            'Período 1': '8:00 - 12:00',
                            'Período 2': '13:00 - 16:00',
                            'Período 3': '18:00 - 23:00'
                        },
                        {
                            'Dia da Semana': 'quinta-feira',
                            'Período 1': '8:00 - 12:00',
                            'Período 2': '13:00 - 16:00',
                            'Período 3': '18:00 - 23:00'
                        },
                        {
                            'Dia da Semana': 'sexta-feira',
                            'Período 1': '8:00 - 12:00',
                            'Período 2': '13:00 - 16:00',
                            'Período 3': '18:00 - 23:00'
                        },
                        {
                            'Dia da Semana': 'sábado',
                            'Período 1': '8:00 - 12:00',
                            'Período 2': '13:00 - 16:00',
                            'Período 3': '18:00 - 23:00'
                        },
                        {
                            'Dia da Semana': 'domingo',
                            'Período 1': '',
                            'Período 2': '',
                            'Período 3': ''
                        }
                    ];
                }
                
                throw error;
            }
        }

        // Function to process configuration data
        function processConfigData(configItems) {
            const config = {
                identidade_visual: {},
                cores: {},
                contato: {},
                horario: {},
                redes_sociais: {},
                seo: {},
                checkout: {},
                envio: {}
            };

            configItems.forEach(item => {
                const section = item.section;
                const key = item.key;
                const value = item.value;

                if (config[section]) {
                    config[section][key] = value;
                }
            });

            return config;
        }

        // Function to apply configuration to the page
        function applyConfiguration() {
            try {
                // Apply header configuration
                updateHeaderWithConfig();
                updateFooterWithConfig();
                
                // Apply SEO configuration
                if (appConfig.seo.titulo_pagina) {
                    document.title = appConfig.seo.titulo_pagina;
                }
                
                if (appConfig.seo.descricao_seo) {
                    let metaDescription = document.querySelector('meta[name="description"]');
                    if (!metaDescription) {
                        metaDescription = document.createElement('meta');
                        metaDescription.name = 'description';
                        document.head.appendChild(metaDescription);
                    }
                    metaDescription.content = appConfig.seo.descricao_seo;
                }

                if (appConfig.seo.palavras_chave) {
                    let metaKeywords = document.querySelector('meta[name="keywords"]');
                    if (!metaKeywords) {
                        metaKeywords = document.createElement('meta');
                        metaKeywords.name = 'keywords';
                        document.head.appendChild(metaKeywords);
                    }
                    metaKeywords.content = appConfig.seo.palavras_chave;
                }

                // Apply favicon
                if (appConfig.identidade_visual.favicon_url) {
                    let favicon = document.querySelector('link[rel="icon"]');
                    if (!favicon) {
                        favicon = document.createElement('link');
                        favicon.rel = 'icon';
                        document.head.appendChild(favicon);
                    }
                    // Process favicon URL to handle Google Drive, Dropbox and external links
                    favicon.href = processImageUrl(appConfig.identidade_visual.favicon_url);
                }

                /**
                 * Função para calcular uma cor 20% mais escura
                 */
                function darkenColor(color, percent = 20) {
                    // Remove # se presente
                    color = color.replace('#', '');
                    
                    // Converte para RGB
                    const r = parseInt(color.substr(0, 2), 16);
                    const g = parseInt(color.substr(2, 2), 16);
                    const b = parseInt(color.substr(4, 2), 16);
                    
                    // Aplica o escurecimento
                    const factor = (100 - percent) / 100;
                    const newR = Math.round(r * factor);
                    const newG = Math.round(g * factor);
                    const newB = Math.round(b * factor);
                    
                    // Converte de volta para hex
                    return `#${newR.toString(16).padStart(2, '0')}${newG.toString(16).padStart(2, '0')}${newB.toString(16).padStart(2, '0')}`;
                }
                
                /**
                 * Aplica cores escuras automaticamente para hover dos botões
                 */
                function applyDarkerColors() {
                    const root = document.documentElement;
                    
                    // Obter cores atuais
                    const primaryColor = getComputedStyle(root).getPropertyValue('--cor-primaria').trim();
                    const secondaryColor = getComputedStyle(root).getPropertyValue('--cor-secundaria').trim();
                    const tertiaryColor = getComputedStyle(root).getPropertyValue('--cor-terciaria').trim();
                    const whatsappColor = getComputedStyle(root).getPropertyValue('--cor-whatsapp').trim();
                    
                    // Calcular e aplicar cores escuras
                    if (primaryColor) {
                        const darkerPrimary = darkenColor(primaryColor, 20);
                        root.style.setProperty('--cor-primaria-hover', darkerPrimary, 'important');
                    }
                    
                    if (secondaryColor) {
                        const darkerSecondary = darkenColor(secondaryColor, 20);
                        root.style.setProperty('--cor-secundaria-hover', darkerSecondary, 'important');
                    }
                    
                    if (tertiaryColor) {
                        const darkerTertiary = darkenColor(tertiaryColor, 20);
                        root.style.setProperty('--cor-terciaria-hover', darkerTertiary, 'important');
                    }
                    
                    if (whatsappColor) {
                        const darkerWhatsapp = darkenColor(whatsappColor, 20);
                        root.style.setProperty('--cor-whatsapp-hover', darkerWhatsapp, 'important');
                    }
                    
                    console.log('Cores de hover aplicadas:', {
                        primary: primaryColor + ' → ' + darkenColor(primaryColor, 20),
                        secondary: secondaryColor + ' → ' + darkenColor(secondaryColor, 20),
                        tertiary: tertiaryColor + ' → ' + darkenColor(tertiaryColor, 20),
                        whatsapp: whatsappColor + ' → ' + darkenColor(whatsappColor, 20)
                    });
                }

                // Apply colors as CSS custom properties with !important
                if (appConfig.cores) {
                    const root = document.documentElement;
                    
                    // Cores principais
                    if (appConfig.cores.cor_primaria) {
                        root.style.setProperty('--cor-primaria', appConfig.cores.cor_primaria, 'important');
                    }
                    if (appConfig.cores.cor_secundaria) {
                        root.style.setProperty('--cor-secundaria', appConfig.cores.cor_secundaria, 'important');
                    }
                    if (appConfig.cores.cor_terciaria) {
                        root.style.setProperty('--cor-terciaria', appConfig.cores.cor_terciaria, 'important');
                    }
                    
                    // Cores de fundo
                    if (appConfig.cores.cor_fundo) {
                        root.style.setProperty('--cor-fundo', appConfig.cores.cor_fundo, 'important');
                        // Também aplicar ao body com !important
                        document.body.style.setProperty('background-color', appConfig.cores.cor_fundo, 'important');
                    }
                    
                    // Cores de texto
                    if (appConfig.cores.cor_texto) {
                        root.style.setProperty('--cor-texto', appConfig.cores.cor_texto, 'important');
                    }
                    if (appConfig.cores.cor_texto_secundario) {
                        root.style.setProperty('--cor-texto-secundario', appConfig.cores.cor_texto_secundario, 'important');
                    }
                    
                    // Cores escuras para gradientes
                    if (appConfig.cores.cor_primaria_escura) {
                        root.style.setProperty('--cor-primaria-escura', appConfig.cores.cor_primaria_escura, 'important');
                    }
                    if (appConfig.cores.cor_secundaria_escura) {
                        root.style.setProperty('--cor-secundaria-escura', appConfig.cores.cor_secundaria_escura, 'important');
                    }
                    if (appConfig.cores.cor_terciaria_escura) {
                        root.style.setProperty('--cor-terciaria-escura', appConfig.cores.cor_terciaria_escura, 'important');
                    }
                    
                    // Atualizar gradientes baseados nas cores principais
                    if (appConfig.cores.cor_primaria && appConfig.cores.cor_primaria_escura) {
                        root.style.setProperty('--gradiente-primario', 
                            `linear-gradient(135deg, ${appConfig.cores.cor_primaria}, ${appConfig.cores.cor_primaria_escura})`, 'important');
                    }
                    if (appConfig.cores.cor_secundaria && appConfig.cores.cor_secundaria_escura) {
                        root.style.setProperty('--gradiente-secundario', 
                            `linear-gradient(135deg, ${appConfig.cores.cor_secundaria}, ${appConfig.cores.cor_secundaria_escura})`, 'important');
                    }
                    if (appConfig.cores.cor_terciaria && appConfig.cores.cor_terciaria_escura) {
                        root.style.setProperty('--gradiente-terciario', 
                            `linear-gradient(135deg, ${appConfig.cores.cor_terciaria}, ${appConfig.cores.cor_terciaria_escura})`, 'important');
                    }
                }
                
                // Aplicar cores escuras automaticamente (20% mais escuro)
                applyDarkerColors();

                // Apply delivery options configuration
                setupDeliveryOptions();
                
                // Apply checkout mode configuration
                applyCheckoutMode();

                console.log('Configuration applied successfully');
            } catch (error) {
                console.error('Error applying configuration:', error);
            }
        }

        // Function to update header with config data
        function updateHeaderWithConfig() {
            const companyNameElement = document.getElementById('header-company-name');
            const sloganElement = document.getElementById('header-slogan');
            const logoElement = document.getElementById('header-logo');
            
            // Update company name
            if (companyNameElement) {
                companyNameElement.textContent = getCompanyName();
            }
            
            // Update slogan
            if (sloganElement) {
                sloganElement.textContent = getSlogan();
            }
            
            // Update logo
            if (logoElement) {
                const logoUrl = getLogoUrl();
                if (logoUrl) {
                    logoElement.src = processImageUrl(logoUrl);
                    logoElement.style.display = 'block';
                } else {
                    logoElement.style.display = 'none';
                }
            }
        }

        // Function to apply checkout mode configuration
        function applyCheckoutMode() {
            try {
                console.log('🛒 applyCheckoutMode() called');
                
                const checkoutConfig = getCheckoutConfig();
                const checkoutMode = checkoutConfig.checkout_mode;
                
                console.log('🛒 Checkout mode:', checkoutMode);
                
                // Get cart elements
                const cartFab = document.getElementById('cart-fab');
                const cartCount = document.getElementById('cart-count');
                
                // Determine if checkout should be enabled
                const isCheckoutEnabled = checkoutMode && checkoutMode.toLowerCase() === 'sim';
                
                console.log('🛒 Checkout enabled:', isCheckoutEnabled);
                
                // For cart floating button, only hide it if checkout is disabled
                // Don't show it here - let updateCartUI handle visibility based on cart contents
                if (cartFab) {
                    if (!isCheckoutEnabled) {
                        cartFab.style.display = 'none';
                        console.log('🛒 Cart FAB: HIDDEN (checkout disabled)');
                    } else {
                        // Keep it hidden initially - updateCartUI will show it when cart has items
                        cartFab.style.display = 'none';
                        console.log('🛒 Cart FAB: HIDDEN (will show when cart has items)');
                    }
                }
                
                // Show/hide cart count
                if (cartCount) {
                    cartCount.style.display = isCheckoutEnabled ? 'flex' : 'none';
                    console.log('🛒 Cart count:', isCheckoutEnabled ? 'VISIBLE' : 'HIDDEN');
                }
                
                // Add CSS class to control add to cart buttons and quantity controls
                const body = document.body;
                if (isCheckoutEnabled) {
                    body.classList.remove('checkout-disabled');
                } else {
                    body.classList.add('checkout-disabled');
                }
                
                console.log('🛒 Checkout mode applied successfully');
            } catch (error) {
                console.error('Error applying checkout mode:', error);
            }
        }

        // Function to setup delivery options based on configuration
        function setupDeliveryOptions() {
            try {
                console.log('🔧 setupDeliveryOptions() called');
                console.log('📊 Current appConfig:', appConfig);
                console.log('📋 Current configData:', configData);
                
                const checkoutConfig = getCheckoutConfig();
                console.log('✅ Checkout config retrieved:', checkoutConfig);
                
                const deliveryOptions = document.getElementById('delivery-options');
                
                if (!deliveryOptions) {
                    console.log('❌ Delivery options container not found');
                    return;
                }
                console.log('✅ Delivery options container found');

                // Get all delivery option labels
                const localOption = deliveryOptions.querySelector('input[value="local"]')?.closest('label');
                const pickupOption = deliveryOptions.querySelector('input[value="pickup"]')?.closest('label');
                const deliveryOption = deliveryOptions.querySelector('input[value="delivery"]')?.closest('label');
                const defaultOption = deliveryOptions.querySelector('input[value="default"]')?.closest('label');

                console.log('🎯 Found delivery options:', {
                    local: !!localOption,
                    pickup: !!pickupOption,
                    delivery: !!deliveryOption,
                    default: !!defaultOption
                });

                // Helper function to extract visibility and labels from CSV value
                function parseOptionConfig(csvValue) {
                    if (!csvValue || !csvValue.includes('/')) {
                        return { shouldShow: false, label1: '', label2: '' };
                    }
                    const parts = csvValue.split('/');
                    const visibility = parts[0] ? parts[0].trim().toLowerCase() : '';
                    return {
                        shouldShow: visibility === 'sim',
                        label1: parts[1] ? parts[1].trim() : '',
                        label2: parts[2] ? parts[2].trim() : ''
                    };
                }

                // Configure local option (step2_opc1)
                if (localOption) {
                    const config = parseOptionConfig(checkoutConfig.step2_opc1);
                    localOption.style.display = config.shouldShow ? 'flex' : 'none';
                    
                    if (config.shouldShow) {
                        const titleElement = localOption.querySelector('.font-medium');
                        const subtitleElement = localOption.querySelector('.text-sm');
                        
                        if (titleElement && config.label1) {
                            titleElement.textContent = `🍽️ ${config.label1}`;
                        }
                        if (subtitleElement && config.label2) {
                            subtitleElement.textContent = config.label2;
                        }
                        console.log(`🏠 Local option labels updated: "${config.label1}" / "${config.label2}"`);
                    }
                    console.log(`🏠 Local option: ${config.shouldShow ? 'VISIBLE' : 'HIDDEN'} (${checkoutConfig.step2_opc1})`);
                }

                // Configure pickup option (step2_opc2)
                if (pickupOption) {
                    const config = parseOptionConfig(checkoutConfig.step2_opc2);
                    pickupOption.style.display = config.shouldShow ? 'flex' : 'none';
                    
                    if (config.shouldShow) {
                        const titleElement = pickupOption.querySelector('.font-medium');
                        const subtitleElement = pickupOption.querySelector('.text-sm');
                        
                        if (titleElement && config.label1) {
                            titleElement.textContent = `🥡 ${config.label1}`;
                        }
                        if (subtitleElement && config.label2) {
                            subtitleElement.textContent = config.label2;
                        }
                        console.log(`🥡 Pickup option labels updated: "${config.label1}" / "${config.label2}"`);
                    }
                    console.log(`🥡 Pickup option: ${config.shouldShow ? 'VISIBLE' : 'HIDDEN'} (${checkoutConfig.step2_opc2})`);
                }

                // Configure delivery option (step2_opc3)
                if (deliveryOption) {
                    const config = parseOptionConfig(checkoutConfig.step2_opc3);
                    deliveryOption.style.display = config.shouldShow ? 'flex' : 'none';
                    
                    if (config.shouldShow) {
                        const titleElement = deliveryOption.querySelector('.font-medium');
                        const subtitleElement = deliveryOption.querySelector('.text-sm');
                        
                        if (titleElement && config.label1) {
                            titleElement.textContent = `🛵 ${config.label1}`;
                        }
                        if (subtitleElement && config.label2) {
                            subtitleElement.textContent = config.label2;
                        }
                        console.log(`🛵 Delivery option labels updated: "${config.label1}" / "${config.label2}"`);
                    }
                    console.log(`🛵 Delivery option: ${config.shouldShow ? 'VISIBLE' : 'HIDDEN'} (${checkoutConfig.step2_opc3})`);
                }

                // Configure default option (step2_opc4)
                if (defaultOption) {
                    const config = parseOptionConfig(checkoutConfig.step2_opc4);
                    defaultOption.style.display = config.shouldShow ? 'flex' : 'none';
                    
                    if (config.shouldShow) {
                        const titleElement = defaultOption.querySelector('.font-medium');
                        const subtitleElement = defaultOption.querySelector('.text-sm');
                        
                        if (titleElement && config.label1) {
                            titleElement.textContent = `📋 ${config.label1}`;
                        }
                        if (subtitleElement && config.label2) {
                            subtitleElement.textContent = config.label2;
                        }
                        console.log(`📋 Default option labels updated: "${config.label1}" / "${config.label2}"`);
                    }
                    console.log(`📋 Default option: ${config.shouldShow ? 'VISIBLE' : 'HIDDEN'} (${checkoutConfig.step2_opc4})`);
                }

                console.log('✅ Delivery options configuration completed');

            } catch (error) {
                console.error('❌ Error setting up delivery options:', error);
            }
        }

        // Function to update footer with configuration data
        function updateFooterWithConfig() {
            const contactInfo = getContactInfo();
            const socialMedia = getSocialMedia();
            
            // Update footer company name
            const footerCompanyNameElement = document.getElementById('footer-company-name');
            if (footerCompanyNameElement) {
                footerCompanyNameElement.textContent = getCompanyName();
            }
            
            // Update footer address
            const footerAddressElement = document.getElementById('footer-address');
            if (footerAddressElement && contactInfo.endereco) {
                footerAddressElement.textContent = contactInfo.endereco;
                footerAddressElement.style.display = 'block';
            } else if (footerAddressElement) {
                footerAddressElement.style.display = 'none';
            }
            
            // Update footer phone
            const footerPhoneElement = document.getElementById('footer-phone');
            if (footerPhoneElement && contactInfo.telefone) {
                footerPhoneElement.querySelector('span:last-child').textContent = contactInfo.telefone;
                footerPhoneElement.href = `tel:${contactInfo.telefone}`;
                footerPhoneElement.style.display = 'flex';
            } else if (footerPhoneElement) {
                footerPhoneElement.style.display = 'none';
            }
            

            
            // Update footer email
            const footerEmailElement = document.getElementById('footer-email');
            if (footerEmailElement && contactInfo.email) {
                footerEmailElement.dataset.email = contactInfo.email;
                footerEmailElement.style.display = 'block';
            } else if (footerEmailElement) {
                footerEmailElement.style.display = 'none';
            }
            
            // Update social media links
            const footerInstagramElement = document.getElementById('footer-instagram');
            if (footerInstagramElement && socialMedia.instagram) {
                footerInstagramElement.href = socialMedia.instagram;
                footerInstagramElement.style.display = 'block';
            } else if (footerInstagramElement) {
                footerInstagramElement.style.display = 'none';
            }
            
            const footerFacebookElement = document.getElementById('footer-facebook');
            if (footerFacebookElement && socialMedia.facebook) {
                footerFacebookElement.href = socialMedia.facebook;
                footerFacebookElement.style.display = 'block';
            } else if (footerFacebookElement) {
                footerFacebookElement.style.display = 'none';
            }
            
            const footerWhatsappElement = document.getElementById('footer-whatsapp');
            if (footerWhatsappElement && contactInfo.whatsapp) {
                const whatsappNumber = contactInfo.whatsapp.replace(/\D/g, '');
                footerWhatsappElement.href = `https://wa.me/${whatsappNumber}`;
                footerWhatsappElement.style.display = 'block';
            } else if (footerWhatsappElement) {
                footerWhatsappElement.style.display = 'none';
            }
            
            const footerEmailLinkElement = document.getElementById('footer-email-link');
            if (footerEmailLinkElement && contactInfo.email) {
                footerEmailLinkElement.href = `mailto:${contactInfo.email}`;
                footerEmailLinkElement.style.display = 'block';
            } else if (footerEmailLinkElement) {
                footerEmailLinkElement.style.display = 'none';
            }
            
            // Update Google Reviews section
            const googleReviewsSection = document.getElementById('google-reviews-section');
            const googleReviewsLink = document.getElementById('google-reviews-link');
            if (googleReviewsSection && googleReviewsLink && socialMedia.google) {
                googleReviewsLink.href = socialMedia.google;
                googleReviewsSection.style.display = 'block';
            } else if (googleReviewsSection) {
                googleReviewsSection.style.display = 'none';
            }
        }

        // Helper functions to access configuration data
        function getConfig(section, key, defaultValue = '') {
            return appConfig[section]?.[key] || defaultValue;
        }

        function getCompanyName() {
            return getConfig('identidade_visual', 'nome_empresa', 'Cardápio Digital');
        }

        function getSlogan() {
            return getConfig('identidade_visual', 'slogan', 'Delivery');
        }

        function getLogoUrl() {
            return getConfig('identidade_visual', 'logo_url', '');
        }

        function getLogoMobileUrl() {
            return getConfig('identidade_visual', 'logo_mobile_url', '');
        }

        function getContactInfo() {
            return {
                endereco: getConfig('contato', 'endereco_completo', ''),
                telefone: getConfig('contato', 'telefone', ''),
                whatsapp: getConfig('contato', 'whatsapp', ''),
                email: getConfig('contato', 'email', '')
            };
        }

        function getSocialMedia() {
            return {
                instagram: getConfig('redes_sociais', 'instagram_url', ''),
                facebook: getConfig('redes_sociais', 'facebook_url', ''),
                google: getConfig('redes_sociais', 'google_negocio_url', '')
            };
        }

        function getCheckoutConfig() {
            return {
                step2_opc1: getConfig('checkout', 'step2_opc1', ''),
                step2_opc2: getConfig('checkout', 'step2_opc2', ''),
                step2_opc3: getConfig('checkout', 'step2_opc3', ''),
                step2_opc4: getConfig('checkout', 'step2_opc4', ''),
                step2_taxa_delivery: getConfig('checkout', 'step2_taxa_delivery', ''),
                step3_show_formas_pag: getConfig('checkout', 'step3_show_formas_pag', 'Sim'),
                step3_formas_pag: getConfig('checkout', 'step3_formas_pag', ''),
                step3_mesa_comanda: getConfig('checkout', 'step3_mesa_comanda', 'Sim'),
                step1_itens_obs: getConfig('checkout', 'step1_itens_obs', 'Sim'),
                checkout_mode: getConfig('checkout', 'checkout_mode', 'Sim'),
                checkout_currency: getConfig('checkout', 'checkout_currency', 'BRL')
            };
        }

        function getEnvioConfig() {
            return {
                whatsapp_web: getConfig('envio', 'whatsapp_web', 'Sim'),
                webhook_url: getConfig('envio', 'webhook_url', '')
            };
        }

        function getAppConfig() {
            return {
                nome_restaurante: getConfig('identidade_visual', 'nome_empresa', 'Cardápio Digital')
            };
        }

        // Function to process menu items and organize by category
        function processMenuData(menuItems, categories) {
            const processedData = {};
            
            // Initialize categories
            categories.forEach(category => {
                if (category.status === 'Ativo') {
                    processedData[category.nome_categoria] = [];
                }
            });

            // Process menu items
            menuItems.forEach((item, index) => {
                if (item.status === 'Ativo') {
                    // Support multiple categories separated by comma or semicolon
                    const itemCategories = item.categoria
                        .split(/[,;]/) // Split by comma or semicolon
                        .map(cat => cat.trim()) // Remove whitespace
                        .filter(cat => cat && processedData[cat]); // Only valid active categories
                    
                    // Create the processed item once
                    const processedItem = {
                        id: index + 1,
                        nome: item.item,
                        sku: item.SKU,
                        descricao: item.descricao,
                        preco: parseFloat(item.preco.replace('R$', '').replace(',', '.')),
                        imagem: processImageUrl(item.foto_url),
                        disponivel: true,
                        classificacaoAdicional: item.classificacao_adicional,
                        observacoes: item.observacoes
                    };
                    
                    // Add the item to each valid category
                    itemCategories.forEach(categoryName => {
                        // Create a copy of the item for each category to avoid reference issues
                        const itemCopy = { ...processedItem };
                        processedData[categoryName].push(itemCopy);
                    });
                }
            });

            return processedData;
        }

        // Function to show preloader
        function showPreloader() {
            const preloaderHTML = `
                <div id="preloader" class="fixed inset-0 bg-white z-50 flex items-center justify-center">
                    <div class="text-center">
                        <div class="mb-4">
                            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-red-500"></div>
                        </div>
                        <h2 class="text-xl font-semibold text-gray-800 mb-2">Carregando Cardápio</h2>
                        <p class="text-gray-600">Aguarde o carregamento...</p>
                        <div class="mt-4">
                            <div class="bg-gray-200 rounded-full h-2 w-64 mx-auto">
                                <div id="progress-bar" class="bg-red-500 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', preloaderHTML);
        }

        // Function to update progress
        function updateProgress(percentage) {
            const progressBar = document.getElementById('progress-bar');
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
        }

        // Function to hide preloader
        function hidePreloader() {
            const preloader = document.getElementById('preloader');
            if (preloader) {
                preloader.style.opacity = '0';
                setTimeout(() => {
                    preloader.remove();
                    // Mostrar toast da mesa após carregamento completo
                    setTimeout(() => {
                        mostrarIndicadorMesaURL();
                    }, 500);
                }, 300);
            }
        }

        // Function to load fallback data when CSV loading fails
        function loadFallbackData() {
            console.log('Loading fallback data...');
            
            // Fallback categories data
            categoriesData = [
                {
                    nome_categoria: 'bebidas_com_cafe',
                    titulo_exibicao: '☕ Cafés Especiais',
                    descricao: 'Grãos especiais preparados artesanalmente',
                    ordem: '1',
                    status: 'Ativo'
                },
                {
                    nome_categoria: 'entradas',
                    titulo_exibicao: '🥗 Entradas',
                    descricao: 'Deliciosas opções para começar',
                    ordem: '2',
                    status: 'Ativo'
                }
            ];
            
            // Fallback menu data
            menuData = {
                'bebidas_com_cafe': [
                    {
                        id: 1,
                        nome: 'Prensa Francesa',
                        sku: '0001',
                        descricao: 'Extração intensa realçando a oleosidade do café',
                        preco: 20.00,
                        imagem: getPlaceholderImage(),
                        disponivel: true,
                        classificacaoAdicional: '#Var: Café Jacu +R$3.54 / Café Toninho +R$5.20 / Café Java +R$3.93',
                        observacoes: '200ml'
                    }
                ],
                'entradas': [
                    {
                        id: 2,
                        nome: 'Exemplo de Entrada',
                        sku: '0002',
                        descricao: 'Dados de exemplo - conecte-se à internet para ver o cardápio completo',
                        preco: 15.00,
                        imagem: getPlaceholderImage(),
                        disponivel: true,
                        classificacaoAdicional: '',
                        observacoes: ''
                    }
                ]
            };
            
            isDataLoaded = true;
        }

        // Function to load all data
        async function loadAllData() {
            try {
                showPreloader();
                updateProgress(5);

                // Load configuration data first
                console.log('Loading configuration data...');
                configData = await loadCSVData(CONFIG_CSV_URL);
                appConfig = processConfigData(configData);
                console.log('Configuration loaded:', appConfig);
                updateProgress(15);

                // Apply configuration to the page
                applyConfiguration();
                updateProgress(20);

                // Load categories data
                console.log('Loading categories data...');
                categoriesData = await loadCSVData(CATEGORIES_CSV_URL);
                updateProgress(40);

                // Load menu items data
                console.log('Loading menu items data...');
                const menuItems = await loadCSVData(MENU_CSV_URL);
                updateProgress(65);

                // Load hours data
                console.log('Loading hours data...');
                console.log('Hours CSV URL:', HOURS_CSV_URL);
                hoursData = await loadCSVData(HOURS_CSV_URL);
                console.log('Hours data loaded:', hoursData);
                console.log('Hours data length:', hoursData.length);
                if (hoursData.length > 0) {
                    console.log('First hours entry:', hoursData[0]);
                    console.log('Hours data keys:', Object.keys(hoursData[0]));
                }
                updateProgress(80);

                // Load neighborhoods data for delivery fees
                console.log('🏘️ Loading neighborhoods data...');
                try {
                    neighborhoodsData = await loadCSVData(NEIGHBORHOODS_CSV_URL);
                    // Process neighborhoods data - mapear para formato consistente
                    neighborhoodsData = neighborhoodsData.map(row => ({
                        // Tentar várias possibilidades de nomes de colunas
                        bairro: (row.bairro || row.nome_bairro || row.Bairro || row.BAIRRO || '').trim().toLowerCase(),
                        taxa: parseFloat((row.taxa || row.valor_taxa || row.Taxa || row.TAXA || '0').toString().replace(',', '.')) || 0
                    })).filter(item => item.bairro); // Remove empty entries
                    
                    // Expor dados globalmente para acesso em outras funções
                    window.neighborhoodsData = neighborhoodsData;
                    
                    console.log(`✅ ${neighborhoodsData.length} bairros carregados:`, neighborhoodsData.slice(0, 3));
                    console.log('DEBUG - Estrutura dos dados:', neighborhoodsData.slice(0, 3));
                    console.log('DEBUG - window.neighborhoodsData definido:', !!window.neighborhoodsData);
                } catch (error) {
                    console.error('❌ Erro ao carregar dados dos bairros:', error);
                    neighborhoodsData = []; // Fallback to empty array
                }
                
                // Load coupons data
                console.log('🎟️ Carregando dados dos cupons...');
                try {
                    couponsData = await loadCSVData(COUPONS_CSV_URL);
                    console.log(`✅ ${couponsData.length} cupons carregados:`, couponsData.slice(0, 3));
                } catch (error) {
                    console.error('❌ Erro ao carregar dados dos cupons:', error);
                    couponsData = []; // Fallback to empty array
                }
                updateProgress(85);

                // Process and organize data
                console.log('Processing data...');
                menuData = processMenuData(menuItems, categoriesData);
                updateProgress(95);

                // Update operating hours display
                updateOperatingHours();
                
                // Set up periodic updates for operating hours (every minute)
                setInterval(updateOperatingHours, 60000);

                // Mark data as loaded
                isDataLoaded = true;
                updateProgress(100);

                console.log('Data loaded successfully:', { categoriesData, menuData });
                
                // Hide preloader and initialize app
                setTimeout(() => {
                    hidePreloader();
                    initializeApp();
                }, 500);

            } catch (error) {
                console.error('Error loading data:', error);
                hidePreloader();
                
                // Try to load fallback data
                console.log('Attempting to load fallback data...');
                try {
                    loadFallbackData();
                    
                    // Show warning about using fallback data
                    showToast('⚠️ Usando dados offline. Conecte-se à internet para ver o cardápio completo.', 'warning', 5000);
                    
                    initializeApp();
                } catch (fallbackError) {
                    console.error('Fallback data also failed:', fallbackError);
                    // Show error message with retry option
                    const errorHTML = `
                        <div class="fixed inset-0 bg-white z-50 flex items-center justify-center">
                            <div class="text-center p-8">
                                <div class="text-red-500 text-6xl mb-4">⚠️</div>
                                <h2 class="text-xl font-semibold text-gray-800 mb-2">Erro ao Carregar Dados</h2>
                                <p class="text-gray-600 mb-4">Não foi possível carregar o cardápio. Verifique sua conexão.</p>
                                <button onclick="location.reload()" class="bg-red-500 text-white px-6 py-2 rounded-lg hover:bg-red-600 transition-colors">
                                    Tentar Novamente
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', errorHTML);
                }
            }
        }

        // Function to initialize the app after data is loaded
        function initializeApp() {
            renderCategoryNavigation();
            renderMenu();
            setupEventListeners();
            toggleWhatsAppField(); // Show/hide WhatsApp field based on webhook status
            
            // Only detect country by IP if webhook is active (not using WhatsApp Web)
            if (isWebhookActive()) {
                detectCountryByIP(); // Detect country by IP and set default country code
            } else {
                console.log('Skipping IP detection - WhatsApp Web mode active');
            }
        }

        let cart = [];
        let currentProduct = null;
        let currentStep = 1;
        let selectedVariations = {};
        let orderData = {
            deliveryType: '',
            tableNumber: '',
            address: {},
            customerName: '',
            paymentMethod: '',
            changeAmount: '',
            notes: ''
        };

        // Parse variations from classificacaoAdicional
        function parseVariations(classificacaoAdicional) {
            if (!classificacaoAdicional) return null;
            
            // Check if it's a variation (starts with #Var: or Var:)
            const isRequiredVariation = classificacaoAdicional.startsWith('#Var:');
            const isOptionalVariation = classificacaoAdicional.startsWith('Var:') && !isRequiredVariation;
            
            // If it doesn't start with #Var: or Var:, it's just informative text
            if (!isRequiredVariation && !isOptionalVariation) {
                return {
                    type: 'info',
                    text: classificacaoAdicional.trim()
                };
            }
            
            // Extract variations text
            const variationsText = classificacaoAdicional.replace(/^#?Var:\s*/, '');
            
            // Parse individual variations separated by /
            const variations = variationsText.split('/').map(variation => {
                const trimmed = variation.trim();
                
                // Match price pattern +X,XX or +X.XX (without currency symbol)
                const priceMatch = trimmed.match(/\+(\d+(?:[,.]\d{2})?)/);
                
                let name = trimmed;
                let price = 0;
                
                if (priceMatch) {
                    // Remove price from name
                    name = trimmed.replace(/\s*\+\d+(?:[,.]\d{2})?/, '').trim();
                    // Convert price to float (handle both comma and dot)
                    price = parseFloat(priceMatch[1].replace(',', '.'));
                }
                
                return { name, price };
            }).filter(variation => variation.name); // Remove empty variations
            
            return {
                type: 'variation',
                required: isRequiredVariation,
                options: variations
            };
        }



        // Process image URL to handle different sources
        function processImageUrl(url) {
            if (!url || url.trim() === '') {
                console.warn('URL de imagem vazia ou inválida:', url);
                return getPlaceholderImage();
            }
            
            try {
                // Handle Google Drive URLs
                if (url.includes('drive.google.com')) {
                    // If it's already a thumbnail URL, return as is
                    if (url.includes('thumbnail?id=')) {
                        return url;
                    }
                    
                    // Extract file ID from various Google Drive URL formats
                    let fileId = null;
                    
                    // Format: https://drive.google.com/file/d/FILE_ID/view
                    if (url.includes('/file/d/')) {
                        fileId = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/)?.[1];
                    }
                    // Format: https://drive.google.com/open?id=FILE_ID
                    else if (url.includes('open?id=')) {
                        fileId = url.match(/[?&]id=([a-zA-Z0-9_-]+)/)?.[1];
                    }
                    
                    if (fileId) {
                        const processedUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w300`;
                        console.log('URL do Google Drive processada:', url, '->', processedUrl);
                        return processedUrl;
                    } else {
                        console.warn('Não foi possível extrair ID do Google Drive:', url);
                        return getPlaceholderImage();
                    }
                }
                
                // Handle Dropbox URLs
                if (url.includes('dropbox.com')) {
                    let processedUrl = url;
                    // Convert Dropbox share URL to direct image URL
                    if (url.includes('?dl=0')) {
                        processedUrl = url.replace('?dl=0', '?raw=1');
                    }
                    else if (url.includes('?dl=1')) {
                        processedUrl = url.replace('?dl=1', '?raw=1');
                    }
                    else if (!url.includes('raw=1')) {
                        processedUrl = url + (url.includes('?') ? '&raw=1' : '?raw=1');
                    }
                    console.log('URL do Dropbox processada:', url, '->', processedUrl);
                    return processedUrl;
                }
                
                // For other URLs (Unsplash, direct image URLs, etc.), return as is
                console.log('URL externa mantida:', url);
                return url;
                
            } catch (error) {
                console.error('Erro ao processar URL da imagem:', error, 'URL:', url);
                return getPlaceholderImage();
            }
        }
        
        // Generate placeholder image for fallback
        function getPlaceholderImage() {
            return "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='80' viewBox='0 0 120 80'%3E%3Crect width='120' height='80' fill='%23f8f9fa'/%3E%3Ctext x='60' y='45' text-anchor='middle' fill='%23adb5bd' font-family='Arial' font-size='12'%3E🍽️%3C/text%3E%3C/svg%3E";
        }

        // Render category navigation
        function renderCategoryNavigation() {
            const container = document.getElementById('category-nav');
            if (!container || !categoriesData.length) return;

            // Sort categories by order
            const sortedCategories = categoriesData
                .filter(cat => cat.status === 'Ativo')
                .sort((a, b) => parseInt(a.ordem) - parseInt(b.ordem));

            // Add "Todos" button first
            let html = `
                <button class="category-item px-4 py-2 rounded-full text-sm font-medium text-white" 
                        style="background-color: var(--cor-primaria)" 
                        onmouseenter="this.style.backgroundColor='var(--cor-primaria-escura)'" 
                        onmouseleave="this.style.backgroundColor='var(--cor-primaria)'" 
                        data-category="all">
                    Todos
                </button>
            `;

            // Add category buttons
            html += sortedCategories.map(category => `
                <button class="category-item px-4 py-2 rounded-full text-sm font-medium border border-gray-300 transition-colors" 
                        data-category="${category.nome_categoria}">
                    ${category.titulo_exibicao}
                </button>
            `).join('');

            container.innerHTML = html;
            
            // Add event listeners after creating the buttons
            setupCategoryClickListeners();
        }
        
        // Setup click listeners for category buttons
        function setupCategoryClickListeners() {
            const categoryButtons = document.querySelectorAll('.category-item');
            categoryButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const category = this.getAttribute('data-category');
                    scrollToCategory(category);
                });
            });
        }

        // Render menu sections
        function renderMenu() {
            const container = document.getElementById('menu-content');
            if (!container || !isDataLoaded) return;
            
            let html = '';

            // Sort categories by order and render
            const sortedCategories = categoriesData
                .filter(cat => cat.status === 'Ativo')
                .sort((a, b) => parseInt(a.ordem) - parseInt(b.ordem));

            sortedCategories.forEach(categoryInfo => {
                const categoryKey = categoryInfo.nome_categoria;
                const items = menuData[categoryKey] || [];
                
                if (items.length === 0) return;

                html += `
                    <section id="${categoryKey}" class="mb-8">
                        <div class="flex items-center justify-between mb-4 sticky top-[144px] py-2 z-10" style="background:var(--cor-fundo)">
                            <div>
                                <h2 class="text-xl font-bold text-gray-900">${categoryInfo.titulo_exibicao}</h2>
                                <p class="text-sm text-gray-600">${categoryInfo.descricao}</p>
                            </div>
                            <button onclick="shareCategory('${categoryKey}')" class="p-1 rounded transition-colors" style="color: var(--cor-texto)" onmouseenter="this.style.color='var(--cor-terciaria-escura)'" onmouseleave="this.style.color='var(--cor-texto)'" title="Compartilhar categoria">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z"></path>
                                </svg>
                            </button>
                        </div>
                        <div class="space-y-3">
                            ${items.map(item => `
                                <div class="food-card bg-white rounded-lg p-4 shadow-sm border border-gray-100" onclick="openProductModal(${item.id})">
                                    <div class="flex items-center space-x-4">
                                        <div class="flex-shrink-0">
                                            <img src="${processImageUrl(item.imagem)}" alt="${item.nome}" class="w-20 h-20 object-cover rounded-lg lazy-image" loading="lazy" onerror="console.error('Erro ao carregar imagem do item:', this.src, 'Item:', '${item.nome}'); this.src='${getPlaceholderImage()}'" onload="this.classList.add('loaded'); console.log('Imagem do item carregada:', this.src)" style="background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite;">
                                            <div class="text-xs text-gray-500 text-center mt-1 font-mono">${item.sku}</div>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <h3 class="font-semibold text-gray-900 truncate">${item.nome}</h3>
                                            <p class="text-sm text-gray-600 line-clamp-2 mt-1">${item.descricao}</p>
                                            ${item.observacoes ? `<p class="text-xs text-gray-500 mt-1">${item.observacoes}</p>` : ''}
                                            <div class="flex items-center justify-between mt-3">
                                                <span class="text-lg font-bold" style="color: var(--cor-primaria)">${formatCurrency(item.preco)}</span>
                                                <button class="add-to-cart-btn text-white px-3 py-2 rounded-lg text-sm font-medium transition-colors" style="background-color: var(--cor-primaria)" onmouseenter="this.style.backgroundColor='var(--cor-primaria-hover)'" onmouseleave="this.style.backgroundColor='var(--cor-primaria)'" onclick="event.stopPropagation(); addToCart(${item.id})">
                                                    <div class="flex items-center space-x-1">
                                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m1.6 8L6 5H3m4 8a2 2 0 100 4 2 2 0 000-4zm10 0a2 2 0 100 4 2 2 0 000-4z"/>
                                                        </svg>
                                                        <span>Add</span>
                                                    </div>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </section>
                `;
            });

            container.innerHTML = html;
        }

        // Open product modal
        function openProductModal(productId) {
            const product = findProductById(productId);
            if (!product) return;

            currentProduct = product;
            selectedVariations = {};
            const modal = document.getElementById('product-modal');
            
            // Hide cart FAB when modal opens
            document.getElementById('cart-fab').style.display = 'none';
            const content = document.getElementById('modal-content');
            
            const variations = parseVariations(product.classificacaoAdicional);
            let variationsHtml = '';
            
            if (variations) {
                if (variations.type === 'variation') {
                    // Handle variations (required or optional)
                    const inputType = variations.required ? 'radio' : 'checkbox';
                    const requiredText = variations.required ? ' *' : '';
                    
                    variationsHtml = `
                        <div class="mb-6 border-t pt-4">
                            <h4 class="font-medium text-gray-900 mb-3">Opções${requiredText}</h4>
                            <div class="space-y-2">
                                ${variations.options.map((option, index) => `
                                    <label class="flex items-center justify-between p-3 border rounded-lg cursor-pointer hover:bg-gray-50">
                                        <div class="flex items-center">
                                            <input type="${inputType}" name="variation-${productId}" value="${index}" 
                                                   onchange="handleVariationChange(${index}, '${option.name}', ${option.price}, ${variations.required})" 
                                                   class="mr-3">
                                            <span>${option.name}</span>
                                        </div>
                                        ${option.price > 0 ? `<span class="text-green-600 font-medium">+${formatCurrency(option.price)}</span>` : ''}
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else if (variations.type === 'info') {
                    // Handle informative text
                    variationsHtml = `
                        <div class="mb-6 border-t pt-4">
                            <div class="bg-blue-50 border border-blue-200 rounded-lg p-3">
                                <div class="flex items-start">
                                    <svg class="w-5 h-5 mt-0.5 mr-2 flex-shrink-0" style="color: var(--cor-terciaria)" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                    </svg>
                                    <p class="text-sm text-blue-800">${variations.text}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }

            content.innerHTML = `
                <div class="relative">
                    <img src="${processImageUrl(product.imagem)}" alt="${product.nome}" class="w-full h-64 object-cover rounded-t-2xl sm:rounded-t-2xl cursor-pointer hover:opacity-90 transition-opacity lazy-image" loading="lazy" onerror="console.error('Erro ao carregar imagem do modal:', this.src, 'Produto:', '${product.nome}'); this.src='${getPlaceholderImage()}'" onload="this.classList.add('loaded'); console.log('Imagem do modal carregada:', this.src)" onclick="openLightbox('${processImageUrl(product.imagem)}', '${product.nome}')" style="background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: shimmer 1.5s infinite;">
                    <div class="absolute bottom-2 left-2 bg-black bg-opacity-70 text-white px-2 py-1 rounded text-xs font-mono">
                        ${product.sku}
                    </div>

                </div>
                <div class="px-6 pt-6 pb-4">
                    <h3 class="text-xl font-bold text-gray-900 mb-2">${product.nome}</h3>
                    <p class="text-gray-600 mb-4">${product.descricao}</p>
                    <div class="flex items-center justify-between mb-6">
                        <span class="text-2xl font-bold" style="color: var(--cor-primaria)"><span id="base-price">${formatCurrency(product.preco)}</span></span>
                    </div>
                    ${variationsHtml}
                    ${(() => {
                        const checkoutConfig = getCheckoutConfig();
                        return checkoutConfig.step1_itens_obs === 'Sim' ? `
                    <div class="mb-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Observações</label>
                        <textarea id="product-notes" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:border-transparent" style="--tw-ring-color: var(--cor-primaria)" rows="2" placeholder="Alguma observação especial para este item?" onfocus="scrollToField(this)" onblur="resetModalScroll()"></textarea>
                    </div>` : '';
                    })()}
                </div>
                <div class="modal-footer">
                    <div class="modal-footer-grid">
                        <!-- Coluna 1: Quantidade e Subtotal (50%) -->
                        <div class="space-y-2">
                            <div class="text-center">
                                <div class="text-sm font-medium text-gray-700 mb-1">Quantidade</div>
                                <div class="flex items-center justify-center space-x-2">
                                    <button onclick="changeQuantity(-1)" class="quantity-btn bg-gray-200 hover:bg-gray-300 rounded-full w-7 h-7 flex items-center justify-center text-base font-bold">-</button>
                                    <span id="modal-quantity" class="font-bold text-lg min-w-[20px] text-center">1</span>
                                    <button onclick="changeQuantity(1)" class="quantity-btn bg-gray-200 hover:bg-gray-300 rounded-full w-7 h-7 flex items-center justify-center text-base font-bold">+</button>
                                </div>
                            </div>
                            <div class="text-center">
                                <div class="text-xs text-gray-500">Subtotal</div>
                                <div class="font-bold text-sm" style="color: var(--cor-primaria)"><span id="modal-total">${formatCurrency(product.preco)}</span></div>
                            </div>
                        </div>
                        
                        <!-- Coluna 2: Botão Adicionar (50%) -->
                        <div>
                            <button onclick="addToCartFromModal()" id="add-to-cart-btn" class="text-white py-2 px-6 rounded-lg font-medium transition-colors text-sm" style="background-color: var(--cor-primaria)" onmouseenter="this.style.backgroundColor='var(--cor-primaria-hover)'" onmouseleave="this.style.backgroundColor='var(--cor-primaria)'">
                                <div class="flex items-center justify-center space-x-1">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4m1.6 8L6 5H3m4 8a2 2 0 100 4 2 2 0 000-4zm10 0a2 2 0 100 4 2 2 0 000-4z"/>
                                    </svg>
                                    <span>Adicionar</span>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            `;

            modal.classList.remove('hidden');
            updateAddToCartButton();
        }

        // Handle variation change
        function handleVariationChange(index, name, price, isRequired) {
            console.log('🔧 handleVariationChange chamada:', { index, name, price, isRequired });
            
            const variations = parseVariations(currentProduct.classificacaoAdicional);
            
            if (isRequired) {
                // Radio button - single selection
                selectedVariations = { [index]: { name, price } };
                console.log('🔘 Variação obrigatória selecionada:', selectedVariations);
            } else {
                // Checkbox - multiple selection
                const checkbox = event.target;
                if (checkbox.checked) {
                    selectedVariations[index] = { name, price };
                    console.log('✅ Variação opcional marcada:', selectedVariations);
                } else {
                    delete selectedVariations[index];
                    console.log('❌ Variação opcional desmarcada:', selectedVariations);
                }
            }
            
            updateModalPricing();
            updateAddToCartButton();
        }

        // Update modal pricing
        function updateModalPricing() {
            const basePrice = currentProduct.preco;
            const variationPrice = Object.values(selectedVariations).reduce((sum, variation) => sum + variation.price, 0);
            const totalPrice = basePrice + variationPrice;
            const quantity = parseInt(document.getElementById('modal-quantity').textContent);
            
            document.getElementById('modal-total').textContent = formatCurrency(totalPrice * quantity);
        }

        // Update add to cart button
        function updateAddToCartButton() {
            const variations = parseVariations(currentProduct.classificacaoAdicional);
            const button = document.getElementById('add-to-cart-btn');
            
            if (variations && variations.type === 'variation' && variations.required) {
                const hasSelection = Object.keys(selectedVariations).length > 0;
                button.disabled = !hasSelection;
                button.classList.toggle('opacity-50', !hasSelection);
                button.classList.toggle('cursor-not-allowed', !hasSelection);
            } else {
                button.disabled = false;
                button.classList.remove('opacity-50', 'cursor-not-allowed');
            }
        }

        // Close modal
        function closeModal(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('product-modal').classList.add('hidden');
            currentProduct = null;
            selectedVariations = {};
            
            // Clear product notes field
            const notesField = document.getElementById('product-notes');
            if (notesField) {
                notesField.value = '';
            }
            
            // Show cart FAB again when modal closes (if cart has items)
            const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            if (cartCount > 0) {
                document.getElementById('cart-fab').style.display = 'flex';
            }
        }

        // Change quantity in modal
        function changeQuantity(delta) {
            const quantityEl = document.getElementById('modal-quantity');
            let quantity = parseInt(quantityEl.textContent) + delta;
            
            if (quantity < 1) quantity = 1;
            
            quantityEl.textContent = quantity;
            updateModalPricing();
        }

        // Add to cart from modal
        function addToCartFromModal() {
            console.log('=== INÍCIO addToCartFromModal ===');
            
            // Verificar estado do botão
            const button = document.getElementById('add-to-cart-btn');
            console.log('🔘 Estado do botão:', {
                disabled: button.disabled,
                classList: Array.from(button.classList),
                style: button.style.cssText
            });
            
            console.log('🛒 addToCartFromModal chamada');
            console.log('📦 Produto atual:', currentProduct);
            console.log('🔧 Variações selecionadas:', selectedVariations);
            
            const variations = parseVariations(currentProduct.classificacaoAdicional);
            console.log('📋 Variações parseadas:', variations);
            
            // Check if required variations are selected
            console.log('🔍 Verificando variações obrigatórias...');
            console.log('- variations existe?', !!variations);
            console.log('- variations.required?', variations ? variations.required : 'N/A');
            console.log('- selectedVariations vazio?', Object.keys(selectedVariations).length === 0);
            
            if (variations && variations.required && Object.keys(selectedVariations).length === 0) {
                console.log('❌ Variação obrigatória não selecionada - BLOQUEANDO!');
                showCustomAlert('Por favor, selecione uma opção obrigatória');
                return;
            }
            
            console.log('✅ Verificação de variações obrigatórias passou!');
            
            const quantity = parseInt(document.getElementById('modal-quantity').textContent);
            const notesElement = document.getElementById('product-notes');
            const notes = notesElement ? notesElement.value.trim() : '';
            
            console.log('📊 Quantidade:', quantity);
            console.log('📝 Observações:', notes);
            console.log('✅ Chamando addToCart...');
            
            addToCart(currentProduct.id, quantity, selectedVariations, notes, true); // true = chamada do modal
            closeModal();
        }

        // Add to cart
        function addToCart(productId, quantity = 1, variations = {}, notes = '', fromModal = false) {
            console.log('🛒 addToCart chamada com:', { productId, quantity, variations, notes, fromModal });
            
            const product = findProductById(productId);
            if (!product) {
                console.log('❌ Produto não encontrado:', productId);
                return;
            }
            
            console.log('📦 Produto encontrado:', product);

            // Check if product has ANY variations (required or optional) and none are provided
            const productVariations = parseVariations(product.classificacaoAdicional);
            console.log('🔍 Variações do produto:', productVariations);
            
            if (productVariations && productVariations.type === 'variation') {
                // If no variations provided for a product with variations, open modal to show options
                // BUT only if the call is NOT from the modal itself
                if (Object.keys(variations).length === 0 && !fromModal) {
                    console.log('🔄 Abrindo modal - produto tem variações mas nenhuma foi fornecida');
                    openProductModal(productId);
                    return;
                } else if (fromModal) {
                    console.log('📝 Chamada do modal - prosseguindo mesmo sem variações selecionadas');
                }
            }
            
            console.log('✅ Prosseguindo para adicionar ao carrinho...');

            // Calculate variation price
            const variationPrice = Object.values(variations).reduce((sum, variation) => sum + variation.price, 0);
            const totalPrice = product.preco + variationPrice;
            
            // Create variation key for grouping similar items (include notes in key if present)
            const variationKey = Object.keys(variations).sort().join('-');
            const notesKey = notes ? `-notes-${btoa(notes).replace(/[^a-zA-Z0-9]/g, '')}` : '';
            const itemKey = `${productId}-${variationKey}${notesKey}`;
            
            const existingItem = cart.find(item => item.itemKey === itemKey);
            
            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                const variationNames = Object.values(variations).map(v => v.name);
                cart.push({
                    ...product,
                    itemKey: itemKey,
                    quantity: quantity,
                    preco: totalPrice,
                    variations: variations,
                    variationText: variationNames.length > 0 ? variationNames.join(', ') : '',
                    notes: notes
                });
            }
            
            console.log('🎉 Produto adicionado ao carrinho!');
            console.log('🛒 Carrinho atual:', cart);

            updateCartUI();
            showAddedToCartAnimation();
        }

        // Update cart UI
        function updateCartUI() {
            const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            const cartTotal = cart.reduce((sum, item) => sum + (item.preco * item.quantity), 0);
            
            document.getElementById('cart-count').textContent = cartCount;
            document.getElementById('cart-total').textContent = formatCurrency(cartTotal);
            document.getElementById('cart-modal-total').textContent = formatCurrency(cartTotal);
            
            // Check if checkout is enabled
            const checkoutConfig = getCheckoutConfig();
            const isCheckoutEnabled = checkoutConfig.checkout_mode && checkoutConfig.checkout_mode.toLowerCase() === 'sim';
            
            const cartFab = document.getElementById('cart-fab');
            if (cartCount > 0 && isCheckoutEnabled) {
                cartFab.classList.remove('hidden');
                // Only show if no modals are open
                const isModalOpen = !document.getElementById('product-modal').classList.contains('hidden') ||
                                   !document.getElementById('cart-modal').classList.contains('hidden') ||
                                   !document.getElementById('checkout-modal').classList.contains('hidden');
                cartFab.style.display = isModalOpen ? 'none' : 'flex';
            } else {
                cartFab.classList.add('hidden');
                cartFab.style.display = 'none';
            }
        }

        // Show added to cart animation
        function showAddedToCartAnimation() {
            const cartFab = document.getElementById('cart-fab');
            cartFab.classList.add('bounce');
            setTimeout(() => cartFab.classList.remove('bounce'), 600);
        }

        // Open cart
        function openCart() {
            const modal = document.getElementById('cart-modal');
            const itemsContainer = document.getElementById('cart-items');
            
            // Hide cart FAB when cart modal opens
            document.getElementById('cart-fab').style.display = 'none';
            
            if (cart.length === 0) {
                itemsContainer.innerHTML = '<p class="text-gray-500 text-center py-8">Seu carrinho está vazio</p>';
            } else {
                itemsContainer.innerHTML = cart.map(item => {
                    const itemSubtotal = item.preco * item.quantity;
                    return `
                    <div class="relative flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center space-x-3 flex-1">
                            <div class="relative">
                                <img src="${processImageUrl(item.imagem)}" alt="${item.nome}" class="w-12 h-10 object-cover rounded cursor-pointer flex-shrink-0" onerror="this.src='${getPlaceholderImage()}'" onclick="openImageLightbox('${processImageUrl(item.imagem)}', '${item.nome}')">
                                ${(() => {
                                    const checkoutConfig = getCheckoutConfig();
                                    return checkoutConfig.step1_itens_obs === 'Sim' ? `
                                <button onclick="editItemNotes('${item.itemKey}')" class="absolute -top-2 -left-2 bg-blue-500 hover:bg-blue-600 text-white rounded-full w-6 h-6 flex items-center justify-center shadow-lg transition-all hover:scale-110 z-10" title="Editar observações">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                    </svg>
                                </button>` : '';
                                })()}
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="text-xs text-gray-400 font-mono" style="font-size: 10px; margin-bottom: 2px;">${item.sku}</div>
                                <h4 class="font-medium text-sm">${item.nome}</h4>
                                ${item.variationText ? `<p class="text-xs text-gray-600">${item.variationText}</p>` : ''}
                                ${item.notes ? `<p class="text-xs italic" style="color: var(--cor-terciaria)">Obs: ${item.notes}</p>` : ''}
                                <div class="flex items-center justify-between mt-1">
                                    <p class="text-gray-600 text-xs">${formatCurrency(item.preco)} cada</p>
                                    <p class="font-bold text-sm" style="color: var(--cor-primaria)">${formatCurrency(itemSubtotal)}</p>
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center space-x-2 flex-shrink-0">
                            <button onclick="updateCartQuantity('${item.itemKey}', -1)" class="bg-gray-200 hover:bg-gray-300 rounded-full w-6 h-6 flex items-center justify-center text-sm">-</button>
                            <span class="font-bold">${item.quantity}</span>
                            <button onclick="updateCartQuantity('${item.itemKey}', 1)" class="bg-gray-200 hover:bg-gray-300 rounded-full w-6 h-6 flex items-center justify-center text-sm">+</button>
                        </div>
                    </div>
                `;
                }).join('');
            }
            
            modal.classList.remove('hidden');
        }

        // Close cart
        function closeCart(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('cart-modal').classList.add('hidden');
            
            // Show cart FAB again when cart modal closes (if cart has items and checkout is enabled)
            const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            const checkoutConfig = getCheckoutConfig();
            const isCheckoutEnabled = checkoutConfig.checkout_mode && checkoutConfig.checkout_mode.toLowerCase() === 'sim';
            
            if (cartCount > 0 && isCheckoutEnabled) {
                document.getElementById('cart-fab').style.display = 'flex';
            }
        }

        // Reset Step 2 - Limpa completamente o estado do step 2
        function resetStep2() {
            console.log('=== RESET STEP 2 ===');
            
            // 1. Desmarcar todos os radio buttons de tipo de entrega
            const deliveryRadios = document.querySelectorAll('input[name="delivery-type"]');
            deliveryRadios.forEach(radio => {
                radio.checked = false;
            });
            
            // 2. Limpar o orderData.deliveryType
            orderData.deliveryType = '';
            
            // 3. Limpar campos dinâmicos
            const fieldsContainer = document.getElementById('delivery-fields');
            if (fieldsContainer) {
                fieldsContainer.innerHTML = '';
            }
            
            // 4. Ocultar campos de endereço
            const addressFields = document.getElementById('address-fields');
            if (addressFields) {
                addressFields.classList.add('hidden');
            }
            
            // 5. Limpar taxa de delivery
            clearDeliveryFee();
            
            // 6. Manter botão continuar habilitado para validação
            const continueBtn = document.getElementById('step2-continue');
            if (continueBtn) {
                continueBtn.disabled = false; // Manter habilitado para mostrar erro de validação
            }
            
            // 7. Mostrar todas as opções de delivery
            showAllDeliveryOptions();
            
            // 8. Ocultar botão "outras opções"
            hideOtherOptionsButton();
            
            // 9. Reset modo endereço manual - sempre voltar para modo CEP
            const cepContainer = document.getElementById('cep-mode-container');
            const manualContainer = document.getElementById('manual-address-container');
            if (cepContainer && manualContainer) {
                cepContainer.classList.remove('hidden');
                manualContainer.classList.add('hidden');
                clearManualAddressFields();
            }
            
            // 10. Limpar timeout de busca por bairro
            if (typeof neighborhoodSearchTimeout !== 'undefined' && neighborhoodSearchTimeout) {
                clearTimeout(neighborhoodSearchTimeout);
                neighborhoodSearchTimeout = null;
                console.log('Timeout de busca limpo');
            }
            
            console.log('Step 2 resetado completamente');
        }

        // Proceed to checkout
        function proceedToCheckout() {
            if (cart.length === 0) return;
            
            closeCart();
            currentStep = 2;
            showStep(2);
            document.getElementById('checkout-modal').classList.remove('hidden');
            
            // RESET COMPLETO DO STEP 2 antes de configurar
            resetStep2();
            
            // Setup delivery options based on configuration
            setupDeliveryOptions();
            
            // ===== AUTOMAÇÃO MESA URL =====
            // Verificar se há parâmetro mesa na URL e automatizar
            const mesaAutomatizada = autoMesaCheckout();
            if (mesaAutomatizada) {
                console.log('🪑 Checkout automatizado para mesa URL');
            }
            
            // Setup payment methods based on configuration
            setupPaymentMethods();
            
            // Hide cart FAB during checkout
            document.getElementById('cart-fab').style.display = 'none';
        }
        
        // Setup payment methods based on configuration
        function setupPaymentMethods() {
            const checkoutConfig = getCheckoutConfig();
            const paymentContainer = document.querySelector('#payment-method').parentElement;
            
            console.log('🔍 DEBUG setupPaymentMethods:', {
                step3_show_formas_pag: checkoutConfig.step3_show_formas_pag,
                deliveryType: orderData.deliveryType
            });
            
            // Check if payment methods should be shown
            if (checkoutConfig.step3_show_formas_pag !== 'Sim') {
                console.log('❌ Payment field HIDDEN - step3_show_formas_pag !== Sim');
                paymentContainer.style.display = 'none';
                return;
            }
            
            // Define delivery types that should show payment methods
            const deliveryTypesWithPayment = ['pickup', 'delivery', 'default'];
            
            // Show payment field only for specific delivery types (pickup, delivery, default)
            if (deliveryTypesWithPayment.includes(orderData.deliveryType)) {
                console.log('✅ Payment field SHOWN - deliveryType:', orderData.deliveryType);
                paymentContainer.style.display = 'block';
            } else {
                console.log('❌ Payment field HIDDEN - deliveryType not allowed:', orderData.deliveryType);
                paymentContainer.style.display = 'none';
                return;
            }
            
            // Get payment methods from configuration
            const paymentMethods = checkoutConfig.step3_formas_pag;
            console.log('📝 Payment methods from config:', paymentMethods);
            
            if (paymentMethods && paymentMethods.trim() !== '') {
                // Parse payment methods from configuration
                const methodsList = paymentMethods.split(',').map(method => method.trim());
                console.log('📋 Methods list:', methodsList);
                const paymentSelect = document.getElementById('payment-method');
                
                // Clear existing options except the first one ("Selecione...")
                paymentSelect.innerHTML = '<option value="">Selecione...</option>';
                
                // Add payment methods from configuration
                methodsList.forEach(method => {
                    const option = document.createElement('option');
                    
                    // Use payment method name as is from spreadsheet
                    option.value = method.toLowerCase().replace(/\s+/g, '-');
                    
                    // Add emoji based on method name
                    let emoji = '💳'; // Default credit card emoji
                    if (method.toLowerCase().includes('dinheiro')) {
                        emoji = '💵';
                    } else if (method.toLowerCase().includes('pix')) {
                        emoji = '📱';
                    } else if (method.toLowerCase().includes('cartão') || method.toLowerCase().includes('cartao')) {
                        emoji = '💳';
                    } else if (method.toLowerCase().includes('alelo') || method.toLowerCase().includes('vale') || method.toLowerCase().includes('ticket')) {
                        emoji = '🎫'; // Simpler ticket emoji
                    }
                    
                    option.textContent = `${emoji} ${method}`;
                    console.log('✅ Created option:', option.value, '=', option.textContent);
                    
                    paymentSelect.appendChild(option);
                });
            } else {
                // Use default payment methods if none configured
                const paymentSelect = document.getElementById('payment-method');
                paymentSelect.innerHTML = `
                    <option value="">Selecione...</option>
                    <option value="dinheiro">Dinheiro</option>
                    <option value="pix">PIX</option>
                    <option value="cartao-debito">Cartão de Débito</option>
                    <option value="cartao-credito">Cartão de Crédito</option>
                `;
            }
        }

        // Close checkout
        function closeCheckout(event) {
            if (event && event.target !== event.currentTarget) return;
            document.getElementById('checkout-modal').classList.add('hidden');
            currentStep = 2;
            
            // Show cart FAB again when checkout closes (if cart has items and checkout is enabled)
            const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            const checkoutConfig = getCheckoutConfig();
            const isCheckoutEnabled = checkoutConfig.checkout_mode && checkoutConfig.checkout_mode.toLowerCase() === 'sim';
            
            if (cartCount > 0 && isCheckoutEnabled) {
                document.getElementById('cart-fab').style.display = 'flex';
            }
        }
        
        // Back to cart from checkout
        function backToCart() {
            // Fechar checkout
            document.getElementById('checkout-modal').classList.add('hidden');
            currentStep = 2;
            
            // Abrir carrinho
            setTimeout(() => {
                openCart();
            }, 100);
        }

        // Show specific step
        function showStep(step) {
            document.querySelectorAll('.checkout-step').forEach(el => el.classList.add('hidden'));
            document.getElementById(`checkout-step-${step}`).classList.remove('hidden');
            currentStep = step;
            
            // Atualizar total do pedido no Step 3
            if (step === 3) {
                updateCheckoutOrderTotal();
            }
        }

        // Next step with enhanced validation
        function nextStep(step) {
            if (step === 3) {
                if (!validateStep2Enhanced()) {
                    return;
                }
                showStep(step);
            } else {
                showStep(step);
            }
        }
        
        // Enhanced Step 2 validation - validates all required fields
        function validateStep2Enhanced() {
            const deliveryType = document.querySelector('input[name="delivery-type"]:checked')?.value;
            
            // Clear any existing errors first
            clearAllFieldErrors();
            
            if (!deliveryType) {
                showToast('Por favor, selecione o tipo de recebimento', 'warning');
                return false;
            }
            
            // Update orderData with current selection
            orderData.deliveryType = deliveryType;
            
            let hasErrors = false;
            
            // Validate specific fields based on delivery type
            if (deliveryType === 'local') {
                // Check if mesa/comanda field should be validated based on configuration
                const checkoutConfig = getCheckoutConfig();
                const shouldShowMesaComanda = checkoutConfig.step3_mesa_comanda === 'Sim';
                
                if (shouldShowMesaComanda) {
                    const tableNumber = document.getElementById('table-number')?.value.trim();
                    if (!tableNumber) {
                        showFieldError('table-number', 'Informe o número da mesa ou comanda');
                        hasErrors = true;
                    } else {
                        orderData.tableNumber = tableNumber;
                    }
                } else {
                    // If mesa/comanda is not required, clear any existing table number
                    orderData.tableNumber = '';
                }
            } else if (deliveryType === 'delivery') {
                // Verificar se está no modo CEP ou modo manual
                const cepContainer = document.getElementById('cep-mode-container');
                const manualContainer = document.getElementById('manual-address-container');
                const isManualMode = manualContainer && !manualContainer.classList.contains('hidden');
                
                if (isManualMode) {
                    // Validação modo manual
                    const street = document.getElementById('manual-street')?.value.trim();
                    const number = document.getElementById('manual-number')?.value.trim();
                    const neighborhood = document.getElementById('manual-neighborhood')?.value.trim();
                    const city = document.getElementById('manual-city')?.value.trim();
                    
                    // Validar campos obrigatórios do modo manual
                    if (!street) {
                        showFieldError('manual-street', 'Endereço é obrigatório');
                        hasErrors = true;
                    }
                    if (!number) {
                        showFieldError('manual-number', 'Número é obrigatório');
                        hasErrors = true;
                    }
                    if (!neighborhood) {
                        showFieldError('manual-neighborhood', 'Bairro é obrigatório');
                        hasErrors = true;
                    }
                    if (!city) {
                        showFieldError('manual-city', 'Cidade é obrigatória');
                        hasErrors = true;
                    }
                    
                    // Se não há erros, garantir que orderData está atualizado
                    if (!hasErrors) {
                        updateManualAddressData();
                    }
                    
                } else {
                    // Validação modo CEP (original)
                    const cep = document.getElementById('cep')?.value.replace(/\D/g, '');
                    const number = document.getElementById('number')?.value.trim();
                    
                    // Validate CEP
                    if (!cep || cep.length !== 8) {
                        showFieldError('cep', cep ? 'CEP deve ter 8 dígitos' : 'CEP é obrigatório');
                        document.getElementById('cep').focus();
                        hasErrors = true;
                    }
                    
                    // Validate if address was loaded
                    if (cep && cep.length === 8 && !orderData.address) {
                        showFieldError('cep', 'Por favor, aguarde o carregamento do endereço ou verifique o CEP');
                        hasErrors = true;
                    }
                    
                    // Validate number field
                    if (!number) {
                        showFieldError('number', 'Número do endereço é obrigatório');
                        hasErrors = true;
                    }
                    
                    // If no errors, update orderData
                    if (!hasErrors && orderData.address) {
                        orderData.address.number = number;
                        if (document.getElementById('complement')?.value) {
                            orderData.address.complement = document.getElementById('complement').value;
                        }
                    }
                }
            }
            
            // Show error toast if there are validation errors
            if (hasErrors) {
                showToast('Por favor, preencha todos os campos obrigatórios', 'error');
                return false;
            }
            
            return true;
        }
        
        // Clear all field errors
        function clearAllFieldErrors() {
            const errorFields = [
                'table-number', 'cep', 'number',
                'manual-street', 'manual-number', 'manual-neighborhood', 'manual-city'
            ];
            errorFields.forEach(fieldId => {
                clearFieldError(fieldId);
            });
        }

        // Previous step
        function prevStep(step) {
            showStep(step);
        }



        // Update cart quantity
        function updateCartQuantity(itemKey, delta) {
            const item = cart.find(item => item.itemKey === itemKey);
            if (!item) return;
            
            item.quantity += delta;
            
            if (item.quantity <= 0) {
                cart = cart.filter(item => item.itemKey !== itemKey);
            }
            
            updateCartUI();
            
            // Refresh current view
            if (document.getElementById('cart-modal').classList.contains('hidden') === false) {
                openCart(); // Refresh cart display
            }
        }

        // Open image lightbox
        function openImageLightbox(imageSrc, itemName) {
            const lightbox = document.getElementById('image-lightbox');
            const lightboxImage = document.getElementById('lightbox-image');
            const lightboxTitle = document.getElementById('lightbox-title');
            
            lightboxImage.src = imageSrc;
            lightboxImage.alt = itemName;
            lightboxTitle.textContent = itemName;
            
            lightbox.classList.remove('hidden');
            document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
        
        // Close image lightbox
        function closeLightbox(event) {
            if (event && event.target !== event.currentTarget && !event.target.closest('button')) return;
            
            const lightbox = document.getElementById('image-lightbox');
            lightbox.classList.add('hidden');
            document.body.style.overflow = ''; // Restore scrolling
        }

        // Edit item notes
        let currentEditingItemKey = null;
        
        function editItemNotes(itemKey) {
            const item = cart.find(item => item.itemKey === itemKey);
            if (!item) return;
            
            currentEditingItemKey = itemKey;
            
            // Populate item info
            const itemInfoDiv = document.getElementById('edit-item-info');
            itemInfoDiv.innerHTML = `
                <div class="flex items-center space-x-3">
                    <div class="relative">
                        <img src="${processImageUrl(item.imagem)}" alt="${item.nome}" class="w-12 h-10 object-cover rounded" onerror="this.src='${getPlaceholderImage()}'">
                    </div>
                    <div class="flex-1">
                        <div class="text-xs text-gray-400 font-mono" style="font-size: 10px; margin-bottom: 2px;">${item.sku}</div>
                        <h4 class="font-medium text-sm">${item.nome}</h4>
                        ${item.variationText ? `<p class="text-xs text-gray-600">${item.variationText}</p>` : ''}
                        <p class="text-xs text-gray-500">Quantidade: ${item.quantity}x</p>
                    </div>
                </div>
            `;
            
            // Set current notes
            document.getElementById('edit-item-notes').value = item.notes || '';
            
            // Hide cart FAB and show modal
            document.getElementById('cart-fab').style.display = 'none';
            document.getElementById('edit-notes-modal').classList.remove('hidden');
            
            // Focus on textarea
            setTimeout(() => {
                document.getElementById('edit-item-notes').focus();
            }, 300);
        }
        
        function saveItemNotes() {
            if (!currentEditingItemKey) return;
            
            const item = cart.find(item => item.itemKey === currentEditingItemKey);
            if (!item) return;
            
            const newNotes = document.getElementById('edit-item-notes').value.trim();
            
            // If notes changed, we need to update the item
            if (item.notes !== newNotes) {
                // Remove old item
                cart = cart.filter(item => item.itemKey !== currentEditingItemKey);
                
                // Create new item key if notes changed (for proper grouping)
                const baseKey = currentEditingItemKey.replace(/-notes-[^-]*$/, '');
                const notesKey = newNotes ? `-notes-${btoa(newNotes).replace(/[^a-zA-Z0-9]/g, '')}` : '';
                const newItemKey = `${baseKey}${notesKey}`;
                
                // Check if item with same key already exists
                const existingItem = cart.find(existingItem => existingItem.itemKey === newItemKey);
                
                if (existingItem) {
                    // Merge quantities
                    existingItem.quantity += item.quantity;
                } else {
                    // Add updated item
                    item.itemKey = newItemKey;
                    item.notes = newNotes;
                    cart.push(item);
                }
            }
            
            updateCartUI();
            closeEditNotes();
            
            // Refresh cart display if it's open
            if (!document.getElementById('cart-modal').classList.contains('hidden')) {
                openCart();
            }
            
            showToast('Observações atualizadas com sucesso!', 'success', 2000);
        }
        
        function closeEditNotes(event) {
            if (event && event.target !== event.currentTarget) return;
            
            document.getElementById('edit-notes-modal').classList.add('hidden');
            currentEditingItemKey = null;
            
            // Show cart FAB again if cart has items
            const cartCount = cart.reduce((sum, item) => sum + item.quantity, 0);
            if (cartCount > 0) {
                document.getElementById('cart-fab').style.display = 'flex';
            }
        }

        // Handle delivery type change
        function handleDeliveryTypeChange() {
            const selectedType = document.querySelector('input[name="delivery-type"]:checked')?.value;
            const fieldsContainer = document.getElementById('delivery-fields');
            const continueBtn = document.getElementById('step2-continue');
            
            // Limpar taxa de delivery ao trocar tipo de entrega
            clearDeliveryFee();
            
            orderData.deliveryType = selectedType;
            
            if (!selectedType) {
                continueBtn.disabled = false; // Manter habilitado para mostrar erro de validação
                fieldsContainer.innerHTML = '';
                showAllDeliveryOptions();
                hideOtherOptionsButton();
                // Reset payment methods when no delivery type is selected
                setupPaymentMethods();
                return;
            }
            
            // Update payment methods visibility based on delivery type
            setupPaymentMethods();
            
            // Hide other options and show the "Mostrar outras opções" button
            hideOtherDeliveryOptions(selectedType);
            showOtherOptionsButton();
            
            continueBtn.disabled = false;
            
            switch(selectedType) {
                case 'local':
                    // Check if mesa/comanda field should be shown based on configuration
                    const checkoutConfig = getCheckoutConfig();
                    const shouldShowMesaComanda = checkoutConfig.step3_mesa_comanda === 'Sim';
                    
                    if (shouldShowMesaComanda) {
                        fieldsContainer.innerHTML = `
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Número da Mesa/Comanda *</label>
                                <input type="tel" id="table-number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Ex: Mesa 5 ou Comanda 123" oninput="clearFieldError('table-number')" onchange="updateContinueButton()" onblur="updateContinueButton()" inputmode="numeric">
                            </div>
                        `;
                        continueBtn.disabled = true;
                        
                        // Foco automático no campo de mesa após renderização
                        setTimeout(() => {
                            const tableNumberField = document.getElementById('table-number');
                            if (tableNumberField) {
                                // Primeiro tenta preencher automaticamente da URL
                                const preenchido = preencheMesaAutomatica();
                                // Se não preencheu automaticamente, foca no campo
                                if (!preenchido) {
                                    tableNumberField.focus();
                                }
                            }
                        }, 100);
                    } else {
                        // If mesa/comanda is not required, just clear the fields and enable continue
                        fieldsContainer.innerHTML = '';
                        continueBtn.disabled = false;
                    }
                    break;
                    
                case 'delivery':
                    // Get delivery fee message from configuration
                    const checkoutConfigDelivery = getCheckoutConfig();
                    const deliveryFeeMessage = checkoutConfigDelivery.step2_taxa_delivery || 'Consulte taxa de entrega pelo WhatsApp com nosso atendente';
                    
                    fieldsContainer.innerHTML = `
                        <div class="space-y-4">
                            <!-- Delivery Fee Alert - Oculto inicialmente, aparece apenas se bairro não for encontrado -->
                            <div id="original-delivery-fee-alert" class="bg-amber-50 border border-amber-200 rounded-lg p-4 mb-4" style="display: none;">
                                <div class="flex items-start space-x-3">
                                    <div class="flex-shrink-0">
                                        <svg class="w-5 h-5 text-amber-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                                        </svg>
                                    </div>
                                    <div class="flex-1">
                                        <h4 class="text-sm font-medium text-amber-800 mb-1">Consulte a Taxa de Entrega</h4>
                                        <p class="text-sm text-amber-700">${deliveryFeeMessage}</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Modo CEP (Padrão) -->
                            <div id="cep-mode-container">
                                <div class="flex items-center justify-between mb-2">
                                    <label class="block text-sm font-medium text-gray-700">CEP *</label>
                                    <button type="button" onclick="toggleAddressMode()" class="text-sm text-blue-600 hover:text-blue-800 underline transition-colors duration-200">
                                        Não sei meu CEP
                                    </button>
                                </div>
                                <input type="tel" id="cep" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="00000-000" oninput="clearFieldError('cep'); handleCepInput();" onchange="fetchAddress(); updateContinueButton();" onblur="updateContinueButton();" maxlength="9" inputmode="numeric">
                            </div>

                            <!-- Modo Endereço Manual (Oculto inicialmente) -->
                            <div id="manual-address-container" class="hidden space-y-4">
                                <div class="flex items-center justify-between mb-2">
                                    <label class="block text-sm font-medium text-gray-700">Endereço Manual</label>
                                    <button type="button" onclick="toggleAddressMode()" class="text-sm text-blue-600 hover:text-blue-800 underline transition-colors duration-200">
                                        Usar meu CEP
                                    </button>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Endereço Completo *</label>
                                    <input type="text" id="manual-street" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Rua das Flores, 123" oninput="updateManualAddressData(); clearFieldError('manual-street');" onchange="updateContinueButton();" onblur="updateContinueButton();">
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Número *</label>
                                        <input type="text" id="manual-number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="123" oninput="updateManualAddressData(); clearFieldError('manual-number');" onchange="updateContinueButton();" onblur="updateContinueButton();">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Complemento</label>
                                        <input type="text" id="manual-complement" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Apto 45" oninput="updateManualAddressData();">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Bairro *</label>
                                        <input type="text" id="manual-neighborhood" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Centro" oninput="updateManualAddressData(); searchNeighborhoodFee(); clearFieldError('manual-neighborhood');" onchange="updateContinueButton();" onblur="updateContinueButton();">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cidade *</label>
                                        <input type="text" id="manual-city" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="São Paulo" oninput="updateManualAddressData(); clearFieldError('manual-city');" onchange="updateContinueButton();" onblur="updateContinueButton();">
                                    </div>
                                </div>
                            </div>
                            <div id="address-fields" class="hidden space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Endereço</label>
                                    <input type="text" id="street" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Rua, Avenida..." oninput="updateAddressData()">
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Número *</label>
                                        <input type="text" id="number" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="123" oninput="clearFieldError('number')" onchange="updateContinueButton()" onblur="updateContinueButton()">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Complemento</label>
                                        <input type="text" id="complement" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Apto 45">
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Bairro</label>
                                        <input type="text" id="neighborhood" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Nome do bairro" oninput="updateAddressData(); handleNeighborhoodChange()">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Cidade</label>
                                        <input type="text" id="city" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-transparent" placeholder="Cidade - UF" oninput="updateAddressData()">
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    continueBtn.disabled = true;
                    
                    // Foco automático no campo de CEP após renderização
                    setTimeout(() => {
                        const cepField = document.getElementById('cep');
                        if (cepField) {
                            cepField.focus();
                        }
                    }, 100);
                    break;
                    
                case 'pickup':
                case 'default':
                    fieldsContainer.innerHTML = '';
                    continueBtn.disabled = false;
                    break;
            }
        }

        // Handle CEP input - fetch address when 8 digits are entered
        function handleCepInput() {
            const cep = document.getElementById('cep').value.replace(/\D/g, '');
            
            // Limpar campos de endereço e taxa quando usuário editar CEP
            if (cep.length < 8) {
                // Limpar campos de endereço
                const streetField = document.getElementById('street');
                const neighborhoodField = document.getElementById('neighborhood');
                const cityField = document.getElementById('city');
                
                if (streetField) streetField.value = '';
                if (neighborhoodField) neighborhoodField.value = '';
                if (cityField) cityField.value = '';
                
                // Limpar taxa de delivery
                clearDeliveryFee();
                
                // Limpar dados do pedido
                if (window.orderData && window.orderData.address) {
                    delete window.orderData.address;
                }
            }
            
            if (cep.length === 8) {
                fetchAddress();
            }
        }

        // Fetch address from CEP with multiple API fallbacks
        async function fetchAddress() {
            const cep = document.getElementById('cep').value.replace(/\D/g, '');
            
            if (cep.length !== 8) return;
            
            // Show loading indicator
            const cepField = document.getElementById('cep');
            const originalPlaceholder = cepField.placeholder;
            cepField.placeholder = 'Buscando endereço...';
            cepField.disabled = true;
            
            // List of CEP APIs to try
            const cepApis = [
                {
                    name: 'ViaCEP',
                    url: `https://viacep.com.br/ws/${cep}/json/`,
                    parseResponse: (data) => ({
                        logradouro: data.logradouro,
                        bairro: data.bairro,
                        localidade: data.localidade,
                        uf: data.uf,
                        erro: data.erro
                    })
                },
                {
                    name: 'CEP Aberto',
                    url: `https://www.cepaberto.com/api/v3/cep?cep=${cep}`,
                    parseResponse: (data) => ({
                        logradouro: data.address,
                        bairro: data.district,
                        localidade: data.city?.name,
                        uf: data.state?.short_name,
                        erro: !data.address && !data.district && !data.city
                    }),
                    headers: {
                        'Authorization': 'Token token=free'
                    }
                },
                {
                    name: 'PostMon',
                    url: `https://api.postmon.com.br/v1/cep/${cep}`,
                    parseResponse: (data) => ({
                        logradouro: data.logradouro,
                        bairro: data.bairro,
                        localidade: data.cidade,
                        uf: data.estado,
                        erro: data.erro
                    })
                }
            ];
            
            let lastError = null;
            
            for (let i = 0; i < cepApis.length; i++) {
                const api = cepApis[i];
                
                try {
                    console.log(`Tentando API ${api.name}:`, api.url);
                    
                    // Add timeout to the fetch request
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 second timeout
                    
                    const response = await fetch(api.url, {
                        signal: controller.signal,
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json',
                            ...api.headers
                        }
                    });
                    
                    clearTimeout(timeoutId);
                    
                    console.log(`${api.name} Response status:`, response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const rawData = await response.json();
                    const data = api.parseResponse(rawData);
                    console.log(`${api.name} data received:`, data);
                    
                    if (data.erro) {
                        console.log(`${api.name}: CEP não encontrado`);
                        continue; // Try next API
                    }
                    
                    // Validate required fields
                    if (!data.logradouro && !data.bairro && !data.localidade) {
                        console.log(`${api.name}: Dados incompletos`);
                        continue; // Try next API
                    }
                    
                    // Success! Fill the form
                    document.getElementById('street').value = data.logradouro || '';
                    document.getElementById('neighborhood').value = data.bairro || '';
                    document.getElementById('city').value = `${data.localidade || ''} - ${data.uf || ''}`;
                    document.getElementById('address-fields').classList.remove('hidden');
                    
                    orderData.address = {
                        cep: cep,
                        street: data.logradouro || '',
                        neighborhood: data.bairro || '',
                        city: data.localidade || '',
                        state: data.uf || ''
                    };
                    
                    // Processar taxa de delivery baseada no bairro
                    processDeliveryFeeAfterCEP(orderData.address);
                    
                    // Garantir que o campo CEP permaneça editável
                    const cepField = document.getElementById('cep');
                    if (cepField) {
                        cepField.disabled = false;
                        cepField.readOnly = false;
                        cepField.placeholder = originalPlaceholder;
                    }
                    
                    console.log(`Endereço encontrado via ${api.name}:`, orderData.address);
                    updateContinueButton();
                    return; // Success, exit function
                    
                } catch (error) {
                    console.error(`Erro na API ${api.name}:`, error);
                    lastError = error;
                    
                    // If this is the last API, show error
                    if (i === cepApis.length - 1) {
                        break;
                    }
                    
                    // Otherwise, continue to next API
                    continue;
                }
            }
            
            // If we get here, all APIs failed
            console.error('Todas as APIs de CEP falharam');
            
            // Show manual input option
            showCustomAlert('Serviço de CEP temporariamente indisponível. Você pode preencher o endereço manualmente.', () => {
                // Show address fields for manual input
                document.getElementById('street').value = '';
                document.getElementById('neighborhood').value = '';
                document.getElementById('city').value = '';
                document.getElementById('address-fields').classList.remove('hidden');
                
                // Focus on street field
                setTimeout(() => {
                    document.getElementById('street').focus();
                }, 100);
                
                // Initialize empty address data
                orderData.address = {
                    cep: cep,
                    street: '',
                    neighborhood: '',
                    city: '',
                    state: ''
                };
                
                updateContinueButton();
            });
            
            // Restore field state
            cepField.placeholder = originalPlaceholder;
            cepField.disabled = false;
        }

        // Update continue button state (no validation, just enable/disable)
        function updateContinueButton() {
            // Button is always enabled - validation happens on click
            const continueBtn = document.getElementById('step2-continue');
            if (continueBtn) {
                continueBtn.disabled = false;
            }
        }

        // Show all delivery options (only enabled ones from configuration)
        function showAllDeliveryOptions() {
            const deliveryOptions = document.getElementById('delivery-options');
            const checkoutConfig = getCheckoutConfig();
            
            // Helper function to check if option is enabled
            function isOptionEnabled(csvValue) {
                if (!csvValue || !csvValue.includes('/')) {
                    return false;
                }
                const parts = csvValue.split('/');
                const visibility = parts[0] ? parts[0].trim().toLowerCase() : '';
                return visibility === 'sim';
            }
            
            // Map of input values to their config keys
            const optionConfigMap = {
                'local': checkoutConfig.step2_opc1,
                'pickup': checkoutConfig.step2_opc2,
                'delivery': checkoutConfig.step2_opc3,
                'default': checkoutConfig.step2_opc4
            };
            
            deliveryOptions.querySelectorAll('label').forEach(label => {
                const input = label.querySelector('input[type="radio"]');
                if (input) {
                    const optionValue = input.value;
                    const configValue = optionConfigMap[optionValue];
                    
                    // Only show if option is enabled in configuration
                    if (isOptionEnabled(configValue)) {
                        label.style.display = 'flex';
                    } else {
                        label.style.display = 'none';
                    }
                }
            });
        }

        // Hide other delivery options (keep only selected)
        function hideOtherDeliveryOptions(selectedType) {
            const deliveryOptions = document.getElementById('delivery-options');
            deliveryOptions.querySelectorAll('label').forEach(label => {
                const input = label.querySelector('input[type="radio"]');
                if (input.value !== selectedType) {
                    label.style.display = 'none';
                }
            });
        }

        // Show "Outras opções" button
        function showOtherOptionsButton() {
            const deliveryOptions = document.getElementById('delivery-options');
            let showOtherOptionsBtn = document.getElementById('show-other-options');
            
            if (!showOtherOptionsBtn) {
                showOtherOptionsBtn = document.createElement('button');
                showOtherOptionsBtn.id = 'show-other-options';
                showOtherOptionsBtn.type = 'button';
                showOtherOptionsBtn.className = 'text-sm font-medium mt-2 transition-colors';
                showOtherOptionsBtn.style.color = 'var(--cor-texto)';
                showOtherOptionsBtn.onmouseenter = function() { this.style.color = 'var(--cor-texto)'; };
                showOtherOptionsBtn.onmouseleave = function() { this.style.color = 'var(--cor-texto)'; };
                showOtherOptionsBtn.innerHTML = '↩️ Mostrar outras opções';
                showOtherOptionsBtn.onclick = toggleDeliveryOptions;
                deliveryOptions.appendChild(showOtherOptionsBtn);
            }
            
            showOtherOptionsBtn.style.display = 'block';
        }

        // Hide "Outras opções" button
        function hideOtherOptionsButton() {
            const showOtherOptionsBtn = document.getElementById('show-other-options');
            if (showOtherOptionsBtn) {
                showOtherOptionsBtn.style.display = 'none';
            }
        }

        // Toggle delivery options visibility
        function toggleDeliveryOptions() {
            const showOtherOptionsBtn = document.getElementById('show-other-options');
            const deliveryOptions = document.getElementById('delivery-options');
            const fieldsContainer = document.getElementById('delivery-fields');
            const hiddenOptions = deliveryOptions.querySelectorAll('label[style*="display: none"]');
            
            if (hiddenOptions.length > 0) {
                // Show all options and hide the button
                showAllDeliveryOptions();
                hideOtherOptionsButton();
                
                // Limpar os campos específicos (CEP ou mesa)
                fieldsContainer.innerHTML = '';
                
                // Desmarcar todos os radios
                document.querySelectorAll('input[name="delivery-type"]').forEach(radio => {
                    radio.checked = false;
                });
                
                // Atualizar orderData
                orderData.deliveryType = null;
            }
        }

        // Allow deselecting radio buttons
        function setupDeselectableRadios() {
            let lastChecked = null;
            
            document.addEventListener('click', function(e) {
                if (e.target.type === 'radio' && e.target.name === 'delivery-type') {
                    // If clicking the same radio that was already checked, uncheck it
                    if (lastChecked === e.target) {
                        e.target.checked = false;
                        lastChecked = null;
                        handleDeliveryTypeChange();
                    } else {
                        lastChecked = e.target;
                        handleDeliveryTypeChange();
                    }
                }
            });
        }

        // Show field error with enhanced visual feedback
        function showFieldError(fieldId, message) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            
            // Clear any existing animations first
            field.classList.remove('shake', 'field-error');
            
            // Remove existing error message
            const existingError = field.parentNode.querySelector('.error-message');
            if (existingError) {
                existingError.remove();
            }
            
            // Force reflow to ensure classes are removed
            field.offsetHeight;
            
            // Add error styling with shake animation
            field.classList.add('field-error', 'shake');
            
            // Add error message with animation
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `
                <span class="text-red-500">⚠️</span>
                <span>${message}</span>
            `;
            field.parentNode.appendChild(errorDiv);
            
            // Focus on field with slight delay
            setTimeout(() => {
                field.focus();
                field.select();
            }, 100);
            
            // Remove shake animation after it completes (only once)
            setTimeout(() => {
                field.classList.remove('shake');
            }, 600);
        }

        // Clear field error with smooth transition
        function clearFieldError(fieldId) {
            const field = document.getElementById(fieldId);
            if (!field) return;
            
            // Remove all error-related classes and animations
            field.classList.remove('field-error', 'shake');
            
            // Remove error message with fade out
            const errorMessage = field.parentNode.querySelector('.error-message');
            if (errorMessage) {
                errorMessage.style.opacity = '0';
                errorMessage.style.transform = 'translateY(-5px)';
                setTimeout(() => {
                    if (errorMessage.parentNode) {
                        errorMessage.remove();
                    }
                }, 200);
            }
        }
        


        // Simple validation functions - only called when needed
        function validateTableNumber() {
            const tableNumber = document.getElementById('table-number')?.value.trim();
            if (!tableNumber) {
                showFieldError('table-number', 'Informe o número da mesa ou comanda');
                return false;
            }
            return true;
        }
        
        function validateAddressNumber() {
            const number = document.getElementById('number')?.value.trim();
            if (!number) {
                showFieldError('number', 'Número do endereço é obrigatório');
                return false;
            }
            return true;
        }
        
        function validateCustomerName() {
            const name = document.getElementById('customer-name')?.value.trim();
            if (!name) {
                showFieldError('customer-name', 'Nome completo é obrigatório');
                return false;
            }
            if (name.length < 2) {
                showFieldError('customer-name', 'Nome deve ter pelo menos 2 caracteres');
                return false;
            }
            return true;
        }
        
        function validatePaymentMethod() {
            const checkoutConfig = getCheckoutConfig();
            
            // Check if payment methods are enabled
            if (checkoutConfig.step3_show_formas_pag !== 'Sim') {
                return true; // Skip validation if payment methods are disabled
            }
            
            // Define delivery types that should validate payment methods
            const deliveryTypesWithPayment = ['pickup', 'delivery', 'default'];
            if (!deliveryTypesWithPayment.includes(orderData.deliveryType)) {
                return true; // Skip validation for delivery types without payment
            }
            
            const paymentMethod = document.getElementById('payment-method')?.value;
            if (!paymentMethod) {
                showFieldError('payment-method', 'Selecione a forma de pagamento');
                return false;
            }
            return true;
        }
        
        /**
         * Calcula o total do carrinho
         */
        function calculateCartTotal() {
            return cart.reduce((sum, item) => sum + (item.preco * item.quantity), 0);
        }
        
        // Atualizar total do pedido no Step 3 (checkout) - MODIFICADO PARA CUPONS
        function updateCheckoutOrderTotal() {
            const totalElement = document.getElementById('checkout-order-total');
            if (totalElement) {
                const cartTotal = calculateCartTotal();
                const deliveryFee = currentDeliveryFee || 0;
                let finalTotal = cartTotal + deliveryFee;
                
                // Aplicar desconto do cupom se houver
                if (appliedCoupon && couponDiscount > 0) {
                    finalTotal = Math.max(0, finalTotal - couponDiscount);
                }
                
                console.log('=== ATUALIZANDO TOTAL DO CHECKOUT ===');
                console.log('Subtotal carrinho:', formatCurrency(cartTotal));
                console.log('Taxa de delivery:', formatCurrency(deliveryFee));
                console.log('Desconto cupom:', formatCurrency(couponDiscount));
                console.log('Total final:', formatCurrency(finalTotal));
                
                // Atualizar total final (sempre limpo)
                totalElement.textContent = formatCurrency(finalTotal);
                
                // Atualizar novo resumo limpo
                updateOrderSummary(cartTotal, deliveryFee);
            }
        }
        
        // ===== SISTEMA DE CUPONS =====
        
        // Atualizar resumo do pedido - NOVA VERSÃO LIMPA
        function updateOrderSummary(cartTotal, deliveryFee) {
            // Elementos do novo layout
            const subtotalElement = document.getElementById('order-subtotal');
            const deliveryRow = document.getElementById('delivery-row');
            const deliveryFeeElement = document.getElementById('order-delivery-fee');
            const discountRow = document.getElementById('discount-row');
            const discountLabelElement = document.getElementById('discount-label');
            const discountElement = document.getElementById('order-discount');
            
            if (!subtotalElement) return;
            
            // 1. SUBTOTAL (sempre visível)
            subtotalElement.textContent = formatCurrency(cartTotal);
            
            // 2. FRETE (apenas se houver)
            if (deliveryFee > 0) {
                deliveryRow.classList.remove('hidden');
                deliveryFeeElement.textContent = formatCurrency(deliveryFee);
            } else {
                deliveryRow.classList.add('hidden');
            }
            
            // 3. DESCONTO (apenas se houver cupom aplicado)
            if (appliedCoupon && couponDiscount > 0) {
                discountRow.classList.remove('hidden');
                
                // Obter valor do desconto do cupom
                const discountValue = appliedCoupon.valor_desconto || appliedCoupon.valor || '';
                const discountType = appliedCoupon.tipo_desconto || appliedCoupon.tipo || '';
                const couponCode = appliedCoupon.codigo_cupom || appliedCoupon.codigo;
                
                // Formatar valor do desconto (% ou R$)
                let discountPrefix = '';
                if (discountValue.toString().includes('%')) {
                    // Se contém %, mostrar como percentual
                    discountPrefix = `${discountValue} `;
                } else {
                    // Se é valor fixo, mostrar como moeda
                    const numericValue = parseFloat(discountValue.toString().replace(/[^0-9.,]/g, '').replace(',', '.'));
                    if (!isNaN(numericValue)) {
                        discountPrefix = `${formatCurrency(numericValue)} `;
                    }
                }
                
                // Definir label baseado no tipo de desconto
                let label = 'Desconto';
                
                switch (discountType.toLowerCase()) {
                    case 'produtos':
                        label = `${discountPrefix}Desconto (${couponCode})`;
                        break;
                    case 'frete':
                        label = `${discountPrefix}Desconto Frete (${couponCode})`;
                        break;
                    case 'total':
                        label = `${discountPrefix}Desconto Total (${couponCode})`;
                        break;
                    default:
                        label = `${discountPrefix}Desconto (${couponCode})`;
                        break;
                }
                
                discountLabelElement.textContent = label;
                discountElement.textContent = '-' + formatCurrency(couponDiscount);
            } else {
                discountRow.classList.add('hidden');
            }
        }
        
        // Aplicar cupom via botão
        function applyCouponFromButton() {
            const couponInput = document.getElementById('coupon-code');
            if (!couponInput) return;
            
            const code = couponInput.value.trim().toUpperCase();
            if (!code) {
                showCouponFeedback('Digite um código de cupom', 'error');
                return;
            }
            
            applyCoupon(code);
        }
        
        // Aplicar cupom automaticamente ao digitar (REMOVIDO - agora só via botão)
        function applyCouponOnType(code) {
            // Função mantida para compatibilidade, mas não é mais usada
            // Agora o cupom só é aplicado via botão
        }
        
        // Aplicar cupom
        function applyCoupon(code) {
            console.log('🔍 Validando cupom:', code);
            
            // Buscar cupom nos dados
            const coupon = couponsData.find(c => 
                (c.codigo_cupom || c.codigo || '').toString().toUpperCase() === code
            );
            
            if (!coupon) {
                showCouponFeedback('Cupom não encontrado', 'error');
                return false;
            }
            
            // Validar datas
            if (!validateCouponDates(coupon)) {
                return false;
            }
            
            // Calcular desconto
            const discount = calculateCouponDiscount(coupon);
            
            // Tratar erros específicos
            if (discount === -1) {
                showCouponFeedback('Cupom não aplicável: carrinho vazio', 'error');
                return false;
            } else if (discount === -2) {
                const discountType = coupon.tipo_desconto || coupon.tipo || '';
                if (discountType.toLowerCase() === 'frete') {
                    showCouponFeedback('Cupom de frete: selecione delivery primeiro', 'error');
                } else {
                    showCouponFeedback('Cupom não aplicável: sem taxa de delivery', 'error');
                }
                return false;
            } else if (discount <= 0) {
                showCouponFeedback('Cupom não aplicável', 'error');
                return false;
            }
            
            // Aplicar cupom
            appliedCoupon = coupon;
            couponDiscount = discount;
            
            console.log('✅ Cupom aplicado:', code, 'Desconto:', formatCurrency(discount));
            
            // Atualizar interface com feedback simples
            showCouponFeedback('✅ Cupom aplicado com sucesso!', 'success');
            updateCheckoutOrderTotal();
            
            return true;
        }
        
        // Validar datas do cupom
        function validateCouponDates(coupon) {
            const now = new Date();
            
            // Validar data de início
            if (coupon.data_inicio && coupon.data_inicio !== '-' && coupon.data_inicio.trim()) {
                const startDate = parseCouponDate(coupon.data_inicio);
                if (startDate && now < startDate) {
                    showCouponFeedback('Cupom ainda não válido', 'error');
                    return false;
                }
            }
            
            // Validar data de fim
            if (coupon.data_fim && coupon.data_fim !== '-' && coupon.data_fim.trim()) {
                const endDate = parseCouponDate(coupon.data_fim);
                if (endDate && now > endDate) {
                    showCouponFeedback('Cupom expirado', 'error');
                    return false;
                }
            }
            
            return true;
        }
        
        // Parsear data do cupom
        function parseCouponDate(dateStr) {
            if (!dateStr || dateStr === '-') return null;
            
            // Formato DD/MM/YYYY ou DD/MM/YYYY HH:MM
            const parts = dateStr.split(' ');
            const datePart = parts[0];
            const timePart = parts[1] || '00:00';
            
            const [day, month, year] = datePart.split('/');
            const [hour, minute] = timePart.split(':');
            
            return new Date(year, month - 1, day, hour || 0, minute || 0);
        }
        
        // Calcular desconto do cupom
        function calculateCouponDiscount(coupon) {
            const cartTotal = calculateCartTotal();
            const deliveryFee = currentDeliveryFee || 0;
            const discountValue = coupon.valor_desconto || coupon.valor || '';
            const discountType = coupon.tipo_desconto || coupon.tipo || '';
            
            console.log('💰 Calculando desconto do cupom:');
            console.log('- Tipo:', discountType);
            console.log('- Valor:', discountValue);
            console.log('- Cart Total:', cartTotal);
            console.log('- Delivery Fee:', deliveryFee);
            
            let baseValue = 0;
            
            // Determinar valor base para cálculo
            switch (discountType.toLowerCase()) {
                case 'produtos':
                    baseValue = cartTotal;
                    if (baseValue <= 0) {
                        console.log('❌ Cupom de produtos: carrinho vazio');
                        return -1; // Indicador de erro específico
                    }
                    break;
                case 'frete':
                    baseValue = deliveryFee;
                    if (baseValue <= 0) {
                        console.log('❌ Cupom de frete: sem taxa de delivery definida');
                        return -2; // Indicador de erro específico
                    }
                    break;
                case 'total':
                    baseValue = cartTotal + deliveryFee;
                    if (baseValue <= 0) {
                        console.log('❌ Cupom de total: valores zerados');
                        return -1; // Indicador de erro específico
                    }
                    break;
                default:
                    console.log('❌ Tipo de desconto inválido:', discountType);
                    return 0;
            }
            
            console.log('- Base Value:', baseValue);
            
            // Calcular desconto
            let discount = 0;
            
            if (discountValue.toString().includes('%')) {
                // Desconto percentual
                const percentage = parseFloat(discountValue.replace('%', ''));
                discount = (baseValue * percentage) / 100;
                console.log('- Desconto percentual:', percentage + '%', '=', discount);
            } else {
                // Desconto fixo
                discount = parseFloat(discountValue.toString().replace(',', '.')) || 0;
                console.log('- Desconto fixo:', discount);
            }
            
            // Limitar desconto ao valor base
            const finalDiscount = Math.min(discount, baseValue);
            console.log('- Desconto final:', finalDiscount);
            
            return finalDiscount;
        }
        
        // Mostrar feedback do cupom
        function showCouponFeedback(message, type) {
            const feedback = document.getElementById('coupon-feedback');
            if (!feedback) return;
            
            feedback.className = `mt-2 text-xs ${type === 'success' ? 'text-green-600' : 'text-red-600'}`;
            feedback.textContent = message;
            feedback.classList.remove('hidden');
            
            // Ocultar após 3 segundos se for erro
            if (type === 'error') {
                setTimeout(() => {
                    feedback.classList.add('hidden');
                }, 3000);
            }
        }
        

        
        // Controlar expansão do campo de cupom
        function toggleCouponField() {
            const container = document.getElementById('coupon-field-container');
            const arrow = document.getElementById('coupon-arrow');
            const toggleBtn = document.getElementById('coupon-toggle-btn');
            
            if (!container || !arrow) return;
            
            const isExpanded = container.style.maxHeight !== '0px' && container.style.maxHeight !== '';
            
            if (isExpanded) {
                // Contrair
                container.style.maxHeight = '0';
                container.style.opacity = '0';
                arrow.style.transform = 'rotate(0deg)';
                console.log('🎟️ Campo de cupom contraído');
            } else {
                // Expandir
                container.style.maxHeight = '200px';
                container.style.opacity = '1';
                arrow.style.transform = 'rotate(180deg)';
                
                // Focar no campo após expansão
                setTimeout(() => {
                    const couponInput = document.getElementById('coupon-code');
                    if (couponInput) {
                        couponInput.focus();
                    }
                }, 300);
                
                console.log('🎟️ Campo de cupom expandido');
            }
        }
        

        
        // Controlar visibilidade do botão de limpar inline
        function toggleClearButton() {
            const couponInput = document.getElementById('coupon-code');
            const clearBtn = document.getElementById('clear-coupon-btn');
            
            if (!couponInput || !clearBtn) return;
            
            if (couponInput.value.trim().length > 0) {
                clearBtn.classList.remove('hidden');
            } else {
                clearBtn.classList.add('hidden');
            }
        }
        
        // Limpar input e resetar cupom completamente
        function clearCouponInput() {
            const couponInput = document.getElementById('coupon-code');
            const clearBtn = document.getElementById('clear-coupon-btn');
            
            // Limpar o input
            if (couponInput) {
                couponInput.value = '';
                couponInput.focus();
            }
            
            // Esconder botão de limpar
            if (clearBtn) {
                clearBtn.classList.add('hidden');
            }
            
            // Resetar cupom aplicado (usar função existente)
            clearCoupon();
            
            // Atualizar resumo do pedido
            updateOrderSummary();
            
            console.log('🎟️ Input limpo e cupom resetado completamente');
        }
        
        // Limpar cupom
        function clearCoupon() {
            appliedCoupon = null;
            couponDiscount = 0;
            
            // Limpar interface
            const feedback = document.getElementById('coupon-feedback');
            if (feedback) feedback.classList.add('hidden');
            
            // Contrair campo de cupom
            const container = document.getElementById('coupon-field-container');
            const arrow = document.getElementById('coupon-arrow');
            if (container && arrow) {
                container.style.maxHeight = '0';
                container.style.opacity = '0';
                arrow.style.transform = 'rotate(0deg)';
            }
            
            // Limpar campo de input
            const couponInput = document.getElementById('coupon-code');
            if (couponInput) {
                couponInput.value = '';
            }
            
            // Atualizar total e resumo
            updateCheckoutOrderTotal();
        }
        
        // Resetar sistema de cupons
        function resetCouponSystem() {
            console.log('🔄 Resetando sistema de cupons');
            
            // Limpar variáveis
            appliedCoupon = null;
            couponDiscount = 0;
            
            // Limpar timeout
            if (couponTimeout) {
                clearTimeout(couponTimeout);
                couponTimeout = null;
            }
            
            // Limpar campo de entrada
            const couponInput = document.getElementById('coupon-code');
            if (couponInput) couponInput.value = '';
            
            // Limpar interface
            clearCoupon();
        }
        
        // Adicionar informações do cupom à mensagem do WhatsApp
        function addCouponInfoToWhatsAppMessage(message) {
            if (!appliedCoupon || couponDiscount <= 0) {
                return message;
            }
            
            const discountType = appliedCoupon.tipo_desconto || appliedCoupon.tipo || '';
            let typeText = '';
            
            switch (discountType.toLowerCase()) {
                case 'produtos':
                    typeText = 'nos produtos';
                    break;
                case 'frete':
                    typeText = 'no frete';
                    break;
                case 'total':
                    typeText = 'no total';
                    break;
            }
            
            const couponInfo = `\n\n🎟️ *Cupom Aplicado:*\n   ${appliedCoupon.codigo_cupom || appliedCoupon.codigo}\n   Desconto: ${formatCurrency(couponDiscount)} (${typeText})`;
            
            // Inserir antes do total final
            const totalIndex = message.lastIndexOf('💰 *Total:');
            if (totalIndex !== -1) {
                return message.slice(0, totalIndex) + couponInfo + '\n\n' + message.slice(totalIndex);
            }
            
            return message + couponInfo;
        }
        
        // Handle payment method change
        function handlePaymentMethodChange() {
            const paymentMethod = document.getElementById('payment-method').value;
            const changeDiv = document.getElementById('money-change');
            
            if (paymentMethod === 'dinheiro') {
                changeDiv.classList.remove('hidden');
                setupChangeAmountField();
            } else {
                changeDiv.classList.add('hidden');
                clearFieldError('change-amount');
            }
        }
        
        /**
         * Configura o campo de troco com validação
         */
        function setupChangeAmountField() {
            console.log('=== SETUP CHANGE AMOUNT FIELD ===');
            const changeInput = document.getElementById('change-amount');
            const total = calculateCartTotal();
            
            console.log('Change input element:', changeInput);
            console.log('Cart total:', total);
            console.log('Cart contents:', cart);
            
            // Definir placeholder simples
            changeInput.placeholder = 'Ex: ' + formatCurrency(Math.ceil(total / 10) * 10 + 10);
            
            // Adicionar validação em tempo real com máscara da moeda atual
            changeInput.oninput = function() {
                formatMoney(this); // Aplicar máscara da moeda atual
                validateChangeAmount(this.value, total);
                clearFieldError('change-amount');
            };
            
            // Remover o oninput antigo do HTML que usava formatMoney genérico
            changeInput.removeAttribute('oninput');
            
            // Focar no campo
            setTimeout(() => changeInput.focus(), 100);
        }
        
        /**
         * Valida o valor do troco em tempo real
         */
        function validateChangeAmount(changeValue, total) {
            const changeInput = document.getElementById('change-amount');
            const numericValue = parseFloat(changeValue.replace(/[^\d,]/g, '').replace(',', '.'));
            
            // Remover feedback anterior
            const existingFeedback = changeInput.parentNode.querySelector('.change-feedback');
            if (existingFeedback) existingFeedback.remove();
            
            if (!isNaN(numericValue) && numericValue > total) {
                const changeAmount = numericValue - total;
                
                // Criar feedback positivo
                const feedback = document.createElement('div');
                feedback.className = 'change-feedback text-sm mt-1 flex items-center space-x-2';
                feedback.style.color = 'var(--cor-sucesso)';
                feedback.innerHTML = `
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Troco: ${formatCurrency(changeAmount)}</span>
                `;
                
                changeInput.parentNode.appendChild(feedback);
            } else if (!isNaN(numericValue) && numericValue <= total) {
                // Criar feedback de erro
                const feedback = document.createElement('div');
                feedback.className = 'change-feedback text-sm mt-1 flex items-center space-x-2';
                feedback.style.color = 'var(--cor-erro)';
                feedback.innerHTML = `
                    <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    <span>Valor deve ser maior que ${formatCurrency(total)}</span>
                `;
                
                changeInput.parentNode.appendChild(feedback);
            }
        }
        
        // Initialize everything
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData(); // This will load CSV data and then call initializeApp()
        });
        
        // Setup event listeners (called after data is loaded)
        function setupEventListeners() {
            setupSearch();
            setupScrollSpy();
            handleInitialHash();
            setupDeselectableRadios();
            setupKeyboardShortcuts();
        }
        
        // Setup keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Close lightbox with Escape key
                if (e.key === 'Escape') {
                    const lightbox = document.getElementById('image-lightbox');
                    if (!lightbox.classList.contains('hidden')) {
                        closeLightbox();
                    }
                }
            });
        }

        // ====================================================================
        // SISTEMA DE TAXA DE DELIVERY POR BAIRRO - V3.3.4
        // ====================================================================

        /**
         * Busca a taxa de delivery para um bairro específico
         * @param {string} neighborhood - Nome do bairro
         * @returns {number|null} - Valor da taxa ou null se não encontrado
         */
        function findDeliveryFeeByNeighborhood(neighborhood) {
            // Usar dados globais se disponíveis
            const dataSource = window.neighborhoodsData || neighborhoodsData;
            
            if (!neighborhood || !dataSource.length) {
                return null;
            }
            
            const normalizedNeighborhood = neighborhood.trim().toLowerCase();
            
            // Busca exata primeiro
            let found = dataSource.find(item => 
                item.bairro === normalizedNeighborhood
            );
            
            // Se não encontrou, tenta busca parcial
            if (!found) {
                found = dataSource.find(item => 
                    item.bairro.includes(normalizedNeighborhood) ||
                    normalizedNeighborhood.includes(item.bairro)
                );
            }
            
            if (found) {
                console.log(`💰 Taxa encontrada para "${neighborhood}": R$ ${found.taxa.toFixed(2)}`);
                return found.taxa;
            }
            
            console.log(`❌ Taxa não encontrada para o bairro: "${neighborhood}"`);
            return null;
        }

        /**
         * Exibe a taxa de delivery na interface ou alerta para consultar
         * @param {number|null} fee - Valor da taxa ou null se não encontrado
         * @param {string} neighborhood - Nome do bairro
         */
        function displayDeliveryFee(fee, neighborhood) {
            // Remove alerta anterior se existir
            const existingAlert = document.getElementById('delivery-fee-alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // Controlar visibilidade do alerta original
            const originalAlert = document.getElementById('original-delivery-fee-alert');
            
            let alertHtml = '';
            
            if (fee && fee > 0) {
                // Taxa encontrada - ocultar alerta original
                if (originalAlert) {
                    originalAlert.style.display = 'none';
                }
                // Taxa encontrada - mostrar valor calculado
                alertHtml = `
                    <div id="delivery-fee-alert" class="mt-4 p-4 rounded-lg border-l-4" style="background-color: #f0f9ff; border-color: var(--cor-primaria);">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <svg class="w-5 h-5 mt-0.5" style="color: var(--cor-primaria);" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="ml-3 flex-1">
                                <h3 class="text-sm font-medium" style="color: var(--cor-primaria);">
                                    🚚 Taxa de Delivery Calculada
                                </h3>
                                <div class="mt-2 text-sm" style="color: var(--cor-texto);">
                                    <p><strong>Bairro:</strong> ${neighborhood}</p>
                                    <p><strong>Taxa:</strong> <span class="font-bold" style="color: var(--cor-primaria);">${formatCurrency(fee)}</span></p>
                                    <p class="mt-1 text-xs" style="color: var(--cor-texto-secundario);">
                                        Esta taxa será adicionada ao valor total do seu pedido.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                // Taxa não encontrada - mostrar alerta original
                if (originalAlert) {
                    originalAlert.style.display = 'block';
                }
            }
            
            // Inserir após os campos de endereço
            const addressFields = document.getElementById('address-fields');
            if (addressFields && alertHtml) {
                addressFields.insertAdjacentHTML('afterend', alertHtml);
            }
        }

        /**
         * Remove a exibição da taxa de delivery
         */
        function clearDeliveryFee() {
            currentDeliveryFee = null;
            const existingAlert = document.getElementById('delivery-fee-alert');
            if (existingAlert) {
                existingAlert.remove();
            }
            
            // NÃO mostrar alerta original automaticamente
            // Ele só deve aparecer quando bairro não for encontrado
            const originalAlert = document.getElementById('original-delivery-fee-alert');
            if (originalAlert) {
                originalAlert.style.display = 'none';
            }
        }

        /**
         * Processa a taxa de delivery após validação do CEP
         * @param {object} addressData - Dados do endereço
         */
        function processDeliveryFeeAfterCEP(addressData) {
            if (!addressData || !addressData.neighborhood) {
                clearDeliveryFee();
                return;
            }
            
            // Buscar taxa para o bairro
            const fee = findDeliveryFeeByNeighborhood(addressData.neighborhood);
            
            if (fee !== null && fee > 0) {
                currentDeliveryFee = fee;
                displayDeliveryFee(fee, addressData.neighborhood);
                
                // Adicionar taxa aos dados do pedido
                if (window.orderData && window.orderData.address) {
                    window.orderData.address.deliveryFee = fee;
                }
            } else {
                // Taxa não encontrada - limpar taxa mas exibir alerta para consultar
                currentDeliveryFee = null;
                if (window.orderData && window.orderData.address) {
                    delete window.orderData.address.deliveryFee;
                }
                // Exibir alerta para consultar taxa
                displayDeliveryFee(null, addressData.neighborhood);
            }
        }

        /**
         * Atualiza os dados do endereço quando editado manualmente
         */
        function updateAddressData() {
            if (!window.orderData || !window.orderData.address) {
                return;
            }
            
            // Atualizar dados do endereço com valores dos campos
            const streetField = document.getElementById('street');
            const neighborhoodField = document.getElementById('neighborhood');
            const cityField = document.getElementById('city');
            
            if (streetField) {
                window.orderData.address.street = streetField.value;
            }
            if (neighborhoodField) {
                window.orderData.address.neighborhood = neighborhoodField.value;
            }
            if (cityField) {
                window.orderData.address.city = cityField.value;
            }
            
            console.log('Dados do endereço atualizados:', window.orderData.address);
        }
        
        /**
         * Manipula mudanças no campo de bairro para recalcular taxa de delivery
         */
        function handleNeighborhoodChange() {
            const neighborhoodField = document.getElementById('neighborhood');
            if (!neighborhoodField || !window.orderData || !window.orderData.address) {
                return;
            }
            
            const newNeighborhood = neighborhoodField.value.trim();
            if (newNeighborhood) {
                // Atualizar dados do endereço
                window.orderData.address.neighborhood = newNeighborhood;
                
                // Recalcular taxa de delivery para o novo bairro
                processDeliveryFeeAfterCEP(window.orderData.address);
            } else {
                // Se bairro estiver vazio, limpar taxa
                clearDeliveryFee();
                if (window.orderData.address) {
                    delete window.orderData.address.deliveryFee;
                }
            }
        }

        // ====================================================================
        // SISTEMA MODO ENDEREÇO MANUAL - "NÃO SEI MEU CEP" - V3.5
        // ====================================================================

        // Variável para controlar timeout de busca por bairro
        let neighborhoodSearchTimeout = null;

        /**
         * Alterna entre modo CEP e modo endereço manual
         */
        function toggleAddressMode() {
            console.log('=== ALTERNANDO MODO DE ENDEREÇO ===');
            
            const cepContainer = document.getElementById('cep-mode-container');
            const manualContainer = document.getElementById('manual-address-container');
            const addressFields = document.getElementById('address-fields');
            
            if (!cepContainer || !manualContainer) {
                console.error('Containers de modo não encontrados');
                return;
            }
            
            // Limpar timeout de busca se existir
            if (neighborhoodSearchTimeout) {
                clearTimeout(neighborhoodSearchTimeout);
                neighborhoodSearchTimeout = null;
                console.log('Timeout de busca limpo');
            }
            
            const isManualMode = !manualContainer.classList.contains('hidden');
            
            if (isManualMode) {
                // Mudando para modo CEP
                console.log('Mudando para modo CEP');
                manualContainer.classList.add('hidden');
                cepContainer.classList.remove('hidden');
                
                // Limpar campos manuais
                clearManualAddressFields();
                
                // Ocultar campos de endereço automático
                if (addressFields) {
                    addressFields.classList.add('hidden');
                }
                
                // Foco no campo CEP
                setTimeout(() => {
                    const cepField = document.getElementById('cep');
                    if (cepField) {
                        cepField.focus();
                    }
                }, 100);
                
            } else {
                // Mudando para modo manual
                console.log('Mudando para modo MANUAL');
                cepContainer.classList.add('hidden');
                manualContainer.classList.remove('hidden');
                
                // Limpar campos CEP
                clearAddressFields();
                
                // Foco no primeiro campo manual
                setTimeout(() => {
                    const streetField = document.getElementById('manual-street');
                    if (streetField) {
                        streetField.focus();
                    }
                }, 100);
            }
            
            // Limpar taxa de delivery ao alternar
            clearDeliveryFee();
            
            // Limpar dados do endereço
            if (window.orderData && window.orderData.address) {
                window.orderData.address = {};
            }
            
            // Atualizar botão continuar
            updateContinueButton();
            
            console.log('Modo atual:', isManualMode ? 'CEP' : 'MANUAL');
        }

        /**
         * Atualiza os dados do endereço manual
         */
        function updateManualAddressData() {
            const streetField = document.getElementById('manual-street');
            const numberField = document.getElementById('manual-number');
            const complementField = document.getElementById('manual-complement');
            const neighborhoodField = document.getElementById('manual-neighborhood');
            const cityField = document.getElementById('manual-city');
            
            if (!streetField || !numberField || !neighborhoodField || !cityField) {
                return;
            }
            
            // Inicializar orderData.address se não existir (usar variável global consistente)
            if (!orderData) {
                orderData = {};
            }
            if (!orderData.address) {
                orderData.address = {};
            }
            
            // Preservar taxa de delivery existente
            const existingDeliveryFee = orderData.address.deliveryFee;
            
            // Construir endereço completo
            const street = streetField.value.trim();
            const number = numberField.value.trim();
            const complement = complementField.value.trim();
            const neighborhood = neighborhoodField.value.trim();
            const city = cityField.value.trim();
            
            // Montar endereço completo
            let fullAddress = street;
            if (number) fullAddress += `, ${number}`;
            if (complement) fullAddress += `, ${complement}`;
            
            // Atualizar dados do pedido
            orderData.address = {
                cep: '',
                street: fullAddress,
                neighborhood: neighborhood,
                city: city,
                state: '',
                isManual: true
            };
            
            // Restaurar taxa de delivery se existia
            if (existingDeliveryFee) {
                orderData.address.deliveryFee = existingDeliveryFee;
            }
            
            console.log('DEBUG - Dados endereço manual atualizados:', orderData.address);
        }

        /**
         * Busca taxa de delivery por bairro no modo manual (com debounce)
         */
        function searchNeighborhoodFee() {
            const neighborhoodField = document.getElementById('manual-neighborhood');
            if (!neighborhoodField) return;
            
            const neighborhood = neighborhoodField.value.trim();
            
            // Limpar timeout anterior
            if (neighborhoodSearchTimeout) {
                clearTimeout(neighborhoodSearchTimeout);
            }
            
            // Se menos de 3 caracteres, limpar taxa
            if (neighborhood.length < 3) {
                clearDeliveryFee();
                return;
            }
            
            // Aguardar 800ms após o usuário parar de digitar
            neighborhoodSearchTimeout = setTimeout(() => {
                performNeighborhoodSearch(neighborhood);
            }, 800);
        }

        /**
         * Executa a busca real por bairro
         */
        function performNeighborhoodSearch(neighborhood) {
            console.log('=== BUSCANDO TAXA POR BAIRRO (MANUAL) ===');
            console.log('Bairro pesquisado:', neighborhood);
            console.log('window.neighborhoodsData existe?', !!window.neighborhoodsData);
            console.log('Quantidade de registros:', window.neighborhoodsData ? window.neighborhoodsData.length : 0);
            
            // Verificar se dados estão disponíveis
            if (!window.neighborhoodsData) {
                console.error('ERRO: window.neighborhoodsData não definido!');
                // Fallback para dados locais
                if (typeof neighborhoodsData !== 'undefined' && neighborhoodsData.length > 0) {
                    window.neighborhoodsData = neighborhoodsData;
                    console.log('Dados locais copiados para global:', neighborhoodsData.length, 'registros');
                }
            }
            
            if (!window.neighborhoodsData || window.neighborhoodsData.length === 0) {
                console.log('Dados de bairros não disponíveis');
                displayDeliveryFee(null, neighborhood);
                return;
            }
            
            // Log dos primeiros registros para debug
            console.log('Primeiros 3 registros:', window.neighborhoodsData.slice(0, 3));
            
            // Normalizar bairro para busca
            const normalizedNeighborhood = neighborhood.toLowerCase();
            console.log('Bairro normalizado para busca:', normalizedNeighborhood);
            
            // Buscar na planilha
            const result = window.neighborhoodsData.find(item => {
                const itemBairro = (item.bairro || '').toLowerCase();
                console.log('Comparando:', normalizedNeighborhood, '===', itemBairro);
                return itemBairro === normalizedNeighborhood;
            });
            
            console.log('Resultado da busca:', result);
            
            if (result && result.taxa) {
                const fee = parseFloat(result.taxa);
                console.log('Taxa encontrada (raw):', result.taxa);
                console.log('Taxa parseada:', fee);
                
                if (!isNaN(fee) && fee > 0) {
                    console.log('✅ Taxa válida encontrada:', fee);
                    
                    // CORREÇÃO: Definir taxa global (necessário para cálculo do total)
                    currentDeliveryFee = fee;
                    
                    // Definir taxa no orderData
                    if (orderData && orderData.address) {
                        orderData.address.deliveryFee = fee;
                        console.log('Taxa de delivery definida com sucesso:', fee);
                    }
                    
                    // Exibir taxa
                    displayDeliveryFee(fee, neighborhood);
                    
                    // CORREÇÃO: Atualizar total do checkout
                    updateCheckoutOrderTotal();
                    
                    return;
                }
            }
            
            console.log('❌ Taxa não encontrada para o bairro:', neighborhood);
            // Taxa não encontrada - mostrar alerta para consultar
            displayDeliveryFee(null, neighborhood);
        }

        /**
         * Limpa campos de endereço do modo CEP
         */
        function clearAddressFields() {
            const fields = ['cep', 'street', 'number', 'complement', 'neighborhood', 'city'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                    clearFieldError(fieldId);
                }
            });
            
            // Ocultar campos de endereço
            const addressFields = document.getElementById('address-fields');
            if (addressFields) {
                addressFields.classList.add('hidden');
            }
        }

        /**
         * Limpa campos de endereço do modo manual
         */
        function clearManualAddressFields() {
            const fields = ['manual-street', 'manual-number', 'manual-complement', 'manual-neighborhood', 'manual-city'];
            fields.forEach(fieldId => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = '';
                    clearFieldError(fieldId);
                }
            });
        }

        // Show toast notification
        function showToast(message, type = 'error', duration = 4000) {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => {
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            });
            
            const icons = {
                error: '⚠️',
                success: '✅',
                warning: '⚠️',
                info: 'ℹ️'
            };
            
            const toastDiv = document.createElement('div');
            toastDiv.className = `toast toast-${type}`;
            toastDiv.innerHTML = `
                <div class="flex items-start space-x-3">
                    <span class="text-xl flex-shrink-0 mt-0.5">${icons[type]}</span>
                    <div class="flex-1">
                        <div class="font-semibold text-sm leading-tight">${message}</div>
                    </div>
                    <button onclick="this.parentElement.parentElement.classList.add('toast-exit'); setTimeout(() => this.parentElement.parentElement.remove(), 300)" class="text-white/80 hover:text-white ml-2 flex-shrink-0">
                        <span class="text-lg">×</span>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toastDiv);
            
            // Auto remove
            setTimeout(() => {
                if (toastDiv.parentNode) {
                    toastDiv.classList.add('toast-exit');
                    setTimeout(() => toastDiv.remove(), 300);
                }
            }, duration);
        }
        
        // Show custom alert (legacy support)
        function showCustomAlert(message, type = 'error') {
            showToast(message, type);
        }

        // Format WhatsApp number with country-specific mask
        function formatWhatsAppWithCountry(input) {
            const countryCode = document.getElementById('country-code').value;
            const selectedOption = document.querySelector(`#country-code option[value="${countryCode}"]`);
            const format = selectedOption ? selectedOption.getAttribute('data-format') : '(99) 9 9999-9999';
            
            let value = input.value.replace(/\D/g, '');
            
            // Apply formatting based on country
            if (countryCode === '55') { // Brazil
                // Limit to 11 digits (DDD + 9 digits)
                if (value.length > 11) {
                    value = value.substring(0, 11);
                }
                
                // Format: (99) 9 9999-9999
                if (value.length >= 11) {
                    value = value.replace(/(\d{2})(\d{1})(\d{4})(\d{4})/, '($1) $2 $3-$4');
                } else if (value.length >= 7) {
                    value = value.replace(/(\d{2})(\d{1})(\d{0,4})(\d{0,4})/, '($1) $2 $3-$4');
                } else if (value.length >= 3) {
                    value = value.replace(/(\d{2})(\d{0,1})(\d{0,4})/, '($1) $2 $3');
                } else if (value.length >= 1) {
                    value = value.replace(/(\d{0,2})/, '($1)');
                }
            } else if (countryCode === '1') { // US/Canada
                if (value.length > 10) {
                    value = value.substring(0, 10);
                }
                if (value.length >= 10) {
                    value = value.replace(/(\d{3})(\d{3})(\d{4})/, '($1) $2-$3');
                } else if (value.length >= 6) {
                    value = value.replace(/(\d{3})(\d{0,3})(\d{0,4})/, '($1) $2-$3');
                } else if (value.length >= 3) {
                    value = value.replace(/(\d{0,3})(\d{0,3})/, '($1) $2');
                } else {
                    value = value.replace(/(\d{0,3})/, '($1)');
                }
            } else if (countryCode === '351') { // Portugal
                // Limit to 9 digits for Portugal
                if (value.length > 9) {
                    value = value.substring(0, 9);
                }
                
                // Format: 999 999 999
                if (value.length >= 9) {
                    value = value.replace(/(\d{3})(\d{3})(\d{3})/, '$1 $2 $3');
                } else if (value.length >= 6) {
                    value = value.replace(/(\d{3})(\d{0,3})(\d{0,3})/, '$1 $2 $3');
                } else if (value.length >= 3) {
                    value = value.replace(/(\d{0,3})(\d{0,3})/, '$1 $2');
                }
            } else {
                // Generic formatting for other countries
                if (value.length > 15) {
                    value = value.substring(0, 15);
                }
            }
            
            input.value = value;
        }
        
        // Get minimum required length for WhatsApp validation based on country (formatted)
        function getMinWhatsAppLength(countryCode) {
            const countryLengths = {
                '55': 14,   // Brazil: (99) 9 9999-9999
                '1': 14,    // US/Canada: (999) 999-9999
                '351': 11,  // Portugal: 999 999 999
                '244': 11,  // Angola: 999 999 999
                '258': 12,  // Mozambique: 99 999 9999
                '238': 9,   // Cape Verde: 999 99 99
                '245': 8,   // Guinea-Bissau: 999 9999
                '239': 7,   // São Tomé: 99 99999
                '670': 8,   // East Timor: 999 9999
                '853': 9,   // Macau: 9999 9999
                '54': 12,   // Argentina: 9 9999-9999
                '56': 12,   // Chile: 9 9999 9999
                '57': 12,   // Colombia: 999 999 9999
                '51': 11,   // Peru: 999 999 999
                '598': 9,   // Uruguay: 9999 9999
                '595': 10,  // Paraguay: 999 999999
                '591': 9,   // Bolivia: 9999 9999
                '593': 12,  // Ecuador: 99 999 9999
                '58': 12,   // Venezuela: 999-999-9999
                '592': 8,   // Guyana: 999 9999
                '597': 8,   // Suriname: 999-9999
                '594': 12,  // French Guiana: 999 99 99 99
                '34': 12,   // Spain: 999 99 99 99
                '33': 14,   // France: 99 99 99 99 99
                '39': 12,   // Italy: 999 999 9999
                '49': 12,   // Germany: 999 99999999
                '44': 11    // UK: 9999 999999
            };
            return countryLengths[countryCode] || 8; // Default minimum length
        }
        
        // Get minimum required digits for WhatsApp validation based on country (digits only)
        function getMinWhatsAppDigits(countryCode) {
            const countryDigits = {
                '55': 11,   // Brazil: 11 digits
                '1': 10,    // US/Canada: 10 digits
                '351': 9,   // Portugal: 9 digits
                '244': 9,   // Angola: 9 digits
                '258': 9,   // Mozambique: 9 digits
                '238': 7,   // Cape Verde: 7 digits
                '245': 7,   // Guinea-Bissau: 7 digits
                '239': 7,   // São Tomé: 7 digits
                '670': 7,   // East Timor: 7 digits
                '853': 8,   // Macau: 8 digits
                '54': 10,   // Argentina: 10 digits
                '56': 9,    // Chile: 9 digits
                '57': 10,   // Colombia: 10 digits
                '51': 9,    // Peru: 9 digits
                '598': 8,   // Uruguay: 8 digits
                '595': 9,   // Paraguay: 9 digits
                '591': 8,   // Bolivia: 8 digits
                '593': 9,   // Ecuador: 9 digits
                '58': 10,   // Venezuela: 10 digits
                '592': 7,   // Guyana: 7 digits
                '597': 7,   // Suriname: 7 digits
                '594': 10,  // French Guiana: 10 digits
                '34': 9,    // Spain: 9 digits
                '33': 10,   // France: 10 digits
                '39': 10,   // Italy: 10 digits
                '49': 11,   // Germany: 11 digits
                '44': 10    // UK: 10 digits
            };
            return countryDigits[countryCode] || 7; // Default minimum digits
        }
        
        // Update phone placeholder based on selected country
        function updatePhonePlaceholder() {
            const countryCode = document.getElementById('country-code').value;
            const selectedOption = document.querySelector(`#country-code option[value="${countryCode}"]`);
            const format = selectedOption ? selectedOption.getAttribute('data-format') : '(99) 9 9999-9999';
            const phoneInput = document.getElementById('customer-whatsapp');
            
            phoneInput.placeholder = format;
            phoneInput.value = ''; // Clear current value when country changes
        }
        
        // Detect country by IP and set default country code
        async function detectCountryByIP() {
            try {
                const response = await fetch('https://ipapi.co/json/');
                const data = await response.json();
                const countryCode = data.country_code;
                
                // Map country codes to phone country codes
                const countryMapping = {
                    'BR': '55', 'PT': '351', 'AO': '244', 'MZ': '258', 'CV': '238',
                    'GW': '245', 'ST': '239', 'TL': '670', 'MO': '853',
                    'US': '1', 'CA': '1', 'AR': '54', 'CL': '56',
                    'CO': '57', 'PE': '51', 'UY': '598', 'PY': '595', 'BO': '591',
                    'EC': '593', 'VE': '58', 'GY': '592', 'SR': '597', 'GF': '594',
                    'ES': '34', 'FR': '33', 'IT': '39', 'DE': '49', 'GB': '44'
                };
                
                const phoneCountryCode = countryMapping[countryCode] || '55'; // Default to Brazil
                const countrySelect = document.getElementById('country-code');
                
                if (countrySelect) {
                    countrySelect.value = phoneCountryCode;
                    updatePhonePlaceholder();
                }
            } catch (error) {
                console.log('Could not detect country by IP, using default (Brazil)');
                // Keep default Brazil (+55)
            }
        }
        
        // Check if webhook is active
        function isWebhookActive() {
            const envioConfig = getEnvioConfig();
            // Webhook is active when there's a webhook URL AND whatsapp_web is NOT 'Sim'
            // If whatsapp_web is 'Sim', we should use WhatsApp Web instead of webhook
            return envioConfig.webhook_url && envioConfig.webhook_url.trim() !== '' && envioConfig.whatsapp_web !== 'Sim';
        }
        
        // Show/hide WhatsApp field based on webhook status
        function toggleWhatsAppField() {
            const whatsappField = document.getElementById('whatsapp-field');
            if (isWebhookActive()) {
                whatsappField.classList.remove('hidden');
            } else {
                whatsappField.classList.add('hidden');
            }
        }

        // Finalize order with enhanced validation
        function finalizeOrder() {
            // Collect customer data
            const customerName = document.getElementById('customer-name').value.trim();
            const paymentMethod = document.getElementById('payment-method').value;
            const customerWhatsApp = document.getElementById('customer-whatsapp').value.trim();
            
            // Simple validation without loops
            let hasErrors = false;
            
            // Clear any existing errors first
            clearFieldError('customer-name');
            clearFieldError('payment-method');
            clearFieldError('customer-whatsapp');
            
            // Validate customer name
            if (!customerName || customerName.length < 2) {
                showFieldError('customer-name', customerName ? 'Nome deve ter pelo menos 2 caracteres' : 'Nome completo é obrigatório');
                hasErrors = true;
            }
            
            // Validate WhatsApp if webhook is active
            if (isWebhookActive()) {
                const countryCodeSelect = document.getElementById('country-code');
                const selectedCountryCode = countryCodeSelect ? countryCodeSelect.value : '55';
                const digitsOnly = customerWhatsApp.replace(/\D/g, ''); // Extract only digits
                const minDigits = getMinWhatsAppDigits(selectedCountryCode);
                
                if (!customerWhatsApp || digitsOnly.length < minDigits) {
                    showFieldError('customer-whatsapp', 'WhatsApp é obrigatório e deve ter formato válido para o país selecionado');
                    hasErrors = true;
                }
            }
            
            // Validate payment method only if payment methods are enabled AND not "Consumo no Local"
            const checkoutConfig = getCheckoutConfig();
            if (checkoutConfig.step3_show_formas_pag === 'Sim' && orderData.deliveryType !== 'local') {
                if (!paymentMethod) {
                    showFieldError('payment-method', 'Selecione a forma de pagamento');
                    hasErrors = true;
                }
                
                // Validar valor do troco se pagamento for em dinheiro
                if (paymentMethod === 'dinheiro') {
                    console.log('=== VALIDANDO TROCO ===');
                    const changeAmountInput = document.getElementById('change-amount');
                    const changeValue = changeAmountInput?.value?.trim() || '';
                    
                    console.log('Change input:', changeAmountInput);
                    console.log('Change value:', changeValue);
                    
                    clearFieldError('change-amount');
                    
                    if (!changeValue) {
                        showFieldError('change-amount', 'Informe o valor para troco');
                        hasErrors = true;
                    } else {
                        const numericChangeValue = parseFloat(changeValue.replace(/[^\d,]/g, '').replace(',', '.'));
                        const cartTotal = calculateCartTotal();
                        
                        if (isNaN(numericChangeValue) || numericChangeValue <= 0) {
                            showFieldError('change-amount', 'Valor inválido para troco');
                            hasErrors = true;
                        } else if (numericChangeValue <= cartTotal) {
                            showFieldError('change-amount', 
                                `Valor deve ser maior que ${formatCurrency(cartTotal)}.`);
                            hasErrors = true;
                        }
                    }
                }
            }
            
            // If there are errors, stop here
            if (hasErrors) {
                showToast('Por favor, preencha todos os campos obrigatórios', 'error');
                return;
            }
            
            // Update order data only after validation passes
            orderData.customerName = customerName;
            orderData.paymentMethod = paymentMethod;
            orderData.changeAmount = document.getElementById('change-amount')?.value || '';
            orderData.notes = document.getElementById('order-notes').value;
            // Add selected country code to WhatsApp number for sending
            if (customerWhatsApp) {
                const countryCodeSelect = document.getElementById('country-code');
                const selectedCountryCode = countryCodeSelect ? countryCodeSelect.value : '55';
                orderData.customerWhatsApp = selectedCountryCode + customerWhatsApp.replace(/\D/g, '');
            } else {
                orderData.customerWhatsApp = '';
            }
            
            // Show success toast and proceed
            showToast('Preparando seu pedido...', 'success', 2000);
            
            setTimeout(() => {
                sendToWhatsApp();
            }, 1000);
        }

        // Format money input
        // Currency configuration object
        const currencyConfig = {
            // Américas
            'BRL': { symbol: 'R$', decimalSeparator: ',', thousandSeparator: '.', position: 'before' },
            'USD': { symbol: '$', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'CAD': { symbol: 'C$', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'MXN': { symbol: '$', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'ARS': { symbol: '$', decimalSeparator: ',', thousandSeparator: '.', position: 'before' },
            'CLP': { symbol: '$', decimalSeparator: ',', thousandSeparator: '.', position: 'before' },
            'COP': { symbol: '$', decimalSeparator: ',', thousandSeparator: '.', position: 'before' },
            'PEN': { symbol: 'S/', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'PYG': { symbol: '₲', decimalSeparator: ',', thousandSeparator: '.', position: 'before' },
            'UYU': { symbol: '$U', decimalSeparator: ',', thousandSeparator: '.', position: 'before' },
            
            // Europa
            'EUR': { symbol: '€', decimalSeparator: ',', thousandSeparator: '.', position: 'after' },
            'GBP': { symbol: '£', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'CHF': { symbol: 'CHF', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'SEK': { symbol: 'kr', decimalSeparator: ',', thousandSeparator: ' ', position: 'after' },
            'NOK': { symbol: 'kr', decimalSeparator: ',', thousandSeparator: ' ', position: 'after' },
            'DKK': { symbol: 'kr', decimalSeparator: ',', thousandSeparator: '.', position: 'after' },
            'PLN': { symbol: 'zł', decimalSeparator: ',', thousandSeparator: ' ', position: 'after' },
            'CZK': { symbol: 'Kč', decimalSeparator: ',', thousandSeparator: ' ', position: 'after' },
            'HUF': { symbol: 'Ft', decimalSeparator: ',', thousandSeparator: ' ', position: 'after' },
            'RUB': { symbol: '₽', decimalSeparator: ',', thousandSeparator: ' ', position: 'after' },
            'TRY': { symbol: '₺', decimalSeparator: ',', thousandSeparator: '.', position: 'before' },
            'ILS': { symbol: '₪', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            
            // Ásia & Oriente Médio
            'JPY': { symbol: '¥', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'CNY': { symbol: '¥', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'KRW': { symbol: '₩', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'INR': { symbol: '₹', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'IDR': { symbol: 'Rp', decimalSeparator: ',', thousandSeparator: '.', position: 'before' },
            'THB': { symbol: '฿', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'MYR': { symbol: 'RM', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'SGD': { symbol: 'S$', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'AED': { symbol: 'د.إ', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'SAR': { symbol: 'ر.س', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'KWD': { symbol: 'د.ك', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'AFN': { symbol: '؋', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'BDT': { symbol: '৳', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'IRR': { symbol: '﷼', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'LKR': { symbol: 'Rs', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'TWD': { symbol: 'NT$', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'VND': { symbol: '₫', decimalSeparator: ',', thousandSeparator: '.', position: 'after' },
            
            // África
            'AOA': { symbol: 'Kz', decimalSeparator: ',', thousandSeparator: '.', position: 'before' },
            'ZAR': { symbol: 'R', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'NGN': { symbol: '₦', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'EGP': { symbol: 'ج.م', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'KES': { symbol: 'KSh', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'GHS': { symbol: '₵', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'MAD': { symbol: 'د.م.', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'DZD': { symbol: 'د.ج', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'TND': { symbol: 'د.ت', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            
            // Oceania
            'AUD': { symbol: 'A$', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'NZD': { symbol: 'NZ$', decimalSeparator: '.', thousandSeparator: ',', position: 'before' },
            'FJD': { symbol: 'FJ$', decimalSeparator: '.', thousandSeparator: ',', position: 'before' }
        };

        // Get current currency from configuration
        function getCurrentCurrency() {
            const checkoutConfig = getCheckoutConfig();
            return checkoutConfig.checkout_currency || 'BRL';
        }

        // Get currency configuration
        function getCurrencyConfig() {
            const currency = getCurrentCurrency();
            return currencyConfig[currency] || currencyConfig['BRL'];
        }

        // Format currency value for display
        function formatCurrency(value) {
            const config = getCurrencyConfig();
            
            // Converter para número se for string
            const numValue = typeof value === 'string' ? parseFloat(value) : value;
            
            // Separar parte inteira e decimal
            const [integerPart, decimalPart] = numValue.toFixed(2).split('.');
            
            // Aplicar separador de milhares na parte inteira
            const formattedInteger = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, config.thousandSeparator);
            
            // Montar valor final com separador decimal correto
            const formattedValue = `${formattedInteger}${config.decimalSeparator}${decimalPart}`;
            
            if (config.position === 'before') {
                return `${config.symbol} ${formattedValue}`;
            } else {
                return `${formattedValue} ${config.symbol}`;
            }
        }

        function formatMoney(input) {
            const config = getCurrencyConfig();
            let value = input.value.replace(/\D/g, '');
            
            if (value === '') {
                input.value = '';
                return;
            }
            
            // Convert to number and format
            value = parseInt(value);
            value = (value / 100).toFixed(2);
            
            // Format with current currency
            const formattedValue = value.replace('.', config.decimalSeparator);
            if (config.position === 'before') {
                input.value = `${config.symbol} ${formattedValue}`;
            } else {
                input.value = `${formattedValue} ${config.symbol}`;
            }
        }

        // Get numeric value from formatted money
        function getNumericValue(formattedValue) {
            if (!formattedValue) return 0;
            const config = getCurrencyConfig();
            
            // Remove currency symbol and convert back to number
            let cleanValue = formattedValue.replace(config.symbol, '').trim();
            cleanValue = cleanValue.replace(config.decimalSeparator, '.');
            
            return parseFloat(cleanValue) || 0;
        }

        // Send to WhatsApp or Webhook
        function sendToWhatsApp() {
            if (cart.length === 0) return;
            
            // Get configuration data
            const contactInfo = getContactInfo();
            const envioConfig = getEnvioConfig();
            const appConfig = getAppConfig();
            
            console.log('=== DEBUG SEND TO WHATSAPP ===');
            console.log('envioConfig:', envioConfig);
            console.log('whatsapp_web value:', envioConfig.whatsapp_web);
            console.log('webhook_url:', envioConfig.webhook_url);
            console.log('contactInfo:', contactInfo);
            console.log('orderData:', orderData);
            console.log('cart:', cart);
            console.log('==============================');
            
            // Get restaurant name and phone number from configuration
            const restaurantName = appConfig.nome_restaurante || "Cardápio Digital";
            const phoneNumber = contactInfo.whatsapp || "5519998021956";
            
            // Format the order message
            const message = formatOrderMessage(restaurantName);
            console.log('Formatted message:', message);
            
            // Don't clear cart here - only clear after successful webhook/WhatsApp send
            
            // Check sending method based on configuration
            if (envioConfig.whatsapp_web === 'Sim') {
                console.log('Using WhatsApp Web method');
                // Send via WhatsApp Web
                sendViaWhatsAppWeb(phoneNumber, message);
            } else {
                console.log('Using Webhook method');
                // Send via Webhook
                sendViaWebhook(message, envioConfig.webhook_url);
            }
        }
        
        // Format order message
        function formatOrderMessage(restaurantName) {
            console.log('=== DEBUG FORMAT ORDER MESSAGE ===');
            console.log('restaurantName:', restaurantName);
            console.log('orderData:', orderData);
            console.log('cart:', cart);
            console.log('===================================');
            
            let message = `🔔 *NOVO PEDIDO* 🔔\n`;
            message += `━━━━━━━━━━━━━━\n\n`;
            
            // Customer info
            message += `👤 *Cliente:* ${orderData.customerName}\n`;
            if (orderData.customerWhatsApp) {
                message += `📱 *WhatsApp:* ${orderData.customerWhatsApp}\n`;
            }
            
            // Delivery type
            const deliveryTypes = {
                'local': '🍽️ Consumir no Local',
                'pickup': '🥡 Retirar no Balcão', 
                'delivery': '🛵 Delivery',
                'default': '📋 Padrão'
            };
            message += `📍 *Entrega:* ${deliveryTypes[orderData.deliveryType]}\n`;
            
            // Additional info based on delivery type
            if (orderData.deliveryType === 'local' && orderData.tableNumber) {
                message += `🪑 *Mesa/Comanda:* ${orderData.tableNumber}\n`;
            }
            
            // Debug da condição de endereço
            console.log('DEBUG - Condição de endereço:');
            console.log('deliveryType:', orderData.deliveryType);
            console.log('orderData.address:', orderData.address);
            console.log('orderData.address.street:', orderData.address.street);
            console.log('Condição atendida?', orderData.deliveryType === 'delivery' && orderData.address.street);
            
            if (orderData.deliveryType === 'delivery' && orderData.address.street) {
                message += `🏠 *Endereço:*\n`;
                
                // Verificar se é endereço manual ou automático
                console.log('DEBUG - Verificando tipo de endereço:');
                console.log('isManual:', orderData.address.isManual);
                console.log('deliveryFee:', orderData.address.deliveryFee);
                
                if (orderData.address.isManual) {
                    // Endereço manual - formato diferenciado
                    message += `   ${orderData.address.street}\n`;
                    message += `   ${orderData.address.neighborhood}\n`;
                    message += `   ${orderData.address.city}\n`;
                    message += `   *Endereço informado manualmente*\n`;
                } else {
                    // Endereço automático via CEP - formato original
                    message += `   ${orderData.address.street}, ${orderData.address.number}`;
                    if (orderData.address.complement) {
                        message += ` - ${orderData.address.complement}`;
                    }
                    message += `\n   ${orderData.address.neighborhood}\n`;
                    message += `   ${orderData.address.city} - ${orderData.address.state}\n`;
                    message += `   CEP: ${orderData.address.cep}\n`;
                }
                
                // Adicionar taxa de delivery se existir (funciona para ambos os modos)
                console.log('DEBUG - Verificando taxa de delivery:');
                console.log('orderData.address:', orderData.address);
                console.log('orderData.address.deliveryFee:', orderData.address.deliveryFee);
                console.log('currentDeliveryFee:', currentDeliveryFee);
                
                // Usar orderData.address.deliveryFee ou currentDeliveryFee como fallback
                const deliveryFee = orderData.address.deliveryFee || currentDeliveryFee;
                console.log('deliveryFee final:', deliveryFee);
                
                if (deliveryFee && deliveryFee > 0) {
                    message += `\n🚚 *Taxa de Delivery:* ${formatCurrency(deliveryFee)} (${orderData.address.neighborhood})\n`;
                    console.log('Taxa de delivery adicionada à mensagem:', deliveryFee);
                } else {
                    console.log('Taxa de delivery NÃO adicionada - nenhuma taxa encontrada');
                }
            }
            
            message += `\n━━━━━━━━━━━━━━\n`;
            message += `🛍️ *ITENS DO PEDIDO:*\n\n`;
            
            // Items
            cart.forEach(item => {
                const itemSubtotal = item.preco * item.quantity;
                message += `• *${item.nome}* (${item.sku})\n`;
                if (item.variationText) {
                    message += `  └ Opções: ${item.variationText}\n`;
                }
                if (item.notes) {
                    message += `  └ Obs: ${item.notes}\n`;
                }
                message += `  └ Qtd: ${item.quantity}x | Unitário: ${formatCurrency(item.preco)} | Subtotal: ${formatCurrency(itemSubtotal)}\n\n`;
            });
            
            // Total com breakdown detalhado
            let subtotal = cart.reduce((sum, item) => sum + (item.preco * item.quantity), 0);
            let total = subtotal;
            
            // Adicionar taxa de delivery ao total se existir
            console.log('DEBUG - Calculando total com taxa:');
            console.log('Subtotal produtos:', subtotal);
            console.log('deliveryType:', orderData.deliveryType);
            console.log('address:', orderData.address);
            
            // Usar orderData.address.deliveryFee ou currentDeliveryFee como fallback
            const totalDeliveryFee = (orderData.address && orderData.address.deliveryFee) || currentDeliveryFee;
            console.log('totalDeliveryFee:', totalDeliveryFee);
            
            if (orderData.deliveryType === 'delivery' && totalDeliveryFee && totalDeliveryFee > 0) {
                total += totalDeliveryFee;
                console.log('Taxa adicionada ao total:', totalDeliveryFee);
            }
            
            message += `━━━━━━━━━━━━━━\n`;
            message += `💰 *RESUMO FINANCEIRO:*\n\n`;
            
            // Breakdown detalhado
            message += `💵 Subtotal produtos: ${formatCurrency(subtotal)}\n`;
            
            if (orderData.deliveryType === 'delivery' && totalDeliveryFee && totalDeliveryFee > 0) {
                message += `🚚 Taxa de delivery: ${formatCurrency(totalDeliveryFee)}\n`;
            }
            
            // Adicionar informações do cupom se aplicado
            if (appliedCoupon && couponDiscount > 0) {
                const discountType = appliedCoupon.tipo_desconto || appliedCoupon.tipo || '';
                let typeText = '';
                
                switch (discountType.toLowerCase()) {
                    case 'produtos':
                        typeText = 'nos produtos';
                        break;
                    case 'frete':
                        typeText = 'no frete';
                        break;
                    case 'total':
                        typeText = 'no total';
                        break;
                }
                
                message += `🎟️ Cupom ${appliedCoupon.codigo_cupom || appliedCoupon.codigo}: -${formatCurrency(couponDiscount)} (${typeText})\n`;
                total = Math.max(0, total - couponDiscount);
                console.log('Desconto aplicado:', couponDiscount, 'Total final:', total);
            }
            
            message += `\n💰 *TOTAL FINAL: ${formatCurrency(total)}*\n`;
            message += `━━━━━━━━━━━━━━\n`;
            
            // Payment info (only for pickup, delivery, default AND if payment field is enabled)
            const checkoutConfig = getCheckoutConfig();
            const deliveryTypesWithPayment = ['pickup', 'delivery', 'default'];
            if (deliveryTypesWithPayment.includes(orderData.deliveryType) && checkoutConfig.step3_show_formas_pag === 'Sim') {
                // Get payment methods from spreadsheet configuration
                const configuredMethods = checkoutConfig.step3_formas_pag;
                const paymentMethods = {};
                
                if (configuredMethods && configuredMethods.trim() !== '') {
                    // Parse configured payment methods
                    const methodsList = configuredMethods.split(',').map(method => method.trim());
                    
                    // Create dynamic mapping with emojis
                    methodsList.forEach(method => {
                        const methodKey = method.toLowerCase().replace(/\s+/g, '-');
                        let emoji = '💳'; // Default credit card emoji
                        
                        // Assign specific emojis based on method name
                        if (method.toLowerCase().includes('dinheiro')) {
                            emoji = '💵';
                        } else if (method.toLowerCase().includes('pix')) {
                            emoji = '📱';
                        } else if (method.toLowerCase().includes('cartão') || method.toLowerCase().includes('cartao')) {
                            emoji = '💳';
                        } else if (method.toLowerCase().includes('alelo') || method.toLowerCase().includes('vale') || method.toLowerCase().includes('ticket')) {
                            emoji = '🎫'; // Simpler ticket emoji
                        }
                        
                        paymentMethods[methodKey] = `${emoji} ${method}`;
                    });
                }
                
                // Só incluir se paymentMethod estiver definido
                if (orderData.paymentMethod && paymentMethods[orderData.paymentMethod]) {
                    message += `\n💳 *Pagamento:* ${paymentMethods[orderData.paymentMethod]}\n`;
                    
                    if (orderData.paymentMethod === 'dinheiro' && orderData.changeAmount) {
                        const changeValue = getNumericValue(orderData.changeAmount);
                        message += `💸 *Troco para:* ${formatCurrency(changeValue)}\n`;
                    }
                    message += `━━━━━━━━━━━━━━\n`;
                }
            }
            
            // Notes
            if (orderData.notes) {
                message += `\n📝 *Observações:*\n${orderData.notes}\n`;
                message += `━━━━━━━━━━━━━━\n`;
            }
            
            message += `\n⏰ *Pedido realizado em:* ${new Date().toLocaleString('pt-BR')}\n`;
            message += `\n✅ *Aguardando confirmação do restaurante*`;
            
            return message;
        }
        
        // Send via WhatsApp Web (cross-platform)
        function sendViaWhatsAppWeb(phoneNumber, message) {
            console.log('=== DEBUG WHATSAPP WEB ===');
            console.log('phoneNumber:', phoneNumber);
            console.log('message length:', message.length);
            console.log('message preview:', message.substring(0, 100) + '...');
            
            // Use standard encodeURIComponent which properly handles emojis
            const encodedMessage = encodeURIComponent(message);
            console.log('encodedMessage length:', encodedMessage.length);
            
            // Use api.whatsapp.com like ref.html for better compatibility
            const whatsappUrl = `https://api.whatsapp.com/send?phone=${phoneNumber}&text=${encodedMessage}`;
            console.log('whatsappUrl:', whatsappUrl.substring(0, 150) + '...');
            
            // Show success message
            showCustomAlert('Pedido enviado com sucesso! Redirecionando para WhatsApp...', 'success');
            
            // Reset completo do sistema após preparação do WhatsApp
            resetSystemAfterOrder();
            console.log('Sistema resetado completamente após envio');
            
            // Delay to show success message, then open WhatsApp
            setTimeout(() => {
                console.log('Attempting to open WhatsApp...');
                try {
                    // Try to open in new window with fallback like ref.html
                    console.log('Trying to open in new window...');
                    const newWindow = window.open(whatsappUrl, '_blank');
                    console.log('New window result:', newWindow);
                    
                    if (!newWindow || newWindow.closed || typeof newWindow.closed === 'undefined') {
                        // If failed to open in new window, try same window
                        console.log('Fallback: Opening in same window');
                        window.location.href = whatsappUrl;
                    } else {
                        console.log('Successfully opened WhatsApp in new window');
                    }
                } catch (error) {
                    console.error('Error opening window:', error);
                    // Fallback to wa.me if api.whatsapp.com fails
                    try {
                        const waUrl = `https://wa.me/${phoneNumber}?text=${encodedMessage}`;
                        console.log('Trying alternative method:', waUrl);
                        window.location.href = waUrl;
                    } catch (fallbackError) {
                        console.error('Fallback method failed:', fallbackError);
                        showCustomAlert('Não foi possível abrir o WhatsApp. Tente novamente.', 'error');
                    }
                }
            }, 1500);
        }
        
        /**
         * Reset completo do sistema após envio do pedido
         */
        function resetSystemAfterOrder() {
            console.log('=== RESET COMPLETO DO SISTEMA ===');
            
            // 1. Limpar carrinho
            cart = [];
            updateCartUI();
            
            // 2. Reset orderData
            orderData = {
                customerName: '',
                customerWhatsApp: '',
                deliveryType: '',
                address: {},
                tableNumber: '',
                paymentMethod: '',
                changeAmount: '',
                notes: ''
            };
            
            // 3. Reset taxa de delivery
            currentDeliveryFee = null;
            clearDeliveryFee();
            
            // 4. Reset todos os radio buttons
            const radioButtons = document.querySelectorAll('input[type="radio"]');
            radioButtons.forEach(radio => {
                radio.checked = false;
            });
            
            // 5. Reset todos os campos de input
            const inputs = document.querySelectorAll('input[type="text"], input[type="tel"], textarea');
            inputs.forEach(input => {
                input.value = '';
            });
            
            // 6. Ocultar campos de endereço
            const addressFields = document.getElementById('address-fields');
            if (addressFields) {
                addressFields.classList.add('hidden');
            }
            
            // 7. Reset step atual para step 1
            currentStep = 1;
            
            // 8. Reset sistema de cupons
            resetCouponSystem();
            
            // 9. Fechar checkout
            closeCheckout();
            
            console.log('Sistema resetado completamente');
            console.log('orderData após reset:', orderData);
            console.log('cart após reset:', cart);
            console.log('currentDeliveryFee após reset:', currentDeliveryFee);
        }
        
        // Send via Webhook
        function sendViaWebhook(message, webhookUrl) {
            console.log('=== DEBUG WEBHOOK ===');
            console.log('appConfig completo:', appConfig);
            console.log('envio config:', appConfig.envio);
            console.log('webhook_url da config:', appConfig.envio?.webhook_url);
            console.log('webhookUrl recebido como parâmetro:', webhookUrl);
            console.log('=====================');
            
            if (!webhookUrl || webhookUrl.trim() === '') {
                showCustomAlert('Erro: URL do webhook não configurada. Verifique as configurações.', 'error');
                return;
            }
            
            console.log('Enviando webhook para:', webhookUrl);
            console.log('Dados do pedido:', orderData);
            console.log('Carrinho:', cart);
            
            // Get admin WhatsApp from configuration
            const contactInfo = getContactInfo();
            const adminWhatsApp = contactInfo.whatsapp || '';
            
            // Calculate total
            const orderTotal = cart.reduce((sum, item) => sum + (item.preco * item.quantity), 0);
            
            // Prepare order data for webhook with specific fields
            const orderPayload = {
                // Main requested fields
                whatsapp_admin: adminWhatsApp,
                whatsapp_customer: orderData.customerWhatsApp || '',
                customer_name: orderData.customerName,
                timestamp: new Date().toISOString(),
                total: orderTotal,
                whatsapp_message: message,
                formatted_message: message,
                
                // Additional order details
                customer: {
                    name: orderData.customerName,
                    delivery_type: orderData.deliveryType,
                    table_number: orderData.tableNumber || null,
                    address: orderData.address || null,
                    payment_method: orderData.paymentMethod,
                    change_amount: orderData.changeAmount || null,
                    notes: orderData.notes || null
                },
                items: cart.map(item => ({
                    id: item.id,
                    name: item.nome,
                    sku: item.sku,
                    price: item.preco,
                    quantity: item.quantity,
                    subtotal: item.preco * item.quantity,
                    variations: item.variationText || null,
                    notes: item.notes || null
                })),
                currency: getCurrentCurrency()
            };
            
            console.log('Payload do webhook:', JSON.stringify(orderPayload, null, 2));
            
            // Show loading message
            showCustomAlert('Enviando pedido...', 'info');
            
            // Try POST first, fallback to GET if CORS issues
            function tryPostRequest() {
                return fetch(webhookUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(orderPayload)
                });
            }
            
            function tryGetRequest() {
                console.log('Tentando envio via GET como fallback...');
                // Encode payload as URL parameters for GET request
                const params = new URLSearchParams();
                params.append('data', JSON.stringify(orderPayload));
                params.append('whatsapp_admin', adminWhatsApp);
                params.append('whatsapp_customer', orderData.customerWhatsApp || '');
                params.append('customer_name', orderData.customerName);
                params.append('timestamp', new Date().toISOString());
                params.append('total', orderTotal);
                params.append('whatsapp_message', message);
                
                const getUrl = `${webhookUrl}?${params.toString()}`;
                console.log('URL GET:', getUrl);
                
                return fetch(getUrl, {
                    method: 'GET',
                    mode: 'no-cors' // This helps with CORS issues
                });
            }
            
            // Try POST first
            tryPostRequest()
            .then(response => {
                console.log('Resposta do webhook POST:', response.status, response.statusText);
                if (response.ok) {
                    showCustomAlert('Pedido enviado com sucesso!', 'success');
                    // Reset completo do sistema após webhook bem-sucedido
                    resetSystemAfterOrder();
                } else {
                    return response.text().then(text => {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}. Resposta: ${text}`);
                    });
                }
            })
            .catch(postError => {
                console.error('Erro no POST, tentando GET:', postError);
                
                // Try GET as fallback
                tryGetRequest()
                .then(response => {
                    console.log('Resposta do webhook GET:', response);
                    
                    // With no-cors mode, we can't read the response status
                    // But if we reach here without error, the request was sent
                    // Let's wait a moment and then show success
                    setTimeout(() => {
                        showCustomAlert('Pedido enviado! Verifique se chegou no webhook.', 'success');
                        // Reset completo do sistema
                        resetSystemAfterOrder();
                    }, 1000); // Wait 1 second to give time for the webhook to process
                })
                .catch(getError => {
                    console.error('Erro no GET também:', getError);
                    // Only show error if it's a real network error
                    if (getError.name === 'TypeError' && getError.message.includes('Failed to fetch')) {
                        showCustomAlert('Erro de conexão: Não foi possível enviar o pedido. Verifique a URL do webhook.', 'error');
                    } else {
                        showCustomAlert(`Erro ao enviar pedido: ${getError.message}`, 'error');
                    }
                });
            });
        }

        // Scroll to category
        function scrollToCategory(category) {
            // Scroll to section
            if (category === 'all') {
                updateActiveCategory(category);
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }
            
            // Wait for data to be loaded and DOM to be ready
            if (!isDataLoaded) {
                setTimeout(() => scrollToCategory(category), 200);
                return;
            }
            
            // Update active category immediately for better UX
            updateActiveCategory(category);
            
            // Perform scroll without additional delay
            requestAnimationFrame(() => {
                // Function to perform the scroll with multiple fallback strategies
                function performScroll() {
                    // Strategy 1: Try exact ID match
                    let section = document.getElementById(category);
                    
                    // Strategy 2: If not found, try to find by data-category in sections
                    if (!section) {
                        section = document.querySelector(`section[data-category="${category}"]`);
                    }
                    
                    // Strategy 3: Try to find section containing items with matching category
                    if (!section) {
                        const categoryItem = document.querySelector(`[data-category="${category}"]`);
                        if (categoryItem) {
                            // Look for a section that might contain this category's items
                            const allSections = document.querySelectorAll('section[id]');
                            for (const sec of allSections) {
                                if (sec.id === category || sec.id.includes(category) || category.includes(sec.id)) {
                                    section = sec;
                                    break;
                                }
                            }
                        }
                    }
                    
                    if (section) {
                        const offset = 150; // Account for sticky headers
                        const elementPosition = section.offsetTop - offset;
                        window.scrollTo({ 
                            top: Math.max(0, elementPosition), 
                            behavior: 'smooth' 
                        });
                        return true;
                    }
                    return false;
                }
                
                // Try immediate scroll
                if (performScroll()) {
                    return;
                }
                
                // If section not found, try multiple retries
                let retryCount = 0;
                const maxRetries = 5;
                
                function retryScroll() {
                    if (retryCount >= maxRetries) {
                        // Final fallback: scroll to first section if category exists in menu
                        const firstSection = document.querySelector('section[id]');
                        if (firstSection) {
                            window.scrollTo({ top: firstSection.offsetTop - 150, behavior: 'smooth' });
                        }
                        return;
                    }
                    
                    retryCount++;
                    const delay = retryCount * 200; // 200ms, 400ms, 600ms, etc.
                    
                    setTimeout(() => {
                        if (!performScroll()) {
                            retryScroll();
                        }
                    }, delay);
                }
                
                retryScroll();
            }, 100); // Initial delay to ensure DOM rendering
        }

        // Setup scroll spy
        function setupScrollSpy() {
            // Get dynamic sections from categoriesData
            const sections = categoriesData
                .filter(cat => cat.status === 'Ativo')
                .sort((a, b) => parseInt(a.ordem) - parseInt(b.ordem))
                .map(cat => cat.nome_categoria);
            
            window.addEventListener('scroll', () => {
                const scrollPosition = window.scrollY + 200;
                
                for (let i = sections.length - 1; i >= 0; i--) {
                    const section = document.getElementById(sections[i]);
                    if (section && section.offsetTop <= scrollPosition) {
                        updateActiveCategory(sections[i]);
                        break;
                    }
                }
                
                if (window.scrollY < 100) {
                    updateActiveCategory('all');
                }
            });
        }

        // Update active category
        function updateActiveCategory(category) {
            // Use requestAnimationFrame for smoother updates
            requestAnimationFrame(() => {
                document.querySelectorAll('.category-item').forEach(item => {
                    const isActive = item.getAttribute('data-category') === category;
                    
                    if (isActive) {
                        item.classList.add('active');
                        item.style.backgroundColor = 'var(--cor-primaria)';
                        item.style.color = 'white';
                        item.style.borderColor = 'var(--cor-primaria)';
                    } else {
                        item.classList.remove('active');
                        
                        // Reset styles only for non-"Todos" buttons
                        if (item.getAttribute('data-category') !== 'all') {
                            item.style.backgroundColor = '';
                            item.style.color = '';
                            item.style.borderColor = '';
                        } else {
                            // For "Todos" button, restore original styles when not active
                            item.style.backgroundColor = 'var(--cor-primaria)';
                            item.style.color = 'white';
                            item.style.borderColor = '';
                        }
                        
                        item.onmouseenter = null;
                        item.onmouseleave = null;
                    }
                });
                
                const activeItem = document.querySelector(`[data-category="${category}"]`);
                if (activeItem) {
                    // Centralizar a categoria ativa no menu horizontal
                    centerActiveCategory(activeItem);
                }
            });
        }

        // Centralizar categoria ativa no scroll horizontal
        function centerActiveCategory(activeItem) {
            const categoriesNav = document.getElementById('category-nav');
            if (!categoriesNav) return;
            
            const containerWidth = categoriesNav.offsetWidth;
            const itemWidth = activeItem.offsetWidth;
            const itemOffsetLeft = activeItem.offsetLeft;
            
            // Calcular posição para centralizar o item
            const scrollPosition = itemOffsetLeft - (containerWidth / 2) + (itemWidth / 2);
            
            // Scroll suave para a posição calculada
            categoriesNav.scrollTo({
                left: scrollPosition,
                behavior: 'smooth'
            });
        }

        // Setup search
        function setupSearch() {
            const searchInput = document.getElementById('search');
            const clearBtn = document.getElementById('clear-search');
            
            // Search on input
            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.trim();
                
                // Show/hide clear button
                if (query.length > 0) {
                    clearBtn.classList.remove('hidden');
                } else {
                    clearBtn.classList.add('hidden');
                }
                
                performSearchWithQuery(query);
            });
            
            // Search on Enter key
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    performSearch();
                }
            });
        }
        
        // Perform search
        function performSearch() {
            const searchInput = document.getElementById('search');
            const query = searchInput.value.trim().toLowerCase();
            
            if (query.length === 0) {
                showToast('Digite algo para pesquisar', 'warning', 2000);
                searchInput.focus();
                return;
            }
            
            performSearchWithQuery(query);
            
            // Show feedback
            const results = document.querySelectorAll('.food-card:not([style*="display: none"])').length;
            if (results === 0) {
                showToast('Nenhum prato encontrado para sua busca', 'warning', 3000);
            } else {
                showToast(`${results} prato${results > 1 ? 's' : ''} encontrado${results > 1 ? 's' : ''}`, 'success', 2000);
            }
        }
        
        // Perform search with query
        function performSearchWithQuery(query) {
            const searchQuery = query.toLowerCase().trim();
            const cards = document.querySelectorAll('.food-card');
            
            if (cards.length === 0) {
                console.warn('Nenhum card encontrado para busca');
                return;
            }
            
            let visibleCount = 0;
            cards.forEach(card => {
                try {
                    // Buscar por múltiplos seletores para maior compatibilidade
                    const nameElement = card.querySelector('h3') || card.querySelector('.font-semibold');
                    const descElement = card.querySelector('p') || card.querySelector('.description');
                    const skuElement = card.querySelector('.text-xs') || card.querySelector('.font-mono');
                    
                    let shouldShow = false;
                    
                    // Se query está vazia, mostrar todos
                    if (searchQuery === '') {
                        shouldShow = true;
                    } else {
                        // Buscar no nome
                        if (nameElement && nameElement.textContent.toLowerCase().includes(searchQuery)) {
                            shouldShow = true;
                        }
                        
                        // Buscar na descrição
                        if (!shouldShow && descElement && descElement.textContent.toLowerCase().includes(searchQuery)) {
                            shouldShow = true;
                        }
                        
                        // Buscar no SKU
                        if (!shouldShow && skuElement && skuElement.textContent.toLowerCase().includes(searchQuery)) {
                            shouldShow = true;
                        }
                        
                        // Buscar em todo o texto do card como fallback
                        if (!shouldShow && card.textContent.toLowerCase().includes(searchQuery)) {
                            shouldShow = true;
                        }
                    }
                    
                    // Aplicar visibilidade
                    if (shouldShow) {
                        card.style.display = 'block';
                        card.style.opacity = '1';
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                        card.style.opacity = '0';
                    }
                    
                } catch (error) {
                    console.error('Erro ao processar card na busca:', error);
                    // Em caso de erro, manter o card visível
                    card.style.display = 'block';
                    card.style.opacity = '1';
                }
            });
            
            // Atualizar contadores e feedback visual
            updateSearchResults(visibleCount, searchQuery);
        }
        
        // Update search results feedback
        function updateSearchResults(visibleCount, query) {
            if (query && query.length > 0) {
                if (visibleCount === 0) {
                    showToast('Nenhum prato encontrado para sua busca', 'warning', 3000);
                } else {
                    showToast(`${visibleCount} prato${visibleCount > 1 ? 's' : ''} encontrado${visibleCount > 1 ? 's' : ''}`, 'success', 2000);
                }
            }
        }
        
        // Clear search
        function clearSearch() {
            const searchInput = document.getElementById('search');
            const clearBtn = document.getElementById('clear-search');
            
            searchInput.value = '';
            clearBtn.classList.add('hidden');
            
            // Show all items with improved reset
            document.querySelectorAll('.food-card').forEach(card => {
                card.style.display = 'block';
                card.style.opacity = '1';
            });
            
            showToast('Busca limpa! Mostrando todos os pratos', 'success', 2000);
            searchInput.focus();
        }

        // Find product by ID
        function findProductById(id) {
            for (const category of Object.values(menuData)) {
                const product = category.find(item => item.id === id);
                if (product) return product;
            }
            return null;
        }

        // Share general page
        function shareGeneral() {
            const url = window.location.href.split('#')[0];
            const companyName = getCompanyName();
            const slogan = getSlogan();
            const text = `🍽️ Confira o cardápio do ${companyName} - ${slogan}!`;
            const shareText = `${text}\n${url}`;
            
            navigator.clipboard.writeText(shareText).then(() => {
                showToast('📋 Link do cardápio copiado! Cole e compartilhe com seus amigos', 'success', 3000);
            }).catch(() => {
                // Fallback se clipboard não funcionar
                showToast('❌ Não foi possível copiar automaticamente', 'error', 2000);
                setTimeout(() => {
                    prompt('Copie o link manualmente:', url);
                }, 500);
            });
        }

        // Share specific category
        function shareCategory(category) {
            // Get category display name from dynamic data
            const categoryData = categoriesData.find(cat => cat.nome_categoria === category);
            const categoryName = categoryData ? categoryData.titulo_exibicao : category;
            const companyName = getCompanyName();
            
            const url = `${window.location.href.split('#')[0]}#${category}`;
            const text = `🍽️ Confira ${categoryName} do ${companyName}!`;
            const shareText = `${text}\n${url}`;
            
            navigator.clipboard.writeText(shareText).then(() => {
                showToast(`📋 Link de ${categoryName} copiado! Compartilhe essa delícia`, 'success', 3000);
            }).catch(() => {
                // Fallback se clipboard não funcionar
                showToast('❌ Não foi possível copiar automaticamente', 'error', 2000);
                setTimeout(() => {
                    prompt('Copie o link da categoria:', url);
                }, 500);
            });
        }

        // Handle initial hash navigation
        function handleInitialHash() {
            const hash = window.location.hash.substring(1);
            if (hash && categoriesData) {
                const validCategories = categoriesData
                    .filter(cat => cat.status === 'Ativo')
                    .map(cat => cat.nome_categoria);
                
                if (validCategories.includes(hash)) {
                    setTimeout(() => {
                        scrollToCategory(hash);
                    }, 1000); // Increased delay to ensure data is loaded
                }
            }
        }

        // Scroll field to center when focused (mobile keyboard fix)
        function scrollToField(field) {
            setTimeout(() => {
                const modal = document.querySelector('#product-modal .slide-up');
                if (!modal) return;
                
                const fieldRect = field.getBoundingClientRect();
                const modalRect = modal.getBoundingClientRect();
                const viewportHeight = window.innerHeight;
                
                // Calculate the position to center the field in the visible area
                const fieldCenter = fieldRect.top + (fieldRect.height / 2);
                const targetCenter = viewportHeight / 2;
                const scrollOffset = fieldCenter - targetCenter;
                
                // Scroll the modal container to center the field
                modal.scrollBy({
                    top: scrollOffset,
                    behavior: 'smooth'
                });
            }, 300); // Delay to allow keyboard to appear
        }

        // Reset modal scroll when field loses focus
        function resetModalScroll() {
            setTimeout(() => {
                const modal = document.querySelector('#product-modal .slide-up');
                if (!modal) return;
                
                // Smooth scroll back to top of modal
                modal.scrollTo({
                    top: 0,
                    behavior: 'smooth'
                });
            }, 100);
        }

        // Open lightbox
        function openLightbox(imageSrc, title) {
            const lightbox = document.getElementById('image-lightbox');
            const lightboxImage = document.getElementById('lightbox-image');
            const lightboxTitle = document.getElementById('lightbox-title');
            
            lightboxImage.src = imageSrc;
            lightboxTitle.textContent = title;
            
            lightbox.classList.remove('hidden');
            
            // Prevent body scroll
            document.body.style.overflow = 'hidden';
        }

        // Close lightbox
        function closeLightbox(event) {
            if (event && event.target !== event.currentTarget && !event.target.closest('button')) {
                return;
            }
            
            const lightbox = document.getElementById('image-lightbox');
            lightbox.classList.add('hidden');
            
            // Restore body scroll
            document.body.style.overflow = '';
        }

        // Close lightbox on ESC key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                const lightbox = document.getElementById('image-lightbox');
                if (!lightbox.classList.contains('hidden')) {
                    closeLightbox();
                }
            }
        });

        // Operating Hours Functions
        async function updateOperatingHours() {
            try {
                // Fetch CSV data directly for real-time updates
                const response = await fetch(HOURS_CSV_URL);
                const csvText = await response.text();
                
                // Parse CSV manually
                const lines = csvText.trim().split('\n');
                
                // Extract timezone from first line (format: "Time Zone,Australia/Sydney")
                let timezone = 'America/Sao_Paulo'; // Default timezone
                if (lines[0] && lines[0].includes('Time Zone')) {
                    const timezoneLine = lines[0].split(',');
                    if (timezoneLine.length > 1 && timezoneLine[1].trim()) {
                        timezone = timezoneLine[1].trim();
                    }
                }
                
                const headers = lines[1].split(','); // Use second line as headers
                
                // Get current time in the specified timezone
                const now = new Date();
                const timezoneDate = new Date(now.toLocaleString("en-US", {timeZone: timezone}));
                const dayOfWeek = getDayOfWeekInPortuguese(timezoneDate.getDay());
                const currentTime = timezoneDate.getHours() * 60 + timezoneDate.getMinutes(); // Convert to minutes
                
                // Find today's schedule from CSV data
                let todaySchedule = null;
                for (let i = 2; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    const dayName = values[0];
                    if (dayName && dayName.toLowerCase().trim() === dayOfWeek.toLowerCase()) {
                        todaySchedule = {
                            day: dayName,
                            period1: values[1],
                            period2: values[2],
                            period3: values[3]
                        };
                        break;
                    }
                }
                
                if (!todaySchedule) {
                    console.log('No schedule found for today:', dayOfWeek);
                    return;
                }
                
                const isOpen = checkIfOpenFromPeriods(todaySchedule, currentTime);
                const nextCloseTime = getNextCloseTimeFromPeriods(todaySchedule, currentTime);
                
                // Update status indicator
                const statusText = document.getElementById('status-text');
                const hoursText = document.getElementById('hours-text');
                const statusDot = document.getElementById('status-dot');
                
                if (statusText && hoursText && statusDot) {
                    statusText.textContent = isOpen ? 'Aberto' : 'Fechado';
                    statusText.className = 'font-medium';
                    statusText.style.color = isOpen ? 'var(--cor-sucesso)' : 'var(--cor-erro)';
                    
                    statusDot.className = 'w-2 h-2 rounded-full';
                    statusDot.style.backgroundColor = isOpen ? 'var(--cor-sucesso)' : 'var(--cor-erro)';
                    
                    if (isOpen && nextCloseTime) {
                        hoursText.textContent = `até ${nextCloseTime}`;
                    } else if (!isOpen) {
                        const nextOpenTime = getNextOpenTimeFromPeriods(todaySchedule, currentTime);
                        if (nextOpenTime) {
                            hoursText.textContent = `Abre às ${nextOpenTime}`;
                        } else {
                            hoursText.textContent = 'Hoje';
                        }
                    } else {
                        hoursText.textContent = dayOfWeek;
                    }
                }
                
            } catch (error) {
                console.error('Error updating operating hours:', error);
                // Fallback to static display
                const statusText = document.getElementById('status-text');
                const hoursText = document.getElementById('hours-text');
                const statusDot = document.getElementById('status-dot');
                
                if (statusText && hoursText && statusDot) {
                    statusText.textContent = 'Aberto';
                    statusText.className = 'font-medium';
                    statusText.style.color = 'var(--cor-sucesso)';
                    statusDot.className = 'w-2 h-2 rounded-full';
                    statusDot.style.backgroundColor = 'var(--cor-sucesso)';
                    hoursText.textContent = 'até 23h';
                }
            }
        }

        function getDayOfWeekInPortuguese(dayIndex) {
            const days = [
                'domingo', 'segunda-feira', 'terça-feira', 'quarta-feira',
                'quinta-feira', 'sexta-feira', 'sábado'
            ];
            return days[dayIndex];
        }

        function timeToMinutes(timeStr) {
            if (!timeStr) return 0;
            const [hours, minutes] = timeStr.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        function checkIfOpen(schedule, currentTime) {
            // Get time periods - new format with Período 1, 2, 3
            const periods = [
                schedule['Período 1'] || schedule['Período 1 '] || schedule[' Período 1'] || schedule[' Período 1 '],
                schedule['Período 2'] || schedule['Período 2 '] || schedule[' Período 2'] || schedule[' Período 2 '],
                schedule['Período 3'] || schedule['Período 3 '] || schedule[' Período 3'] || schedule[' Período 3 ']
            ];
            
            // Check all periods
            for (const periodTime of periods) {
                if (periodTime && periodTime.trim() && periodTime.trim() !== '') {
                    // Parse time range (e.g., "8:00 - 12:00")
                    const timeRange = periodTime.split(' - ');
                    if (timeRange.length === 2) {
                        const startTime = timeToMinutes(timeRange[0].trim());
                        let endTime = timeToMinutes(timeRange[1].trim());
                        
                        // Handle midnight crossing (00:00)
                        if (endTime === 0) endTime = 24 * 60; // 24:00 in minutes
                        
                        if (currentTime >= startTime && currentTime < endTime) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }
        
        function checkIfOpenFromPeriods(schedule, currentTime) {
            // Get time periods from CSV format
            const periods = [schedule.period1, schedule.period2, schedule.period3];
            
            // Check all periods
            for (const periodTime of periods) {
                if (periodTime && periodTime.trim() && periodTime.trim() !== '') {
                    // Parse time range (e.g., "8:00-12:00")
                    const timeRange = periodTime.split('-');
                    if (timeRange.length === 2) {
                        const startTime = timeToMinutes(timeRange[0].trim());
                        let endTime = timeToMinutes(timeRange[1].trim());
                        
                        // Handle midnight crossing (00:00)
                        if (endTime === 0) endTime = 24 * 60; // 24:00 in minutes
                        
                        if (currentTime >= startTime && currentTime < endTime) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }

        function getNextCloseTime(schedule, currentTime) {
            // Get time periods - new format with Período 1, 2, 3
            const periods = [
                schedule['Período 1'] || schedule['Período 1 '] || schedule[' Período 1'] || schedule[' Período 1 '],
                schedule['Período 2'] || schedule['Período 2 '] || schedule[' Período 2'] || schedule[' Período 2 '],
                schedule['Período 3'] || schedule['Período 3 '] || schedule[' Período 3'] || schedule[' Período 3 ']
            ];
            
            // Check all periods to find which one we're in
            for (const periodTime of periods) {
                if (periodTime && periodTime.trim() && periodTime.trim() !== '') {
                    // Parse time range (e.g., "8:00 - 12:00")
                    const timeRange = periodTime.split(' - ');
                    if (timeRange.length === 2) {
                        const startTime = timeToMinutes(timeRange[0].trim());
                        let endTime = timeToMinutes(timeRange[1].trim());
                        
                        // Handle midnight crossing
                        if (endTime === 0) {
                            return '00h';
                        }
                        
                        if (currentTime >= startTime && currentTime < endTime) {
                            const hours = Math.floor(endTime / 60);
                            const minutes = endTime % 60;
                            if (minutes === 0) {
                                return `${hours}h`;
                            } else {
                                return `${hours}h${minutes.toString().padStart(2, '0')}`;
                            }
                        }
                    }
                }
            }
            return null;
        }

        function getNextOpenTime(schedule, currentTime) {
            // Get time periods - new format with Período 1, 2, 3
            const periods = [
                schedule['Período 1'] || schedule['Período 1 '] || schedule[' Período 1'] || schedule[' Período 1 '],
                schedule['Período 2'] || schedule['Período 2 '] || schedule[' Período 2'] || schedule[' Período 2 '],
                schedule['Período 3'] || schedule['Período 3 '] || schedule[' Período 3'] || schedule[' Período 3 ']
            ];
            
            // Find the next opening time
            for (const periodTime of periods) {
                if (periodTime && periodTime.trim() && periodTime.trim() !== '') {
                    // Parse time range (e.g., "8:00 - 12:00")
                    const timeRange = periodTime.split(' - ');
                    if (timeRange.length === 2) {
                        const startTime = timeToMinutes(timeRange[0].trim());
                        const endTime = timeToMinutes(timeRange[1].trim());
                        
                        // If current time is before this period starts
                        if (currentTime < startTime) {
                            const hours = Math.floor(startTime / 60);
                            const minutes = startTime % 60;
                            if (minutes === 0) {
                                return `${hours}h`;
                            } else {
                                return `${hours}h${minutes.toString().padStart(2, '0')}`;
                            }
                        }
                    }
                }
            }
            return null;
        }
        
        function getNextCloseTimeFromPeriods(schedule, currentTime) {
            // Get time periods from CSV format
            const periods = [schedule.period1, schedule.period2, schedule.period3];
            
            // Check all periods to find which one we're in
            for (const periodTime of periods) {
                if (periodTime && periodTime.trim() && periodTime.trim() !== '') {
                    // Parse time range (e.g., "8:00-12:00")
                    const timeRange = periodTime.split('-');
                    if (timeRange.length === 2) {
                        const startTime = timeToMinutes(timeRange[0].trim());
                        let endTime = timeToMinutes(timeRange[1].trim());
                        
                        // Handle midnight crossing
                        if (endTime === 0) {
                            return '00h';
                        }
                        
                        if (currentTime >= startTime && currentTime < endTime) {
                            const hours = Math.floor(endTime / 60);
                            const minutes = endTime % 60;
                            if (minutes === 0) {
                                return `${hours}h`;
                            } else {
                                return `${hours}h${minutes.toString().padStart(2, '0')}`;
                            }
                        }
                    }
                }
            }
            return null;
        }
        
        function getNextOpenTimeFromPeriods(schedule, currentTime) {
            // Get time periods from CSV format
            const periods = [schedule.period1, schedule.period2, schedule.period3];
            
            // Find the next opening time
            for (const periodTime of periods) {
                if (periodTime && periodTime.trim() && periodTime.trim() !== '') {
                    // Parse time range (e.g., "8:00-12:00")
                    const timeRange = periodTime.split('-');
                    if (timeRange.length === 2) {
                        const startTime = timeToMinutes(timeRange[0].trim());
                        const endTime = timeToMinutes(timeRange[1].trim());
                        
                        // If current time is before this period starts
                        if (currentTime < startTime) {
                            const hours = Math.floor(startTime / 60);
                            const minutes = startTime % 60;
                            if (minutes === 0) {
                                return `${hours}h`;
                            } else {
                                return `${hours}h${minutes.toString().padStart(2, '0')}`;
                            }
                        }
                    }
                }
            }
            return null;
        }

        async function openHoursModal() {
            console.log('Opening hours modal...');
            const modal = document.getElementById('hours-modal');
            const content = document.getElementById('hours-content');
            
            // Show loading state
            content.innerHTML = '<p style="color: var(--cor-texto)">Carregando horários...</p>';
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            try {
                // Fetch CSV data directly
                const response = await fetch(HOURS_CSV_URL);
                const csvText = await response.text();
                
                console.log('CSV loaded successfully:', csvText.substring(0, 200));
                
                // Parse CSV manually
                const lines = csvText.trim().split('\n');
                
                // Extract timezone from first line
                let timezone = 'America/Sao_Paulo'; // Default timezone
                if (lines[0] && lines[0].includes('Time Zone')) {
                    const timezoneLine = lines[0].split(',');
                    if (timezoneLine.length > 1 && timezoneLine[1].trim()) {
                        timezone = timezoneLine[1].trim();
                    }
                }
                
                const headers = lines[1].split(','); // Use second line as headers
                
                let html = '';
                
                // Process each day (starting from line 2, skipping headers)
                for (let i = 2; i < lines.length; i++) {
                    const values = lines[i].split(',');
                    const dayName = values[0];
                    
                    if (!dayName || dayName.trim() === '') continue;
                    
                    html += `
                        <div class="border-b pb-2 last:border-b-0" style="border-color: var(--cor-borda)">
                            <h3 class="font-semibold mb-1 capitalize" style="color: var(--cor-texto)">${dayName}</h3>
                            <div class="space-y-0.5 text-sm" style="color: var(--cor-texto)">
                    `;
                    
                    let hasAnyPeriod = false;
                    
                    // Get current day for status indicator using timezone
                     const today = new Date();
                     const timezoneToday = new Date(today.toLocaleString("en-US", {timeZone: timezone}));
                     const currentDayIndex = timezoneToday.getDay(); // 0 = Sunday, 1 = Monday, etc.
                     const dayNames = ['Domingo', 'Segunda-Feira', 'Terça-Feira', 'Quarta-Feira', 'Quinta-Feira', 'Sexta-Feira', 'Sábado'];
                     const isToday = dayNames[currentDayIndex].toLowerCase() === dayName.toLowerCase();
                     
                     // Check each period (columns 1, 2, 3 for Período 1, 2, 3)
                     const periods = [];
                     for (let j = 1; j <= 3; j++) {
                         const periodTime = values[j];
                         if (periodTime && periodTime.trim() !== '') {
                             periods.push(periodTime.trim());
                         }
                     }
                     
                     if (periods.length > 0) {
                         hasAnyPeriod = true;
                         const periodsText = periods.join(' • ');
                         
                         // For today, check if currently open using the same logic as updateOperatingHours
                         let statusColor = 'var(--cor-sucesso)';
                         if (isToday) {
                             const currentTime = timezoneToday.getHours() * 60 + timezoneToday.getMinutes();
                             const todaySchedule = {
                                 period1: values[1],
                                 period2: values[2],
                                 period3: values[3]
                             };
                             const isCurrentlyOpen = checkIfOpenFromPeriods(todaySchedule, currentTime);
                             statusColor = isCurrentlyOpen ? 'var(--cor-sucesso)' : 'var(--cor-erro)';
                         }
                         
                         html += `<div class="flex justify-between items-center">
                                     <span>${periodsText}</span>
                                     ${isToday ? `<span class="w-2 h-2 rounded-full ml-2" style="background-color: ${statusColor}"></span>` : ''}
                                 </div>`;
                     }
                    
                    if (!hasAnyPeriod) {
                         html += `<div class="flex justify-between items-center">
                                     <span style="color: var(--cor-texto-secundario)">Fechado</span>
                                     ${isToday ? '<span class="w-2 h-2 rounded-full ml-2" style="background-color: var(--cor-erro)"></span>' : ''}
                                 </div>`;
                     }
                    
                    html += `</div></div>`;
                }
                
                content.innerHTML = html;
                
            } catch (error) {
                console.error('Error loading hours:', error);
                content.innerHTML = '<p style="color: var(--cor-erro)">Erro ao carregar horários. Tente novamente.</p>';
            }
        }

        function closeHoursModal() {
            const modal = document.getElementById('hours-modal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
        }

        // Update hours every minute
        setInterval(updateOperatingHours, 60000);

        // ===== FUNÇÕES QR CODE =====
        
        // Variável global para armazenar o QR Code gerado
        let generatedQRCode = null;
        
        /**
         * Habilita o botão de download após QR Code estar pronto
         */
        function enableDownloadButton() {
            const downloadButton = document.getElementById('download-qr-button');
            if (downloadButton) {
                downloadButton.disabled = false;
                downloadButton.textContent = '💾 Baixar QR Code PNG';
                downloadButton.style.background = 'linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))';
                downloadButton.style.color = 'white';
                downloadButton.style.cursor = 'pointer';
                downloadButton.onmouseover = function() {
                    this.style.background = 'linear-gradient(135deg, var(--cor-secundaria), var(--cor-terciaria))';
                };
                downloadButton.onmouseout = function() {
                    this.style.background = 'linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))';
                };
            }
        }
        
        /**
         * Desabilita o botão de download
         */
        function disableDownloadButton() {
            const downloadButton = document.getElementById('download-qr-button');
            if (downloadButton) {
                downloadButton.disabled = true;
                downloadButton.textContent = '⏳ Aguarde o QR Code...';
                downloadButton.style.background = 'linear-gradient(135deg, #ccc, #999)';
                downloadButton.style.color = '#666';
                downloadButton.style.cursor = 'not-allowed';
                downloadButton.onmouseover = null;
                downloadButton.onmouseout = null;
            }
        }
        
        /**
         * Abre o modal do QR Code e gera o código (versão simplificada)
         */
        async function openQRCodeModal() {
            const modal = document.getElementById('qrcode-modal');
            const qrcodeDisplay = document.getElementById('qrcode-display');
            const urlInput = document.getElementById('qrcode-url');
            const currentURL = window.location.href;
            
            // Configurar URL no input
            urlInput.value = currentURL;
            
            // Desabilitar botão de download inicialmente
            disableDownloadButton();
            
            // Mostrar modal
            modal.classList.remove('hidden');
            document.body.style.overflow = 'hidden';
            
            // Mostrar loading
            qrcodeDisplay.innerHTML = `
                <div style="text-align: center; padding: 40px; color: #666;">
                    <div style="font-size: 24px; margin-bottom: 10px;">⏳</div>
                    <p>Gerando QR Code...</p>
                </div>
            `;
            
            try {
                console.log('🌐 Gerando QR Code via API online...');
                
                // Usar sempre API online para simplicidade e confiabilidade
                const encodedURL = encodeURIComponent(currentURL);
                const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=${encodedURL}&format=png&margin=20&bgcolor=FFFFFF&color=000000`;
                
                // Armazenar URL da API para download direto
                window.currentQRCodeURL = qrApiUrl;
                
                // Criar imagem para exibição
                const img = document.createElement('img');
                img.src = qrApiUrl;
                img.alt = 'QR Code do Cardápio';
                img.style.width = '200px';
                img.style.height = '200px';
                img.style.border = '2px solid #ddd';
                img.style.borderRadius = '8px';
                img.style.display = 'block';
                img.style.margin = '0 auto';
                
                // Aguardar carregamento
                await new Promise((resolve, reject) => {
                    img.onload = () => {
                        console.log('✅ QR Code carregado via API!');
                        resolve();
                    };
                    img.onerror = () => {
                        console.error('❌ Erro ao carregar QR Code');
                        reject(new Error('Falha ao carregar QR Code'));
                    };
                    
                    // Timeout de 15 segundos
                    setTimeout(() => {
                        reject(new Error('Timeout ao carregar QR Code'));
                    }, 15000);
                });
                
                // Limpar e mostrar QR Code
                qrcodeDisplay.innerHTML = '';
                qrcodeDisplay.appendChild(img);
                
                // Habilitar botão de download
                enableDownloadButton();
                
                console.log('✅ QR Code gerado e pronto para download!');
                console.log('🔗 URL da API:', qrApiUrl);
                
            } catch (error) {
                console.error('❌ Erro ao gerar QR Code:', error);
                
                // Manter botão desabilitado
                disableDownloadButton();
                
                // Mostrar erro com fallback
                qrcodeDisplay.innerHTML = `
                    <div style="color: #e74c3c; font-size: 14px; text-align: center; padding: 20px;">
                        <p style="margin-bottom: 10px;">❌ Erro ao gerar QR Code</p>
                        <p style="font-size: 12px; opacity: 0.8; margin-bottom: 15px;">Verifique sua conexão com a internet</p>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 6px; word-break: break-all; font-size: 11px; color: #333;">
                            ${currentURL}
                        </div>
                        <p style="font-size: 11px; margin-top: 10px; opacity: 0.6;">Copie o link acima para acessar o cardápio</p>
                    </div>
                `;
            }
        }
        
        /**
         * Fecha o modal do QR Code
         */
        function closeQRCodeModal() {
            console.log('🔗 Fechando modal QR Code...');
            
            const modal = document.getElementById('qrcode-modal');
            modal.classList.add('hidden');
            document.body.style.overflow = '';
            
            // Limpar QR Code gerado
            generatedQRCode = null;
        }
        
        /**
         * Copia a URL do cardápio para a área de transferência
         */
        async function copyQRCodeURL(event) {
            const urlInput = document.getElementById('qrcode-url');
            const url = urlInput.value;
            
            try {
                await navigator.clipboard.writeText(url);
                
                // Feedback visual
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '✅ Copiado!';
                button.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = 'linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))';
                }, 2000);
                
                console.log('✅ URL copiada para área de transferência');
                
            } catch (error) {
                console.error('❌ Erro ao copiar URL:', error);
                
                // Fallback para navegadores mais antigos
                urlInput.select();
                urlInput.setSelectionRange(0, 99999);
                document.execCommand('copy');
                
                // Feedback visual
                const button = event.target;
                const originalText = button.textContent;
                button.textContent = '✅ Copiado!';
                button.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = 'linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))';
                }, 2000);
            }
        }
        
        /**
         * Faz download do QR Code (versão simplificada)
         */
        function downloadQRCode(event) {
            const button = event.target;
            
            // Verificar se o botão está habilitado
            if (button.disabled) {
                console.log('⚠️ Botão ainda desabilitado');
                return;
            }
            
            const originalText = button.textContent;
            
            try {
                // Feedback visual
                button.textContent = '💾 Baixando...';
                button.style.background = 'linear-gradient(135deg, #f39c12, #e67e22)';
                
                // Verificar se temos a URL da API
                if (!window.currentQRCodeURL) {
                    throw new Error('URL do QR Code não encontrada');
                }
                
                // Método 1: Download direto via link
                const filename = 'qrcode-cardapio.png';
                
                // Método mais robusto para forçar download
                try {
                    // Tentar fetch para forçar download
                    fetch(window.currentQRCodeURL)
                        .then(response => response.blob())
                        .then(blob => {
                            // Criar URL do blob
                            const blobUrl = window.URL.createObjectURL(blob);
                            
                            // Criar link para download
                            const link = document.createElement('a');
                            link.href = blobUrl;
                            link.download = filename;
                            link.style.display = 'none';
                            
                            // Adicionar, clicar e remover
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            
                            // Limpar URL do blob após delay
                            setTimeout(() => {
                                window.URL.revokeObjectURL(blobUrl);
                            }, 1000);
                        })
                        .catch(() => {
                            // Fallback: método tradicional
                            const link = document.createElement('a');
                            link.href = window.currentQRCodeURL;
                            link.download = filename;
                            link.style.display = 'none';
                            
                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                        });
                } catch (fetchError) {
                    // Fallback final: método simples
                    const link = document.createElement('a');
                    link.href = window.currentQRCodeURL;
                    link.download = filename;
                    link.style.display = 'none';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                
                // Feedback de sucesso
                button.textContent = '✅ Baixado!';
                button.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = 'linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))';
                }, 2000);
                
                console.log('✅ Download iniciado!');
                console.log('📁 Arquivo:', filename);
                console.log('🔗 URL:', window.currentQRCodeURL);
                
            } catch (error) {
                console.error('❌ Erro ao baixar QR Code:', error);
                
                // Feedback visual de erro
                button.textContent = '❌ Erro no download';
                button.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
                
                setTimeout(() => {
                    button.textContent = originalText;
                    button.style.background = 'linear-gradient(135deg, var(--cor-primaria), var(--cor-secundaria))';
                }, 2000);
            }
        }

        // ===== SISTEMA DE MESA VIA URL =====
        
        function getURLParameter(param) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(param);
        }

        function getMesaFromURL() {
            const mesa = getURLParameter('mesa');
            if (mesa && mesa.trim()) {
                console.log('🪑 Mesa detectada na URL:', mesa);
                return mesa.trim();
            }
            return null;
        }

        function preencheMesaAutomatica() {
            const mesaURL = getMesaFromURL();
            const campoMesa = document.getElementById('table-number');
            
            if (mesaURL && campoMesa) {
                campoMesa.value = mesaURL;
                
                // Focar no campo para habilitar o botão continuar
                campoMesa.focus();
                campoMesa.blur(); // Simular saída do foco para disparar validação
                
                campoMesa.style.background = 'linear-gradient(135deg, #e8f5e9, #f1f8e9)';
                campoMesa.style.borderColor = 'var(--cor-sucesso)';
                
                const parent = campoMesa.parentNode;
                const successIcon = document.createElement('div');
                successIcon.className = 'mesa-auto-success';
                successIcon.innerHTML = '<div style="display: flex; align-items: center; margin-top: 4px; color: var(--cor-sucesso); font-size: 12px;"><svg style="width: 14px; height: 14px; margin-right: 4px;" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Mesa preenchida automaticamente</div>';
                parent.appendChild(successIcon);
                
                setTimeout(() => {
                    campoMesa.style.background = '';
                    campoMesa.style.borderColor = '';
                    const successEl = parent.querySelector('.mesa-auto-success');
                    if (successEl) successEl.remove();
                }, 3000);
                
                console.log('✅ Campo mesa preenchido automaticamente:', mesaURL);
                return true;
            }
            return false;
        }

        function mostrarIndicadorMesaURL() {
            const mesaURL = getMesaFromURL();
            if (mesaURL) {
                showToastMesa(mesaURL);
            }
        }

        function showToastMesa(numeroMesa) {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => {
                toast.classList.add('toast-exit');
                setTimeout(() => toast.remove(), 300);
            });
            
            const toastDiv = document.createElement('div');
            toastDiv.className = 'toast toast-success';
            toastDiv.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="font-semibold text-sm text-white">Mesa ${numeroMesa} detectada</div>
                    <button onclick="this.parentElement.parentElement.classList.add('toast-exit'); setTimeout(() => this.parentElement.parentElement.remove(), 300)" class="text-white/80 hover:text-white ml-4 flex-shrink-0">
                        <span class="text-lg">×</span>
                    </button>
                </div>
            `;
            
            document.body.appendChild(toastDiv);
            
            // Auto remove
            setTimeout(() => {
                if (toastDiv.parentNode) {
                    toastDiv.classList.add('toast-exit');
                    setTimeout(() => toastDiv.remove(), 300);
                }
            }, 3500);
        }

        // ===== AUTOMAÇÃO MESA URL - CHECKOUT DIRETO =====
        function autoMesaCheckout() {
            const mesaURL = getMesaFromURL();
            if (!mesaURL) return false;
            
            console.log('🪑 Automação Mesa URL ativada:', mesaURL);
            
            // 1. Ocultar todas as opções de entrega
            const deliveryOptions = document.getElementById('delivery-options');
            if (deliveryOptions) {
                const allOptions = deliveryOptions.querySelectorAll('label');
                allOptions.forEach(option => {
                    option.style.display = 'none';
                });
            }
            
            // 2. Mostrar apenas a opção "Consumo no Local"
            const localOption = deliveryOptions?.querySelector('input[value="local"]')?.closest('label');
            if (localOption) {
                localOption.style.display = 'flex';
                
                // 3. Selecionar automaticamente "Consumo no Local"
                const localRadio = localOption.querySelector('input[value="local"]');
                if (localRadio) {
                    localRadio.checked = true;
                    localRadio.dispatchEvent(new Event('change'));
                    console.log('✅ "Consumo no Local" selecionado automaticamente');
                }
            }
            
            // 4. Aguardar um pouco para os campos aparecerem
            setTimeout(() => {
                // 5. Preencher campo da mesa
                const campoMesa = document.getElementById('table-number');
                if (campoMesa) {
                    campoMesa.value = mesaURL;
                    
                    // 6. Focar no campo (cursor piscando + teclado mobile)
                    campoMesa.focus();
                    
                    // 7. Disparar eventos para validação
                    campoMesa.dispatchEvent(new Event('input'));
                    campoMesa.dispatchEvent(new Event('change'));
                    
                    console.log('✅ Campo mesa preenchido e focado:', mesaURL);
                }
            }, 100);
            
            return true;
        }

        // Toast da mesa será mostrado após o carregamento completo do cardápio

    </script>
</body>
</html>